#include "EMV_appmain.h"
#include "emv_cl.h"
#include <ctos_clapi.h>
#include "wub_lib.h"
#include "ScreenDispaly.h"
#include "Transaction.h"
#include "debug.h"
#include <time.h> 

extern USHORT CTOS_FunRedirectSetDevice(USHORT usDeviceID, ULONG ulPara);


//#include "bertlv.h"
#define _SIMULATE_ONLINE_RESULT

#define d_START_TRANS	0x00
#define d_INIT_TRANS	0x01

USHORT usTxResult;
char baInput[20];
int iLen;

STR sBuf[1024];
BYTE baTmp[5000];
BYTE baBuf[128];
BYTE baTemp[256];
BYTE baTemp2[256];
BYTE baTmp1[256];

EMVCL_ACT_DATA stACTData;
EMVCL_RC_DATA_EX stRCDataEx;
EMVCL_RC_DATA_ANALYZE stRCDataAnalyze;

int iBatchNo;

#define d_TLV_DATA_BUF_SIZE		1024
USHORT TLVDataLen;
BYTE TLVData[d_TLV_DATA_BUF_SIZE];

BYTE g_baInputCBAmt[20];
USHORT g_usCBAmtLen;
BYTE g_baInputAmt[20];
USHORT g_usAmtLen;
BYTE g_bTxntype;
ULONG ulAmt;
ULONG ulCBAmt;
BOOL g_isForcedOnl;

const BYTE baLCDLogo[]={ //Width=128, Height=142
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0xC0,0xE0,0xE0,0xE0,0xE0,0x38,0x38,0x38,0x38,0x38,0x18,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x18,0x38,0x38,0x38,0x38,0x38,0xE0,0xE0,0xE0,0xE0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0xC0,0xC0,0x70,0x70,0x38,0x38,0x0E,0x0E,0x0E,0x07,0x07,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x07,0x07,0x07,0x0E,0x0E,0x38,0x38,0x78,0x70,0xF0,0xC0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xE0,0xF0,0x70,0x1C,0x1E,0x0E,0x03,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x03,0x03,0x0E,0x1E,0x1C,0x70,0xF0,0xE0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xE0,0x38,0x1C,0x07,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xFC,0xFC,0xFC,0xFC,0xF8,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x1F,0x3C,0xF8,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xC0,0xF8,0x3C,0x1F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xFC,0xFC,0xFC,0xFC,0xF8,0xE0,0x00,0x00,0x00,0x00,0x03,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFC,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xE0,0xF8,0xF8,0x38,0xF8,0xF8,0xF8,0xE0,0xE0,0xE0,0xE0,0xE0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,0x00,0x03,0x1F,0x3C,0xF8,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0xC0,0xF8,0x3F,0x07,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xFE,0xFE,0xFE,0xF8,0xF0,0xC0,0x00,0x00,0x00,0x00,0x07,0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0xF8,0x80,0x00,0x00,0x00,0x00,0x07,0x7F,0xFF,0xFF,0xFF,0xFF,0xFE,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xFF,0xFF,0x07,0x00,0x00,0x00,0x00,0x80,0x80,0x81,0x81,0x81,0x81,0x01,0x07,0x07,0x07,0x07,0x0F,0x0F,0xFF,0xFE,0xF8,0x80,0x87,0xBF,0xF8,0xC0,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x80,0xFC,0x7F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFE,0xFE,0xFE,0xFC,0xF0,0xE0,0x00,0x00,0x00,0x01,0x0F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFE,0xE0,0x00,0x00,0x00,0x00,0x01,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x00,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFF,0x7F,0x01,0x00,0x00,0xF0,0xFC,0xFE,0x1F,0x0F,0x0F,0x0F,0x0F,0x1F,0x1E,0x7C,0xFC,0xF0,0xE0,0xE0,0xFC,0xFF,0x7F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0E,0x1E,0x1E,0x7C,0xFC,0xF0,0xE0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xE0,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xE0,0xC0,0xC0,0xC0,0xC3,0x1F,0x3F,0xFC,0xF8,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x07,0x1F,0x1F,0x3C,0xFC,0xF8,0xE0,0xE0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x1F,0xFF,0xFC,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x07,0x07,0x07,0x07,0x1F,0x1F,0x1F,0xFF,0xFF,0xFF,0xFC,0xF8,0xF8,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x07,0x1F,0x1F,0x3C,0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x1F,0xFF,0xFC,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x07,0x7F,0xF8,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x07,0x00,0x00,0x00,0x80,0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x3F,0x7F,0xF8,0xF0,0xC0,0x81,0x87,0x0F,0x3F,0x7E,0xF8,0xF0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x0F,0x7F,0xFE,0xF0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x0F,0x7F,0xF0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x03,0x03,0x03,0x01,0x00,0x00,0x00,0x00,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x03,0x00,0x00,0x00,0x00,0xE0,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0x0F,0x00,0x00,0x00,0x00,0x00,0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xFD,0xFF,0x1F,0x1F,0x1F,0x7E,0x7C,0xF0,0xE1,0xE3,0xE3,0xEF,0xFE,0xFC,0xF0,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x0F,0x1F,0xFE,0xFC,0xE0,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x03,0x07,0x3F,0xF8,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0xF8,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x07,0x00,0x00,0x00,0x00,0x00,0xE0,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x1F,0x1F,0x3C,0x3C,0xF8,0xF8,0xE0,0xE0,0xE3,0xC3,0xC3,0xC3,0xC3,0xC7,0xFF,0xFF,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x1F,0xFF,0xFC,0xE0,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x1C,0x38,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xE0,0xFB,0x3F,0x1F,0x07,0x07,0x07,0x03,0x03,0x03,0x07,0x1F,0x3F,0xFC,0xE0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x03,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x07,0x0F,0x3E,0x38,0x70,0xF0,0xC0,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x07,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0xC0,0xF0,0x70,0x38,0x3E,0x0E,0x07,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x07,0x07,0x0F,0x0F,0x0E,0x3E,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x03,0x03,0x0E,0x0E,0x1C,0x1C,0x70,0x70,0xE0,0xE0,0xE0,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0xE0,0xE0,0x70,0x70,0x7C,0x1C,0x1E,0x0E,0x0F,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x07,0x07,0x07,0x1C,0x1C,0x1C,0x1C,0x38,0x38,0x38,0x38,0x38,0x38,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0x20,0x38,0x38,0x38,0x38,0x38,0x1C,0x1C,0x1C,0x1C,0x04,0x07,0x07,0x07,0x03,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};


//------------------------------------------------------------------------------

void UnpackData(BYTE *baSBuf, UINT uiLen, BYTE *baTBuf) {
    UINT i;
    char cMe[3];

    strcpy(baTBuf, "");
    for (i = 0; i < uiLen; i++) {
        sprintf(cMe, "%02X", baSBuf[i]);
        strcat(baTBuf, cMe);
    }
}
//------------------------------------------------------------------------------

void ShowReverseLine(BYTE x, BYTE y, char *str) {
    CTOS_LCDTSetReverse(d_TRUE);
    CTOS_LCDTPrintXY(x, y, (STR *) str);
    CTOS_LCDTSetReverse(d_FALSE);
}
//------------------------------------------------------------------------------

ULONG ASCII2Int(BYTE *baSBuf, int iL) {
    unsigned long k;
    unsigned long iN;
    int i;

    iN = 0;
    k = 1;
    for (i = iL - 1; i >= 0; i--) {
        iN = (unsigned long) ((baSBuf[i] - '0') * k) + iN;
        k *= 10;
    }
    return iN;
}
//------------------------------------------------------------------------------

ULONG InputAmount(BYTE* strAmt, USHORT AmtBufSize, USHORT* usAmtLen) {
    int iX;
    int iY;
    BYTE bKey;
    USHORT tempLen = 0;
    memset(strAmt, '0', AmtBufSize);

    *usAmtLen = 0;
    iX = 1;
    iY = 5;

    while (1) {
//        CTOS_KBDGet(&bKey);
        ForceMainDevice_KBDGet(&bKey);

        switch (bKey) {
            case d_KBD_ENTER: //Enter
                if (tempLen < 1) {
                    CTOS_Delay(100);
                    CTOS_Beep();
                    CTOS_Delay(100);
                    CTOS_Beep();
                } else {
                    if (tempLen == 1 && baInput[0] == '0') {
                        CTOS_Delay(100);
                        CTOS_Beep();
                        CTOS_Delay(100);
                        CTOS_Beep();
                        iX--;
                        TopRelative_LCDTPutchXY(iX, iY, ' ');
                        tempLen--;
                    } else {
                        strAmt[tempLen] = 0;
                        *usAmtLen = tempLen;
                        return d_OK;
                    }
                }
                break;
            case d_KBD_CANCEL: //Cancel
                tempLen = 1;
                strAmt[0] = '0';
                *usAmtLen = tempLen;
                return d_NO;

            case d_KBD_CLEAR: //Clear
                if (tempLen == 0) {
                    CTOS_Delay(100);
                    CTOS_Beep();
                    CTOS_Delay(100);
                    CTOS_Beep();
                } else {
                    iX--;
                    TopRelative_LCDTPutchXY(iX, iY, ' ');
                    tempLen--;
                }
                break;
            default:
                if ((bKey >= '0' && bKey <= '9') && tempLen < 7) {
                    TopRelative_LCDTPutchXY(iX, iY, bKey);
                    iX++;
                    strAmt[tempLen++] = bKey;
                } else {
                    CTOS_Delay(100);
                    CTOS_Beep();
                    CTOS_Delay(100);
                    CTOS_Beep();
                }
        }

    }
}
//------------------------------------------------------------------------------

ULONG InputAmount2(BYTE* strAmt, USHORT AmtBufSize, USHORT* usAmtLen) {
    int iX;
    int iY;
    BYTE bKey;
    USHORT tempLen = 0;
	BYTE bAmt_Dec[3] = {0};
    memset(strAmt, 0x00, AmtBufSize);

    *usAmtLen = 0;
    iX = 17;
    iY = 9;

    while (1) {
        CTOS_KBDGet(&bKey);

        switch (bKey) {
            case d_KBD_ENTER: //Enter
                if (tempLen < 1) {
                    CTOS_Delay(100);
                    CTOS_Beep();
                    CTOS_Delay(100);
                    CTOS_Beep();
                } else {
                    if (tempLen == 1 && baInput[0] == '0') {
                        CTOS_Delay(100);
                        CTOS_Beep();
                        CTOS_Delay(100);
                        CTOS_Beep();
                        iX--;
                        //TopRelative_LCDTPutchXY(iX, iY, ' ');
                        tempLen--;
                    } else {
                        strAmt[tempLen] = 0;
                        *usAmtLen = tempLen;
                        return d_OK;
                    }
                }
                break;
            case d_KBD_CANCEL: //Cancel
                tempLen = 1;
                strAmt[0] = '0';
                *usAmtLen = tempLen;
                return d_NO;

            case d_KBD_CLEAR: //Clear
                if (tempLen == 0) {
                    CTOS_Delay(100);
                    CTOS_Beep();
                    CTOS_Delay(100);
                    CTOS_Beep();
                } else {
                    iX--;
                    //TopRelative_LCDTPutchXY(iX, iY, ' ');
					strAmt[--tempLen] = 0x00;
					//tempLen--;
					//CTOS_LCDTPrintXY(1, 9, "   $                ");
					//CTOS_LCDTPrintXY((19 - tempLen), 9, strAmt);
					
					//CTOS_LCDTPrintXY(1, 9, "   $          0.00  ");
					if(Dollar_Sign == 1)
						CTOS_LCDTPrintXY(1, 9, "   $          0.00  ");
					else if(Dollar_Sign == 2)
						CTOS_LCDTPrintXY(1, 9, "   €         0.00  ");
					if(tempLen < 3){
						if(Dollar_Sign == 1)
							CTOS_LCDTPrintXY((19 - tempLen), 9, strAmt);
						else if(Dollar_Sign == 2)
							CTOS_LCDTPrintXY((18 - tempLen), 9, strAmt);
						//CTOS_LCDTPrintXY((19 - tempLen), 9, strAmt);
					}else{
						bAmt_Dec[0] = strAmt[tempLen-2];
						bAmt_Dec[1] = strAmt[tempLen-1];
						//CTOS_LCDTPrintXY((19 - tempLen - 1), 9, strAmt);
						//CTOS_LCDTPrintXY(16, 9, ".");
						//CTOS_LCDTPrintXY(17, 9, bAmt_Dec);
						if(Dollar_Sign == 1){
							CTOS_LCDTPrintXY((19 - tempLen - 1), 9, strAmt);
							CTOS_LCDTPrintXY(16, 9, ".");
							CTOS_LCDTPrintXY(17, 9, bAmt_Dec);
						}
						else if(Dollar_Sign == 2){
							CTOS_LCDTPrintXY((18 - tempLen - 1), 9, strAmt);
							CTOS_LCDTPrintXY(15, 9, ".");
							CTOS_LCDTPrintXY(16, 9, bAmt_Dec);
						}
					}
                }
                break;
            default:
				if(bKey == '0' && tempLen == 0){
					CTOS_Delay(100);
                    CTOS_Beep();
                    CTOS_Delay(100);
                    CTOS_Beep();
				}
                else if ((bKey >= '0' && bKey <= '9') && tempLen < 7) {
                    //TopRelative_LCDTPutchXY(iX, iY, bKey);
                    iX++;
                    strAmt[tempLen++] = bKey;
					if(Dollar_Sign == 1)
						CTOS_LCDTPrintXY(1, 9, "   $          0.00  ");
					else if(Dollar_Sign == 2)
						CTOS_LCDTPrintXY(1, 9, "   €         0.00  ");
					//CTOS_LCDTPrintXY(1, 9, "   $          0.00  ");
					//CTOS_LCDTPrintXY((19 - tempLen), 9, strAmt);
					if(tempLen <= 2){
						if(Dollar_Sign == 1)
							CTOS_LCDTPrintXY((19 - tempLen), 9, strAmt);
						else if(Dollar_Sign == 2)
							CTOS_LCDTPrintXY((18 - tempLen), 9, strAmt);
						//CTOS_LCDTPrintXY((19 - tempLen), 9, strAmt);
					}else{
						//memcpy(bAmt_Dec, strAmt[tempLen-2]);
						bAmt_Dec[0] = strAmt[tempLen-2];
						bAmt_Dec[1] = strAmt[tempLen-1];
						//CTOS_LCDTPrintXY((19 - tempLen - 1), 9, strAmt);
						//CTOS_LCDTPrintXY(16, 9, ".");
						//CTOS_LCDTPrintXY(17, 9, bAmt_Dec);
						if(Dollar_Sign == 1){
							CTOS_LCDTPrintXY((19 - tempLen - 1), 9, strAmt);
							CTOS_LCDTPrintXY(16, 9, ".");
							CTOS_LCDTPrintXY(17, 9, bAmt_Dec);
						}
						else if(Dollar_Sign == 2){
							CTOS_LCDTPrintXY((18 - tempLen - 1), 9, strAmt);
							CTOS_LCDTPrintXY(15, 9, ".");
							CTOS_LCDTPrintXY(16, 9, bAmt_Dec);
						}
					}
                } else {
                    CTOS_Delay(100);
                    CTOS_Beep();
                    CTOS_Delay(100);
                    CTOS_Beep();
                }
        }

    }
}
//------------------------------------------------------------------------------

ULONG InputValue(void) {
    ULONG ulRtn;

    ulRtn = 0;

    memset(g_baInputCBAmt, 0, sizeof (g_baInputCBAmt));
    memset(g_baInputAmt, 0, sizeof (g_baInputAmt));
    g_usCBAmtLen = 0;
    g_usAmtLen = 0;

    //PageShow(d_PAGE_TRANSACTION_INPUT_AMOUNT);
    
    ulRtn = InputAmount2(g_baInputAmt, sizeof (g_baInputAmt), &g_usAmtLen);
    if (ulRtn != d_OK) {
        return ulRtn;
    }

    if (g_bTxntype == 0x09) //Cash Back
    {
        PageShow(d_PAGE_TRANSACTION_INPUT_CB_AMOUNT);
        ulRtn = InputAmount(g_baInputCBAmt, sizeof (g_baInputCBAmt), &g_usCBAmtLen);
        return ulRtn;
    }

    return ulRtn;
}
//------------------------------------------------------------------------------

//USHORT CTOS_PrinterPutString(STR* baBuf) ;
//------------------------------------------------------------------------------

void PrintBlank(void) {
    CTOS_PrinterPutString("\n");
    CTOS_PrinterPutString("\n");
}
//------------------------------------------------------------------------------
#if 1

void Print_Receipt(EMVCL_RC_DATA_EX *data, BYTE isNeedSignature, ULONG ulValue) {
    //------------------------------------------------------
    //    PrintBlank();

    if (data->bSID == d_VW_SID_PAYPASS_MAG_STRIPE || data->bSID == d_VW_SID_PAYPASS_MCHIP) {
        sprintf(baBuf, "           Master PayPass");
    } else if (data->bSID == d_VW_SID_AE_EMV || data->bSID == d_VW_SID_AE_MAG_STRIPE) {
        sprintf(baBuf, "           American Express");
    } else if (data->bSID == d_VW_SID_JCB_WAVE_2 || data->bSID == d_VW_SID_JCB_WAVE_QVSDC) {
        sprintf(baBuf, "           J/Speedy");
    } else if (data->bSID == d_VW_SID_VISA_OLD_US || data->bSID == d_VW_SID_VISA_WAVE_2 || data->bSID == d_VW_SID_VISA_WAVE_QVSDC || data->bSID == d_VW_SID_VISA_WAVE_MSD) {
        sprintf(baBuf, "           Visa payWave");
    } else if (data->bSID == d_VW_DISCOVER) {
        sprintf(baBuf, "           Discover Zip");
    } else {
        sprintf(baBuf, "           Un-Know");
      
    }
        CTOS_PrinterPutString(baBuf);

    PrintBlank();

    sprintf(baBuf, "Credit Card");
    CTOS_PrinterPutString(baBuf);

    //Store ID
    sprintf(baBuf, "Store ID    :      8220101400255");
    CTOS_PrinterPutString(baBuf);

    //Terminal ID
    sprintf(baBuf, "Terminal ID :           01401493");
    CTOS_PrinterPutString(baBuf);
    CTOS_PrinterPutString("================================");

    //Card Type
    if (data->bSID == d_VW_SID_PAYPASS_MAG_STRIPE || data->bSID == d_VW_SID_PAYPASS_MCHIP) {
        sprintf(baBuf, "Card Type  : MASTER");
    } else if (data->bSID == d_VW_SID_AE_EMV || data->bSID == d_VW_SID_AE_MAG_STRIPE) {
        sprintf(baBuf, "Card Type  : AEMX");
    } else if (data->bSID == d_VW_SID_JCB_WAVE_2 || data->bSID == d_VW_SID_JCB_WAVE_QVSDC) {
        sprintf(baBuf, "Card Type  : JCB");
    } else if (data->bSID == d_VW_SID_VISA_OLD_US || data->bSID == d_VW_SID_VISA_WAVE_2 || data->bSID == d_VW_SID_VISA_WAVE_QVSDC || data->bSID == d_VW_SID_VISA_WAVE_MSD) {
        sprintf(baBuf, "Card Type  : VISA");
    } else if (data->bSID == d_VW_DISCOVER) {
        sprintf(baBuf, "Card Type  : DISCOVER");
    } else {
        sprintf(baBuf, "Card Type  : UN-KMOW");
    }
    CTOS_PrinterPutString(baBuf);
    CTOS_PrinterPutString(" ");

    //Card Number
    if (data->bSID == d_VW_SID_VISA_OLD_US || data->bSID == d_VW_SID_VISA_WAVE_2 || data->bSID == d_VW_SID_VISA_WAVE_QVSDC || data->bSID == d_VW_SID_VISA_WAVE_MSD) {
        memset(baTemp, 0x00, sizeof (baTemp));
        memset(baTemp2, 0x00, sizeof (baTemp2));
        memcpy(baTemp, &data->baTrack2Data[1], 4);
        memcpy(baTemp2, &data->baTrack2Data[13], 4);


    } else {
        UnpackData(data->baTrack2Data, 20, baTmp);
        memcpy(baTemp, baTmp, 4);
        memcpy(baTemp2, &baTmp[12], 4);
        baTemp2[16] = 0;

    }

    sprintf(baBuf, "Card Number: %s XXXX XXXX %s", baTemp, baTemp2);
    CTOS_PrinterPutString(baBuf);
    CTOS_PrinterPutString(" ");

    //Exp Date
    if (data->bSID == d_VW_SID_VISA_OLD_US || data->bSID == d_VW_SID_VISA_WAVE_2 || data->bSID == d_VW_SID_VISA_WAVE_QVSDC || data->bSID == d_VW_SID_VISA_WAVE_MSD) {
        memcpy(baTemp, &data->baTrack2Data[20], 2);
         baTemp[2] = 0;
         memcpy(baTmp1, &data->baTrack2Data[18], 2);
         baTmp1[2] = 0;


    } else {
        memcpy(baTemp, baTmp + 19, 2);
         baTemp[2] = 0;
         memcpy(baTmp1, baTmp + 17, 2);
         baTmp1[2] = 0;

    }
    
    sprintf(baBuf, "Exp Date   : %s/'%s", baTemp, baTmp1);
    CTOS_PrinterPutString(baBuf);
    CTOS_PrinterPutString(" ");

    //Trans Type
    CTOS_PrinterPutString("Trans Type : SALE");
    CTOS_PrinterPutString(" ");

    //Date
    memcpy(baTemp, data->baDateTime, 4);
    baTemp[4] = 0;
    memcpy(baTmp, data->baDateTime + 4, 2);
    baTmp[2] = 0;
    memcpy(baTmp1, data->baDateTime + 6, 2);
    baTmp1[2] = 0;
    sprintf(baBuf, "Date       : %s/%s/%s", baTemp, baTmp, baTmp1);


    //Time
    memcpy(baTemp, data->baDateTime + 8, 2);
    baTemp[2] = 0;
    memcpy(baTmp, data->baDateTime + 10, 2);
    baTmp[2] = 0;
    memcpy(baTmp1, data->baDateTime + 12, 2);
    baTmp1[2] = 0;
    sprintf(baBuf, "Time       : %s:%s:%s", baTemp, baTmp, baTmp1);
    //    DebugAddHEX("time:", baBuf, strlen(baBuf));
    //    CTOS_PrinterPutString(baBuf);
    //    CTOS_PrinterPutString(" ");

    //Auth Code
    memcpy(baTemp, data->baTrack2Data + 19, 2);
    baTemp[2] = 0;
    sprintf(baBuf, "Auth Code  : TT2738");
    CTOS_PrinterPutString(baBuf);
    CTOS_PrinterPutString(" ");

    //Batch No
    iBatchNo++;
    sprintf(baBuf, "Batch No   : %06d", iBatchNo);
    CTOS_PrinterPutString(baBuf);

    CTOS_PrinterPutString(" ");

    // AMOUNT
    sprintf(baBuf, "     AMOUNT:        $ %ld", ulValue);
    CTOS_PrinterPutString(baBuf);

    if (isNeedSignature) {
        sprintf(baBuf, "Signature  ");
        CTOS_PrinterPutString(baBuf);
        PrintBlank();
    }

    CTOS_PrinterPutString("================================");

    PrintBlank();
    PrintBlank();
}

static const BYTE baPrinterBufferLogo_Receipt2[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0xC0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF8,
    0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0x78, 0x78, 0x7C, 0x78, 0x78, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8,
    0xF8, 0xF0, 0xF0, 0xF0, 0xE0, 0xE0, 0xC0, 0xC0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0xF8, 0xFE, 0xFF, 0xFF, 0xFC, 0xF8,
    0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x80, 0x80,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0, 0xF8,
    0xF8, 0xFC, 0x7E, 0x3F, 0x1F, 0x1F, 0x0F, 0x07, 0x07, 0x87, 0x83, 0xC3, 0xC1, 0xE1, 0xE1, 0xE0,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0,
    0xE0, 0xE1, 0xC1, 0xC1, 0x83, 0x83, 0x07, 0x07, 0x0F, 0x1F, 0x1F, 0x3F, 0x7E, 0xFC, 0xFC, 0xF8,
    0xF0, 0xE0, 0xC0, 0x80, 0x80, 0xE0, 0xF8, 0xFE, 0xFF, 0xFF, 0x3F, 0x0F, 0x07, 0x03, 0x07, 0x1F,
    0x3F, 0xFF, 0xFF, 0xFC, 0xF0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0xF8, 0xFC,
    0xFE, 0xFF, 0xFF, 0x7F, 0x3F, 0x1F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x1F, 0x3F, 0x7F, 0xFF,
    0xFF, 0xFF, 0xFE, 0xFC, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xE0, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF8,
    0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0,
    0xF8, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x1F, 0x3F,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xF8, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x0F, 0x0F,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
    0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0x1F,
    0x1F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x1F, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xF8, 0xE0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xE0, 0xF8, 0xFC, 0xFF, 0x7F, 0x3F, 0x0F, 0x07, 0x03,
    0x01, 0xC0, 0xE0, 0xF0, 0xF8, 0xFC, 0xFE, 0x7E, 0x3F, 0x1F, 0x0F, 0x0F, 0x07, 0x07, 0x03, 0x83,
    0x83, 0xC1, 0xC1, 0xC1, 0xC1, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE1, 0xC1, 0xC1, 0xC1, 0x81, 0x83,
    0x03, 0x07, 0x07, 0x07, 0x0F, 0x1F, 0x3F, 0x7F, 0xFE, 0xFC, 0xF8, 0xF0, 0xE0, 0xC0, 0x81, 0x03,
    0xC7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x0F, 0x03, 0x00, 0x80, 0xE0, 0xF0, 0xF8, 0xE0, 0xC0,
    0x00, 0x00, 0x03, 0x07, 0x1F, 0x7F, 0xFF, 0xFE, 0xFC, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
    0x03, 0x03, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xC0, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x01, 0x00, 0x07, 0x3F, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFE, 0xF0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03,
    0x1F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFE, 0xFC, 0xF8, 0xF8, 0xF8, 0xF8, 0xF0, 0xF0, 0xF0, 0xE0,
    0xE1, 0xC1, 0xC1, 0x81, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFE,
    0xFC, 0xF8, 0xF8, 0xF8, 0xF8, 0xF0, 0xF0, 0xF0, 0xE0, 0xE0, 0xE1, 0xC1, 0x81, 0x81, 0x01, 0x01,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xC0, 0xF8, 0xFE, 0xFF, 0xFF, 0x3F, 0x07, 0x01, 0x00, 0x00, 0xE0, 0xF8, 0xFE,
    0xFF, 0xFF, 0x3F, 0x0F, 0x03, 0x01, 0x00, 0x80, 0xE0, 0xF0, 0xF8, 0xFC, 0xFE, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x7F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFE, 0xFE, 0xFC, 0xF8, 0xE0, 0xC0, 0x00, 0x01, 0x03, 0x0F, 0xDF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x1F, 0x0F, 0x03, 0x00, 0x80, 0xE0, 0xF8, 0xFC, 0xFF, 0xFF, 0x3F, 0x1F, 0x7F, 0xFF,
    0xFF, 0xFC, 0xF0, 0xE0, 0x80, 0x00, 0x01, 0x03, 0x0F, 0x1F, 0x7F, 0xFF, 0xFE, 0xF8, 0xE0, 0xC0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
    0xE0, 0xC0, 0xC0, 0xC0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xF0,
    0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF7, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF1, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC1, 0x01, 0x03, 0x03, 0x03, 0x07, 0x07, 0x07, 0x0F, 0x0F, 0x0F, 0x1F,
    0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x03,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC1, 0x01, 0x03,
    0x03, 0x03, 0x07, 0x07, 0x07, 0x0F, 0x0F, 0x0F, 0x1F, 0x1F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC,
    0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0xFF, 0xFF, 0xFF,
    0x0F, 0x00, 0x00, 0x00, 0x00, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xC1, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC1, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xFE, 0xFF, 0xFF, 0x7F, 0x1F, 0x07,
    0x01, 0x00, 0x80, 0xE0, 0xF8, 0xFE, 0xFF, 0x7F, 0x3F, 0x0F, 0x03, 0x00, 0x80, 0x80, 0x00, 0x00,
    0x03, 0x07, 0x1F, 0x7F, 0xFF, 0xFE, 0xFC, 0xF0, 0xC0, 0x80, 0x00, 0x01, 0x07, 0x1F, 0x3F, 0xFF,
    0xFF, 0xFC, 0xF0, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x3F, 0x7F,
    0xFF, 0xFF, 0xFF, 0xFC, 0xF8, 0xF0, 0xF0, 0xE0, 0xE0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF8, 0xFE, 0xFF,
    0xFF, 0xFF, 0x7F, 0x3F, 0x0F, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xFC, 0xFF, 0xFF,
    0xFF, 0xFF, 0x7F, 0x0F, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF8, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F,
    0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFE, 0xF8, 0xF0, 0xF0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xF0, 0xF0,
    0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x1F, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
    0xF0, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
    0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFE, 0xFC,
    0xF0, 0xF0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF8, 0xFE, 0xFF, 0xFF, 0xFF, 0x7F, 0x1F,
    0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0x00, 0x00, 0x00, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF,
    0xE0, 0x00, 0x00, 0x00, 0x00, 0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x1F, 0x07, 0x01, 0x00, 0x80, 0xE0,
    0xF8, 0xFE, 0xFF, 0x7F, 0x1F, 0x07, 0x03, 0x00, 0x00, 0xE0, 0xF8, 0xFE, 0xFF, 0xFF, 0xFE, 0xF8,
    0xF0, 0xC0, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x3F, 0x7F, 0xFF, 0xFE, 0xF8, 0xF0, 0xC0, 0x00, 0x00,
    0x03, 0x07, 0x1F, 0x7F, 0xFF, 0xFE, 0xFC, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x01, 0x01, 0x03, 0x03, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x03, 0x03, 0x03,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x03, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x03, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x03, 0x1F, 0xFF, 0xFF, 0xFF, 0xFC, 0xE0, 0x80, 0x00, 0x00, 0x07, 0x1F, 0x7F,
    0xFF, 0xFF, 0xF8, 0xF0, 0xC0, 0x80, 0x00, 0x03, 0x07, 0x1F, 0x3F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 0x1F, 0x0F, 0x03, 0x00, 0x00, 0xC0, 0xE0, 0xF8, 0xFE, 0xFF, 0x3F,
    0x1F, 0x07, 0x01, 0x00, 0x00, 0xC0, 0xF0, 0xFE, 0xFF, 0xFF, 0x3F, 0x0F, 0x03, 0x01, 0x07, 0x0F,
    0x3F, 0x7F, 0xFF, 0xFE, 0xF8, 0xE0, 0xC0, 0x00, 0x00, 0x01, 0x07, 0x0F, 0x3F, 0xFF, 0xFF, 0xFE,
    0xF8, 0xE0, 0x80, 0x00, 0x00, 0x03, 0x0F, 0x1F, 0x7F, 0xFF, 0xFE, 0xF8, 0xF0, 0xC0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
    0xF0, 0xE0, 0xE0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0,
    0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF0,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xF0, 0xF0, 0xF0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0,
    0xE0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xE0,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0xE0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x70, 0xF0, 0xF0, 0xF0, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xF0, 0xF0,
    0xF0, 0xF0, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x1F, 0x7F, 0xFF, 0xFE, 0xFC, 0xF0, 0xE0, 0xC0,
    0x80, 0x03, 0x07, 0x0F, 0x1F, 0x3F, 0x3F, 0x7E, 0xFC, 0xF8, 0xF0, 0xF0, 0xE0, 0xE0, 0xC1, 0xC1,
    0x83, 0x83, 0x83, 0x83, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x83, 0x83, 0x83, 0xC1,
    0xC1, 0xC0, 0xE0, 0xE0, 0xF0, 0xF8, 0xF8, 0x7C, 0x7E, 0x3F, 0x1F, 0x0F, 0x03, 0x01, 0x00, 0xC0,
    0xE0, 0xF0, 0xF8, 0xFE, 0xFF, 0x7F, 0x3F, 0x0F, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x07, 0x0F, 0x3F, 0xFF, 0xFF, 0xFC, 0xF8, 0xE0, 0xC0, 0x00, 0x00, 0x03, 0x07,
    0x1F, 0x7F, 0xFF, 0xFF, 0xFC, 0xF0, 0xE0, 0x80, 0x00, 0x01, 0x03, 0x0F, 0x3F, 0xFF, 0xFF, 0xFC,
    0xF8, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0xE1, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xC0, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xF8, 0xFE, 0xFF, 0xFF, 0xFF, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x07, 0x0F, 0x07, 0x07, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xE0,
    0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x7F, 0xFF, 0xFC, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0xFF,
    0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0x0F, 0x03, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0xFF, 0xFF, 0xFF, 0xFC, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0x0F, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03,
    0x07, 0xFF, 0xFF, 0xFF, 0xFC, 0xE0, 0x00, 0x00, 0x00, 0x80, 0xFC, 0xFF, 0xFF, 0xFF, 0x0F, 0x03,
    0x01, 0x00, 0x00, 0x00, 0x80, 0x80, 0x81, 0x83, 0x87, 0x87, 0x87, 0x87, 0x80, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x03, 0x1F, 0x3F, 0xFF, 0xFE, 0xF8, 0xE0, 0xF0, 0xFC, 0xFF, 0x7F, 0x1F, 0x07,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x0F, 0x1F,
    0x3F, 0x7F, 0x7E, 0xFC, 0xF8, 0xF8, 0xF0, 0xE0, 0xE0, 0xC1, 0xC1, 0x83, 0x83, 0x87, 0x07, 0x07,
    0x0F, 0x0F, 0x0F, 0x0F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x0F, 0x0F, 0x0F, 0x0F,
    0x07, 0x87, 0x83, 0x83, 0xC3, 0xC1, 0xE0, 0xE0, 0xF0, 0xF0, 0xF8, 0xFC, 0x7E, 0x7E, 0x3F, 0x1F,
    0x0F, 0x07, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x07, 0x0F, 0x3F, 0xFF, 0xFF, 0xFC, 0xF0, 0xE0,
    0x80, 0x00, 0x00, 0x03, 0x07, 0x1F, 0x7F, 0xFF, 0xFE, 0xFC, 0xF0, 0xC0, 0x80, 0x00, 0x01, 0x07,
    0x1F, 0x3F, 0xFF, 0xFE, 0xFC, 0xF0, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0x83, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x1F, 0x7F, 0xFF, 0xFF, 0xFF, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x80, 0xE0, 0xF8, 0xF0, 0xF0, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x01, 0x07, 0x0F, 0x7F, 0xFF, 0xFE, 0xFC, 0xFF, 0xFF,
    0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0xFF, 0xFF, 0xFF, 0xF0, 0xC0, 0x80, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xFF, 0xFF, 0xFF, 0x3F, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x3F, 0xFF, 0xFF, 0xFF, 0xF0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0,
    0xE0, 0xFF, 0xFF, 0xFF, 0x3F, 0x07, 0x00, 0x00, 0x00, 0x01, 0x3F, 0xFF, 0xFF, 0xFF, 0xF0, 0xC0,
    0x80, 0x00, 0x00, 0x00, 0x07, 0x07, 0x87, 0x87, 0xC7, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x07, 0x07, 0x0F, 0x0F, 0x0F, 0x1F, 0x1F,
    0x1F, 0x1F, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x1F, 0x1F, 0x1F,
    0x1F, 0x0F, 0x0F, 0x0F, 0x07, 0x07, 0x07, 0x03, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x07, 0x07, 0x07,
    0x07, 0x06, 0x04, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x07, 0x07, 0x07, 0x06, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x03, 0x07, 0x07, 0x07, 0x07, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x07, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
    0x0F, 0x07, 0x07, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x0F, 0x0F,
    0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x07, 0x0F, 0x0F, 0x0F,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x07, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
    0x07, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x07,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x07, 0x07, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

};


void Print_Receipt2(EMVCL_RC_DATA_EX *data, ULONG ulValue){
	BYTE baTemp[384 * 64]; // The width of paper is 384 dot.

    //Font atrributes
    CTOS_FONT_ATTRIB stFONT_ATTRIB;

    //Auxiliar char buffer
    UCHAR charBuffer[50];

    // Auxiliar PAN number
    UCHAR applicationAIDAux[40];

    // Auxiliar PAN number
    UCHAR PANNumberAux[40];

    // Lenght of PAN number
    BYTE lenghtPANNumber;

    BYTE Timer_printSTR[40] = {0};
	
	CTOS_RTC stRTC;
	USHORT usRtn;
	
	CTOS_PrinterFontSelectMode(d_FONT_FNT_MODE);

    CTOS_PrinterFline(5);
	
	//Print out the bank logo
    usRtn = CTOS_PrinterLogo((BYTE *) baPrinterBufferLogo_Receipt2, 0, 380, 10);
    CTOS_PrinterFline(12);
	
	if(usRtn != d_OK){
		CTOS_LCDTClearDisplay();
		CTOS_LCDTPrintXY(1, 4, "   Printer Error!   ");
		CTOS_LCDTPrintXY(1, 5, " Please Check Paper ");
		return;
	}

    stFONT_ATTRIB.X_Space = 0;
    //The height of the space between the font with next font
    stFONT_ATTRIB.Y_Space = 0;
    memset(baTemp, 0x00, sizeof (baTemp));
    stFONT_ATTRIB.FontSize = d_FONT_8x16;
    //Double de X size
    stFONT_ATTRIB.X_Zoom = 3;
    //Double de Y size
    stFONT_ATTRIB.Y_Zoom = 4;
    //The width of the space between the font with next font
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, (BYTE *) "VEGA3000", &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 6);
    CTOS_PrinterFline(20);
	
    //==============================
    //Print out the transaction data
    //==============================
    CTOS_PrinterPutString((BYTE *) "MER ID: 886289131771");
    CTOS_PrinterFline(5);
    strcpy((char *) applicationAIDAux, "BATCH NO: 000307");
    CTOS_PrinterPutString(applicationAIDAux);
    CTOS_PrinterFline(5);


	//Card Number
    if (data->bSID == d_VW_SID_VISA_OLD_US || data->bSID == d_VW_SID_VISA_WAVE_2 || data->bSID == d_VW_SID_VISA_WAVE_QVSDC || data->bSID == d_VW_SID_VISA_WAVE_MSD) {
        memset(baTemp, 0x00, sizeof (baTemp));
        memset(baTemp2, 0x00, sizeof (baTemp2));
        memcpy(baTemp, &data->baTrack2Data[1], 4);
        memcpy(baTemp2, &data->baTrack2Data[13], 4);


    } else {
        UnpackData(data->baTrack2Data, 20, baTmp);
        memcpy(baTemp, baTmp, 4);
        memcpy(baTemp2, &baTmp[12], 4);
        baTemp2[16] = 0;

    }
	
    
    stFONT_ATTRIB.FontSize = d_FONT_8x16;
    stFONT_ATTRIB.X_Zoom = 2;
    stFONT_ATTRIB.Y_Zoom = 2;

    CTOS_PrinterPutString((unsigned char *) "CARD NO:");
    CTOS_PrinterFline(12);

    lenghtPANNumber = strlen("  ********************");
	sprintf(PANNumberAux, "  %s **** **** %s", baTemp, baTemp2);
    //strcpy((char *) PANNumberAux, "  ********************");
	
	memset(baTemp, 0x00, sizeof (baTemp));
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, PANNumberAux, &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 8);
	
	//Exp Date
    if (data->bSID == d_VW_SID_VISA_OLD_US || data->bSID == d_VW_SID_VISA_WAVE_2 || data->bSID == d_VW_SID_VISA_WAVE_QVSDC || data->bSID == d_VW_SID_VISA_WAVE_MSD) {
        memcpy(baTemp, &data->baTrack2Data[20], 2);
         baTemp[2] = 0;
         memcpy(baTmp1, &data->baTrack2Data[18], 2);
         baTmp1[2] = 0;


    } else {
        memcpy(baTemp, baTmp + 19, 2);
         baTemp[2] = 0;
         memcpy(baTmp1, baTmp + 17, 2);
         baTmp1[2] = 0;

    }
	
	sprintf(baBuf, "EXP. DATE: 20%s/%s", baTmp1, baTemp);
    CTOS_PrinterPutString(baBuf);
    CTOS_PrinterFline(5);
    CTOS_PrinterPutString((BYTE *) "ISSUER: 84188062");
    CTOS_PrinterFline(15);
	
	memset(baTemp, 0x00, sizeof (baTemp));
    stFONT_ATTRIB.FontSize = d_FONT_8x16;
    stFONT_ATTRIB.X_Zoom = 3;
    stFONT_ATTRIB.Y_Zoom = 2;
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, (BYTE *) "       BOOK/SALE", &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 6);
    CTOS_PrinterFline(12);

    CTOS_PrinterPutString((BYTE *) "TERM ID: 11010001   OPER ID: 002");
    CTOS_PrinterFline(5);
    CTOS_RTCGet(&stRTC);
    sprintf((char *) Timer_printSTR, "DATE:%02d/%02d/20%02d    TIME:%02d:%02d", stRTC.bDay, stRTC.bMonth, stRTC.bYear, stRTC.bHour, stRTC.bMinute);
    CTOS_PrinterPutString((BYTE *) Timer_printSTR);
    //CTOS_PrinterPutString((BYTE *)"DATE: 31/10/2012    TIME: 14:52");
    CTOS_PrinterFline(5);
    CTOS_PrinterPutString((BYTE *) "REF NO: 855090913452");
    CTOS_PrinterFline(15);
	
	CTOS_PrinterFontSelectMode(d_FONT_TTF_MODE);
	CTOS_PrinterTTFSelect("arial.ttf", 0);

    //sprintf((char *) charBuffer, "      $ %d", (int)ulValue);
	int i, j;
	i = (int)ulValue / 100;
	j = (int)ulValue % 100;
	if(i == 0){
		if(Dollar_Sign == 1)
			sprintf((char *) charBuffer, "      $ 0.%02d", j);
		else if(Dollar_Sign == 2)
			sprintf((char *) charBuffer, "      € 0.%02d", j);
	}
		//sprintf((char *) charBuffer, "      $ 0.%02d", j);
	else{
		if(Dollar_Sign == 1)
			sprintf((char *) charBuffer, "      $ %d.%02d", i, j);
		else if(Dollar_Sign == 2)
			sprintf((char *) charBuffer, "      € %d.%02d", i, j);
	}
		//sprintf((char *) charBuffer, "      $ %d.%02d", i, j);
    stFONT_ATTRIB.FontSize = d_FONT_12x24;
    stFONT_ATTRIB.X_Zoom = 3;
    stFONT_ATTRIB.Y_Zoom = 2;
    memset(baTemp, 0x00, sizeof (baTemp));
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, (BYTE *) charBuffer, &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 6);

    CTOS_PrinterFline(40);
    CTOS_PrinterPutString((BYTE *) "===== CARDHOLDER SIGNATURE =====");
    CTOS_PrinterFline(40);

    CTOS_PrinterPutString((BYTE *) "\n\n");
}

#endif
//------------------------------------------------------------------------------

void TLVDataClear(void) {
    TLVDataLen = 0;
}
//------------------------------------------------------------------------------

void TLVDataRemove(ULONG tag) {
    WORD i;
    WORD j;
    USHORT len;
    ULONG tag_value;
    USHORT len_value;
    USHORT data_offset;
    BYTE temp[10];

    i = j = 0;
    while (i < TLVDataLen) {
        data_offset = TLV_Get_Value(&TLVData[i], &tag_value, &len_value);
        len = data_offset + len_value;
        if (tag == tag_value) {
            i += len;
            continue;
        } else {

            memcpy(&TLVData[j], &TLVData[i], len);
            j += len;
            i += len;

        }
    }

    TLVDataLen = j;
}
//------------------------------------------------------------------------------

short TLVDataAdd(ULONG tag, USHORT len, BYTE *buf) {
    USHORT i;
    BYTE str[20];
    ULONG tag_value;
    USHORT len_value;
    USHORT data_offset;
    BYTE temp[10];

    i = 0;

    while (i < TLVDataLen) {
        data_offset = TLV_Get_Value(&TLVData[i], &tag_value, &len_value);
        if (tag == tag_value) {
            TLVDataRemove(tag);
            break;
        }

        i += (data_offset + len_value);
    }

    //Add new
    i = 0;

    if ((tag >> 16) > 0) {
        temp[i++] = (BYTE) (tag >> 16);
    }
    if ((tag >> 8) > 0) {
        temp[i++] = (BYTE) (tag >> 8);
    }
    temp[i++] = (BYTE) tag;

    if (len > 0xFF) {
        temp[i++] = 0x82;
        temp[i++] = len / 256;
        temp[i++] = len % 256;
    } else if (len > 0x7F) {
        temp[i++] = 0x81;
        temp[i++] = (BYTE) len;
    } else {
        temp[i++] = (BYTE) len;
    }

    if ((TLVDataLen + i + len) > d_TLV_DATA_BUF_SIZE) {
        return 1;
    }

    memcpy(&TLVData[TLVDataLen], temp, i);
    TLVDataLen += i;

    memcpy(&TLVData[TLVDataLen], buf, len);
    TLVDataLen += len;

    return 0;
}
//------------------------------------------------------------------------------

short TLVDataGet(ULONG tag, BYTE *buf) {
    USHORT i;
    ULONG tag_value;
    USHORT len_value;
    USHORT data_offset;

    i = 0;

    while (i < TLVDataLen) {
        data_offset = TLV_Get_Value(&TLVData[i], &tag_value, &len_value);
        if (tag == tag_value) {
            memcpy(buf, &TLVData[i + data_offset], len_value);
            return len_value;
        }

        i += (data_offset + len_value);
    }

    return 0;
}
//------------------------------------------------------------------------------

void TLVDataParse(BYTE *buf, USHORT len) {
    ULONG tag_value;
    USHORT len_value;
    USHORT i;
    USHORT offset;

    i = 0;
    while (i < len) {
        offset = TLV_Get_Value(&buf[i], &tag_value, &len_value);
        TLVDataAdd(tag_value, len_value, &buf[i + offset]);
        i += offset + len_value;
    }
}
//------------------------------------------------------------------------------

USHORT Online_Process(BYTE *baData, USHORT usDataLen) {
    BYTE baBuff[2048];
    BYTE key;
    USHORT usBuffLen;
    USHORT i;
    USHORT ret;

    //Send data to host
    usBuffLen = 0;
    baBuff[usBuffLen++] = 0x10;
    baBuff[usBuffLen++] = 0x02;
    for (i = 0; i < usDataLen; i++) {
        baBuff[usBuffLen++] = baData[i];
        if (baData[i] == 0x10) {
            baBuff[usBuffLen++] = baData[i];
        }
    }
    baBuff[usBuffLen++] = 0x00; //Ignore LRC check
    baBuff[usBuffLen++] = 0x10;
    baBuff[usBuffLen++] = 0x03;

    __DebugAddHEX("Data to Host", baBuff, usBuffLen);

    //Receive Response
    do {
#ifdef _SIMULATE_ONLINE_RESULT
//        CTOS_KBDHit(&key);
        key = '1';

        if (key == '1') {
            ret = d_EMVCL_OUTCOME_APPROVAL;
            break;
        } else if (key == '2') {
            ret = d_EMVCL_OUTCOME_DECLINED;
            break;
        }
#else

        i = sizeof (baBuff);
        if (CTOS_RS232RxData(d_COM1, baBuff, &i) == d_OK && i > 0) {
            if (baBuff[0] == '1') {
                ret = d_EMV_CHIP_ONL_APPROVAL;
            } else {
                ret = d_EMV_CHIP_ONL_DECLINED;
            }
            break;
        }

        CTOS_KBDHit(&key);

#endif 

    } while (key != d_KBD_CANCEL);

    if (key == d_KBD_CANCEL) {
        ret = d_EMVCL_OUTCOME_DECLINED;
    }

    return ret;
}
//------------------------------------------------------------------------------
//	x: X position
//	y: Y position
//	min: Minimum length of the input data
//	max: Maximum length of the input data
//	mask: If maskchar = 0, don't need mask char, if > 0, it will show to screen.

char Get_PIN_Input(BYTE x, BYTE y, BYTE min, BYTE max, char mask, char *buf, BYTE *len) {
    BYTE ilen;
    BYTE c[2];

    //CTOS_LCDTGotoXY(x, y);

    ilen = 0;
    c[1] = 0; //NULL

    while (TRUE) {
        CTOS_KBDGet(c);

        if (c[0] >= '0' && c[0] <= '9') //0-9
        {
            if (x <= 16 && ilen < max) {
                buf[ilen++] = c[0];
                if (mask == 0)
                    TopRelative_LCDTPutchXY(x, y, c[0]);
                else
                    TopRelative_LCDTPutchXY(x, y, mask);

                x++;
            }
        } else if (c[0] == d_KBD_CLEAR) //clear
        {
            if (ilen > 0) {
                ilen--;
                x--;
                TopRelative_LCDTPutchXY(x, y, ' ');
            }
        } else if (c[0] == d_KBD_CANCEL) //cancel
        {
            return FALSE;
        } else if (c[0] == d_KBD_ENTER && ilen >= min) //enter
        {
            *len = ilen;
            buf[ilen] = 0x00; //put end of string
            return TRUE;
        }
    }
}
//------------------------------------------------------------------------------

void StartTrans(BYTE bType) {
    BYTE bKey;
    BYTE is_online_request;
    BYTE NeedSignature;
    BYTE temp[20];
    BYTE upload_tx_buf[1024];
    USHORT upload_tx_len;
    BYTE pin[20];
    BYTE pin_len;
    ULONG ulAPRtn;
    BYTE *msg;
    BYTE *CVMStr;
    BYTE TransaRelatedData[100];
    BYTE lenn;

    BYTE bAction;
    BYTE baARC[2];
    UINT uiIADLen;
    BYTE baIAD[128];
    UINT uiScriptLen;
    BYTE baScript[256];
    ULONG ulScheme;
    ULONG ulValue;
	USHORT ret;
    
    __DebugAddINT("               ", 0);
    __DebugAddINT("               ", 0);
    
//    CTOS_FunRedirectSetDevice(0x01, 0x00);
    
    
    // amount - ascii to int
    ulAmt = ASCII2Int(g_baInputAmt, g_usAmtLen);
    ulCBAmt = ASCII2Int(g_baInputCBAmt, g_usCBAmtLen);
    ulAmt += ulCBAmt;
    
	//CTOS_FunRedirectSetDevice(0x00, 0x00); 
	//CTOS_LCDGShowBMPPic(0, 0, "Processing_V3.bmp");
	//CTOS_FunRedirectSetDevice(0x01, 0x00001F00); 
	//CTOS_LCDGShowBMPPic(0, 60, "fs_data/Processing_V3P_420.bmp");
	
    memset(temp,0,20);

    sprintf(temp, " Amount:$%ld   ", ulAmt);
    PageSetString(1, temp);
    //PageShow(d_PAGE_TRANSACTION_PRESENT_CARD);
	
	

//    PageClean();
//    EMVCL_ShowContactlessSymbol(NULL);
//    CTOS_LCDGShowPic(95,55,(BYTE *)baLCDLogo,sizeof(baLCDLogo),142);     \\for 2.4" LCD
    
//    CTOS_LCDTPrintXY(1,1,"");
//    CTOS_LCDTPrintXY(1, 1, "                                   ");
//    CTOS_LCDTPrintXY(1, 2, "                                   ");
    
    //EMVCL_ShowVirtualLED(NULL);
    EMVCL_SetLED(0x0F, 0x08);

    memset(&stACTData, 0, sizeof (EMVCL_ACT_DATA));
    memset(&stRCDataEx, 0, sizeof (EMVCL_RC_DATA_EX));
    memset(&stRCDataAnalyze, 0, sizeof (EMVCL_RC_DATA_ANALYZE));


    // perform transaction : EMVCL_StartTransactionEx
    stACTData.bStart = d_EMVCL_ACT_DATA_START_A;
    stACTData.bTagNum = 0;
    stACTData.usTransactionDataLen = 0;

    //Put 0x9F02 Amount, Authorized (Numeric)
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x9F;
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x02;
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x06;
    wub_long_2_bcd(ulAmt, temp, &lenn);
    memset(&TransaRelatedData[stACTData.usTransactionDataLen], 0, 6);
    memcpy(&TransaRelatedData[stACTData.usTransactionDataLen + 6 - lenn], temp, lenn);
    stACTData.usTransactionDataLen += 6;
    stACTData.bTagNum++;

    //Put 0x9F03
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x9F;
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x03;
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x06;
    wub_long_2_bcd(ulCBAmt, temp, &lenn);
    memset(&TransaRelatedData[stACTData.usTransactionDataLen], 0, 6);
    memcpy(&TransaRelatedData[stACTData.usTransactionDataLen + 6 - lenn], temp, lenn);

    stACTData.usTransactionDataLen += 6;
    stACTData.bTagNum++;

    //Put 0x9C
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x9C;
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x01;
    TransaRelatedData[stACTData.usTransactionDataLen++] = g_bTxntype;
    stACTData.bTagNum++;

    if (g_isForcedOnl == TRUE) {
        TransaRelatedData[stACTData.usTransactionDataLen++] = 0xDF;
        TransaRelatedData[stACTData.usTransactionDataLen++] = 0x9F;
        TransaRelatedData[stACTData.usTransactionDataLen++] = 0x01;
        TransaRelatedData[stACTData.usTransactionDataLen++] = 0x01;
        TransaRelatedData[stACTData.usTransactionDataLen++] = 0x01;
        stACTData.bTagNum++;
    }

    __DebugAddHEX("In Data", TransaRelatedData, stACTData.usTransactionDataLen);

    stACTData.pbaTransactionData = TransaRelatedData;

    if (bType == d_INIT_TRANS) {
        EMVCL_InitTransactionEx(stACTData.bTagNum, stACTData.pbaTransactionData, stACTData.usTransactionDataLen);

        do {
			CTOS_KBDHit(&bKey);
			
			ret = EMVPolling();
			if(ret == d_OK)
			{
				return;
			}else if(ret == d_PIN_FAIL){
				//CTOS_LCDGShowBMPPic(0, 60, "fs_data/SwipeInsertTap_V3P_420.bmp");
				EMVCL_CancelTransaction();
				return;
			}else if(ret == d_SIGN_FAIL){
				EMVCL_CancelTransaction();
				return;
			}
			
            ulAPRtn = EMVCL_PerformTransactionEx(&stRCDataEx);

            if (ulAPRtn == d_EMVCL_TX_CANCEL) {
                return;
            } else if (ulAPRtn == 0xA00000E0) {

            } else if (ulAPRtn != d_EMVCL_PENDING) {
                break;
            }
			
			if(bKey == d_KBD_CANCEL){
				EMVCL_CancelTransaction();
				return;
			}	

        } while (1);
    } else {
        __DebugAddSTR("Go EMVCL_StartTransactionEx");
        ulAPRtn = EMVCL_StartTransactionEx(&stACTData, &stRCDataEx);
        if (ulAPRtn == d_EMVCL_TX_CANCEL) {
            return;
        }
    }
	
	CTOS_Delay(2000);//Must delay 2sec for Euro UI virtual LED to process
	CTOS_FunRedirectSetDevice(0x00, 0x00); 
	CTOS_LCDGShowBMPPic(0, 0, "Processing_V3.bmp");
	CTOS_FunRedirectSetDevice(0x01, 0x00001F00); //
	CTOS_LCDGShowBMPPic(0, 60, "fs_data/Processing_V3P_420.bmp");
	EMVCL_SetLED(0x0F, 0x08);

    __DebugAddINT("TestPerform rtn", ulAPRtn);
    __DebugAddINT("SID", stRCDataEx.bSID);
    __DebugAddSTR(stRCDataEx.baDateTime);
    __DebugAddHEX("SCData Track1", stRCDataEx.baTrack1Data, stRCDataEx.bTrack1Len);
    __DebugAddHEX("SCData Track2", stRCDataEx.baTrack2Data, stRCDataEx.bTrack2Len);
    //DebugAddSTR(stRCDataEx.baTrack1Data);
    //DebugAddSTR(stR__DebugAddHEX("SCData Chip", stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
    __DebugAddHEX("SCData Additional", stRCDataEx.baAdditionalData, stRCDataEx.usAdditionalDataLen); //stRCDataEx.baTrack2Data);
    __DebugAddHEX("SCData baChipData", stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
    //	Show_TLV_Data("SCData Chip:", stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
    //	Show_TLV_Data("SCData Additional:", stRCDataEx.baAdditionalData, stRCDataEx.usAdditionalDataLen);

//    PageClean();
    

    if (ulAPRtn != d_EMVCL_RC_DATA) {
        PageSetParameter(1, &ulAPRtn);
        //PageShow(d_PAGE_TRANSACTION_NO_CARD_AND_USE_OTHER_CARD);

        //ForceMainDevice_KBDGet(&bKey);

        return;
    }


    //Parse transaction response data	
    //Parse Scheme ID
    ulScheme = 0 + stRCDataEx.bSID;
    PageSetParameter(1, &ulScheme);
    //CTOS_LCDTPrintXY(1, 4, msg);

    //Parse received chip and additional data 
    TLVDataClear();
    TLVDataParse(stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
    TLVDataParse(stRCDataEx.baAdditionalData, stRCDataEx.usAdditionalDataLen);

    EMVCL_AnalyzeTransactionEx(&stRCDataEx, &stRCDataAnalyze);

    //After parsing transaction data, check if CVM is need and get the transaction result	
    //CVM Require - If Card need CVM, performing CVM at this moment
    NeedSignature = FALSE;
    CVMStr = "                ";

    if (stRCDataAnalyze.bCVMAnalysis == d_EMVCL_CVM_REQUIRED_SIGNATURE) {
        CVMStr = "CVM->Signature";
        NeedSignature = TRUE;
    } else if (stRCDataAnalyze.bCVMAnalysis == d_EMVCL_CVM_REQUIRED_ONLPIN) {
        CVMStr = "CVM->PIN";
        PageClean();

        //PageShow(d_PAGE_TRANSACTION_ENTER_ONLINE_PIN);

        if (Get_PIN_Input(1, 2, 4, 16, '*', pin, &pin_len) == FALSE) {
           // PageShow(d_PAGE_TRANSACTION_PIN_BY_PASS);
        }

        //set TVR byte 3 if need
        //ex : TLVDataGet(0x95, temp);
        // temp[2] |= 0x04;
        //TLVDataAdd(0x95, 5, temp);
    } else if (stRCDataAnalyze.bCVMAnalysis == d_EMVCL_CVM_REQUIRED_NOCVM) {
        CVMStr = "CVM->No CVM Req";
    }

    usTxResult = stRCDataAnalyze.usTransResult;
    __DebugAddINT("Transaction Result", usTxResult);


    //PageShow(d_PAGE_TRANSACTION_SHOW_SCHEME_ID);

    is_online_request = FALSE;

    //Online
    if (usTxResult == d_EMVCL_OUTCOME_ONL) {
        is_online_request = TRUE;
        //PageShow(d_PAGE_TRANSACTION_OUTCOME_GO_ONL);
    }//Offline Approval
    else if (usTxResult == d_EMVCL_OUTCOME_APPROVAL) {
        //        sprintf(temp, " Amount $ %ld", ulValue);

        sprintf(temp, " Amount $ %ld", ulAmt);
        PageSetString(1, temp);
        PageSetString(2, CVMStr);
        //PageShow(d_PAGE_TRANSACTION_OUTCOME_OFFLINE_APPROVAL);

    }//Offline Declined
    else if (usTxResult == d_EMVCL_OUTCOME_DECLINED) {
        PageSetString(1, CVMStr);
        //PageShow(d_PAGE_TRANSACTION_OUTCOME_OFFLINE_DECLINED);
    } else {
        //PageShow(d_PAGE_TRANSACTION_OUTCOME_UNKNOWN);
//        CTOS_KBDGet(&bKey);
        //ForceMainDevice_KBDGet(&bKey);
        return;
    }

    //Online : send online data to host for online authrn.
    if (is_online_request == TRUE) {
        //Rrepare Upload Data to host
        upload_tx_len = 0;

        upload_tx_buf[upload_tx_len++] = 14;
        memcpy(&upload_tx_buf[upload_tx_len], stRCDataEx.baDateTime, 14);
        upload_tx_len += 14;

        upload_tx_buf[upload_tx_len++] = stRCDataEx.bTrack1Len;
        memcpy(&upload_tx_buf[upload_tx_len], stRCDataEx.baTrack1Data, stRCDataEx.bTrack1Len);
        upload_tx_len += stRCDataEx.bTrack1Len;

        upload_tx_buf[upload_tx_len++] = stRCDataEx.bTrack2Len;
        memcpy(&upload_tx_buf[upload_tx_len], stRCDataEx.baTrack2Data, stRCDataEx.bTrack2Len);
        upload_tx_len += stRCDataEx.bTrack2Len;

        upload_tx_buf[upload_tx_len++] = stRCDataEx.usChipDataLen / 256;
        upload_tx_buf[upload_tx_len++] = stRCDataEx.usChipDataLen % 256;
        memcpy(&upload_tx_buf[upload_tx_len], stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
        upload_tx_len += stRCDataEx.usChipDataLen;

        upload_tx_buf[upload_tx_len++] = stRCDataEx.usAdditionalDataLen / 256;
        upload_tx_buf[upload_tx_len++] = stRCDataEx.usAdditionalDataLen % 256;
        memcpy(&upload_tx_buf[upload_tx_len], stRCDataEx.baAdditionalData, stRCDataEx.usAdditionalDataLen);
        upload_tx_len += stRCDataEx.usAdditionalDataLen;

        //send upload data and get the online authen result
        usTxResult = Online_Process(upload_tx_buf, upload_tx_len);

#if 0
        //CTOS_Delay(3000);

        bAction = 0x01;
        memcpy(baARC, "00", 2);
        //uiIADLen = 0;
        uiIADLen = 10;
        memcpy(baIAD, "\x11\x22\x33\x44\x55\x66\x77\x88\x30\x30", 10);
        //uiScriptLen = 0;
        uiScriptLen = 35;
        memcpy(baScript, "\x72\x21\x9F\x18\x04\x11\x22\x33\x44\x86\x0D\x84\x24\x00\x00\x08\xAA\xBB\xCC\xDD\x11\x22\x33\x44\x86\x09\x84\x24\x00\x00\x04\x55\x66\x77\x88", 35);

        ulAPRtn = EMVCL_CompleteEx(bAction, baARC, uiIADLen, baIAD, uiScriptLen, baScript, &stRCDataEx);

        __DebugAddINT("complete rtn", ulAPRtn);
        __DebugAddINT("c SID", stRCDataEx.bSID);
        __DebugAddSTR(stRCDataEx.baDateTime);
        __DebugAddHEX("c SCData Track1", stRCDataEx.baTrack1Data, stRCDataEx.bTrack1Len);
        __DebugAddHEX("c SCData Track2", stRCDataEx.baTrack2Data, stRCDataEx.bTrack2Len);
        //DebugAddSTR(stRCDataEx.baTrack1Data);
        //DebugAddSTR(stRCDataEx.baTrack2Data);
        __DebugAddHEX("c SCData Chip", stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
        __DebugAddHEX("c SCData Additional", stRCDataEx.baAdditionalData, stRCDataEx.usAdditionalDataLen);
#endif

        //Online Approval
        if (usTxResult == d_EMVCL_OUTCOME_APPROVAL) {
            //            sprintf(temp, " Amount $ %ld", ulValue);
            sprintf(temp, " Amount $ %ld", ulAmt);
            PageSetString(1, temp);
            PageSetString(2, CVMStr);
            //PageShow(d_PAGE_TRANSACTION_OUTCOME_ONLINE_APPROVAL);
        }//Online Declined
        else {
            PageSetString(1, CVMStr);
            //PageShow(d_PAGE_TRANSACTION_OUTCOME_ONLINE_DECLINED);
        }
    }
    
    CTOS_FunRedirectSetDevice(0x00, 0x00); 
	CTOS_LCDGShowBMPPic(0, 0, "Printing_V3.bmp");
	CTOS_FunRedirectSetDevice(0x01, 0x00001F00); 
	CTOS_LCDGShowBMPPic(0, 60, "fs_data/Printing_V3P_420.bmp");
	EMVCL_SetLED(0x0F, 0x08);
    //CTOS_FunRedirectSetDevice(0x00, 0x00);  
    //Print_Receipt(&stRCDataEx, NeedSignature, ulAmt);
	CTOS_FunRedirectSetDevice(0x00, 0x00);
	Print_Receipt2(&stRCDataEx, ulAmt);

    return;
}
//------------------------------------------------------------------------------

void SelectTxnType(void) {
    BYTE bKey;

    PageShow(d_PAGE_TRANSACTION_SELECT_TYPE);

    do {
//        CTOS_KBDGet(&bKey);
        ForceMainDevice_KBDGet(&bKey);

        switch (bKey) {
            case d_KBD_1: //Purchase
                g_bTxntype = 0x00;
                break;
            case d_KBD_2: //Cash
                g_bTxntype = 0x01;
                break;
            case d_KBD_3: //Cash Back
                g_bTxntype = 0x09;
                break;
            case d_KBD_4: //Refund
                g_bTxntype = 0x20;
                break;
            case d_KBD_CANCEL: //Cancel
                return;
            default:
                continue;
        }

    } while (0);

    PageShow(d_PAGE_TRANSACTION_SELECT_TYPE_SET_OK);

    CTOS_Delay(500);
}
//------------------------------------------------------------------------------

void ForedTxnOnline(void) {
    BYTE bKey;

    PageShow(d_PAGE_TRANSACTION_FORCE_ONLINE);

    do {
        if (g_isForcedOnl == TRUE) {
            TopRelative_LCDTPrintXY(1, 2, "States : [Y]");
        } else {
            TopRelative_LCDTPrintXY(1, 2, "States : [N]");
        }
//        CTOS_KBDGet(&bKey);
        ForceMainDevice_KBDGet(&bKey);

        switch (bKey) {
            case d_KBD_1:
                g_isForcedOnl = !g_isForcedOnl;
                break;
            case d_KBD_CANCEL: //Cancel
                return;
            default:
                continue;
        }

    } while (1);

    //CTOS_LCDTPrintXY(1, 8, "4. Set OK!!");
    //CTOS_Delay(500);
}
//------------------------------------------------------------------------------
extern USHORT CTOS_FunRedirectSetDevice(USHORT usDeviceID, ULONG ulPara);
//------------------------------------------------------------------------------
//EMV
#define d_BUFF_SIZE 128 
#define d_ONLINE_KEYSET         0x2001
#define d_ONLINE_KEYINDEX       0x0000
#define d_OFFLINE_KEYINDEX      0x0001
#define d_ONLINE_KEY            "\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11"
#define d_EMV_CONFIG_FILE       "emv_config.xml"


ULONG g_ulAMT = 0;
BOOL isOfflinePIN = FALSE;
BOOL isPIN_OK = FALSE;
BOOL isInsertPIN = FALSE;
static BYTE baAuthorizationCode[4]; 
static BYTE baIssuerAuthenticationData[128];
static BYTE baIssuerScript[256]; 


void write_online_key2(void)
{
  USHORT usRet;
  CTOS_KMS2KEYWRITE_PARA stKeyWritePara;
  
  memset(&stKeyWritePara, 0x00, sizeof(CTOS_KMS2KEYWRITE_PARA));
  
  stKeyWritePara.Info.KeySet = d_ONLINE_KEYSET;
  //stKeyWritePara.Info.KeySet = 0x1001;
  stKeyWritePara.Info.KeyIndex = d_ONLINE_KEYINDEX;
  stKeyWritePara.Info.KeyVersion = 0x01;
  stKeyWritePara.Info.KeyType = KMS2_KEYTYPE_3DES;
  stKeyWritePara.Info.KeyAttribute = KMS2_KEYATTRIBUTE_PIN;
  
  stKeyWritePara.Protection.Mode = KMS2_KEYPROTECTIONMODE_PLAINTEXT;
  //stKeyWritePara.Protection.Mode = KMS2_KEYPROTECTIONMODE_KPK_ECB;
  //stKeyWritePara.Verification.KeyCheckValueLength = 4;
  //stKeyWritePara.Verification.pKeyCheckValue = check_value;
  
  stKeyWritePara.Value.KeyLength = 16;
  stKeyWritePara.Value.pKeyData = d_ONLINE_KEY;
      
  usRet = CTOS_KMS2KeyWrite(&stKeyWritePara);
  printf("write_online_key usRet = %x\n",usRet);
  
  stKeyWritePara.Info.KeyIndex = d_OFFLINE_KEYINDEX;
  stKeyWritePara.Info.KeyAttribute = KMS2_KEYATTRIBUTE_ENCRYPT+KMS2_KEYATTRIBUTE_DECRYPT;
  
  usRet = CTOS_KMS2KeyWrite(&stKeyWritePara);
}


void OnDisplayShow2(IN char *pStrMsg)  //add '\n' break line
{
//printf("OnDisplayShow 1\n");
    //CTOS_LCDTPrintXY(1, 3, pStrMsg);
//printf("OnDisplayShow 2\n");
}


static void OnErrorMsg2(IN char *pStrMsg)
{
//printf("OnErrorMsg 1\n");
    CTOS_LCDTPrintXY(1, 6, pStrMsg);
//printf("OnErrorMsg 2\n");
}


// This function will be called during EMV_Initialize;
static void OnEMVConfigActive2(INOUT BYTE* pActiveIndex)
{
	
}


static USHORT OnTxnDataGet2(OUT EMV_TXNDATA *pTxnData)
{
//printf("OnTxnDataGet 1\n");
    pTxnData->Version = 1;
    pTxnData->ulAmount = g_ulAMT;
//printf("OnTxnDataGet 2\n");    
    return d_OK;
}


#define d_FONTSIZE 16

static BYTE ShowAPList(BYTE start_y, BYTE max_y, BYTE *sHeaderString, BYTE iHeaderStrLen, BYTE apnum, char aplist[][17], BYTE *selitem)
{
	BYTE str[20], i, curr_top, curr_off, c;
	BYTE hx = 1, hy = 1;
	BYTE baHeader[17];

	CTOS_LCDTClearDisplay();

	//Show [AP List]
	if (iHeaderStrLen <= d_FONTSIZE) {
		//by Center
		hx = ((d_FONTSIZE - iHeaderStrLen) / 2) + 1;
		memset(baHeader, 0x20, sizeof (baHeader));
		memcpy(&baHeader[hx - 1], sHeaderString, iHeaderStrLen);
		CTOS_LCDTPrintXY(1, 1, baHeader);
	}
        
	curr_top = 0;
	curr_off = 0; //Offset from curr_top

	while (1) {
		for (i = start_y; i <= max_y; i++)
			CTOS_LCDTPrintXY(1, i, (BYTE*)"                ");

		for (i = 0; i < max_y - start_y + 1; i++) {
			if (curr_top + i >= apnum)
				break;

			if (i == curr_off)
				CTOS_LCDTSetReverse(TRUE);

			CTOS_LCDTPrintXY(1, start_y + i, (BYTE*)aplist[curr_top + i]);

			if (i == curr_off)
				CTOS_LCDTSetReverse(FALSE);
		}

		CTOS_KBDGet(&c);

		//UP for V7, F1 for V9
		if (c == d_KBD_UP || c == d_KBD_F1) {
			if (curr_off > 0) {
				curr_off--;
			}
			else if (curr_top > 0 && curr_off == 0) {
				curr_top--;
			}
		} else if (c == d_KBD_DOWN || c == d_KBD_F4) {
			if (curr_top + curr_off + 1 < apnum) {
				if (curr_off < max_y - start_y) {
					curr_off++;
				} else if (curr_top + curr_off < apnum) {
					curr_top++;
				}
			}
		} else if (c == d_KBD_ENTER) {
			*selitem = curr_top + curr_off;
			return 0;
		} else if (c == d_KBD_CANCEL) {
			return 1;
		} else if (c >= '1' && c <= '9') {
			*selitem = c - '0' - 1;
			return 0;
		}
	}
}


// Range of pAppSelectedIndex value is 0 to (AppNum-1)    
USHORT OnAppList2(IN BYTE AppNum, IN char AppLabel[][d_LABEL_STR_SIZE+1], OUT BYTE *pAppSelectedIndex)
{
//printf("OnAppList 1\n");
  BYTE sHeaderString[17];
    
    
    memset(sHeaderString, 0x00, sizeof(sHeaderString));
    sprintf(sHeaderString, "APP List");
//printf("OnAppList 2\n");    
    if (ShowAPList(2, 6, sHeaderString, strlen(sHeaderString), AppNum, AppLabel, pAppSelectedIndex) != 0)
        return d_EMVAPLIB_ERR_ABORT_TX;
//printf("OnAppList 3\n");    
    return d_EMVAPLIB_OK;
    
}

// Return d_OK to indicate CONFIRMED        
static USHORT OnAppSelectedConfirm2(IN BOOL IsRequiredbyCard, IN BYTE *pLabel, IN BYTE bLabelLen)
{
  return d_OK;
}

  
static BOOL OnTerminalDataGet2(IN USHORT usTag, INOUT USHORT *pLen, OUT BYTE *pValue)
{
    
    return FALSE;
}

   
static BOOL OnCAPKGet2(IN BYTE *pRID, IN BYTE bKeyIndex, OUT BYTE *pModulus, OUT USHORT *pModulusLen, OUT BYTE *pExponent, OUT USHORT *pExponentLen)
{
    
    return FALSE;
}

    
// Return d_OK to indicate Online PIN block is ready for application
USHORT OnOnlinePINBlockGet2(OUT ONLINE_PIN_DATA *pOnlinePINData)
{
	return 0;
}
   
static int iTestCancel(void)
{
	return 0;
}

// Return d_OK to indicate Offline PIN block is ready for Kernel
// If this function uses KMS_GetEncOfflinePIN function to get offline pin, return d_EMV_ENTER_KMS_OFFLINEPIN to indicate enciphed offline PIN is ready for Kernel    
USHORT OnOfflinePINBlockGet2(void)
{
	return 0;
}

void OnPINVerifyResult2(IN USHORT usResult)
{
printf("OnPINVerifyResult 1\n");
   BYTE data[32];
    
   isOfflinePIN = TRUE;
   memset(data, 0, sizeof(data));
    
   if (usResult == d_PIN_RESULT_OK) 
   {
       isPIN_OK = TRUE;
       //"PIN Verify OK"
       sprintf(data, "PIN Verify OK");
   }
   else if (usResult == d_PIN_RESULT_FAIL) 
   {
       isPIN_OK = FALSE;
       //"!PIN Wrong!"
       sprintf(data, "PIN Wrong");
   }
   else if (usResult == d_PIN_RESULT_BLOCKED || usResult == d_PIN_RESULT_FAILBLOCKED) 
   {
       isPIN_OK = FALSE;
       //"!PIN Blocked!"
       sprintf(data, "PIN Blocked");
   }
   
   CTOS_LCDTPrintXY(1, 4, data);
   CTOS_Delay(2000);
	printf("OnPINVerifyResult 2\n");
}

void OnTxnOnline2(IN ONLINE_PIN_DATA *pOnlinePINData, OUT EMV_ONLINE_RESPONSE_DATA* pOnlineResponseData)
{
printf("OnTxnOnline 1\n");
    if(pOnlinePINData->bPINLen == 0 && !isInsertPIN)
    {
        isPIN_OK = TRUE;
        pOnlineResponseData->bAction = d_ONLINE_ACTION_APPROVAL;
//        ret = InsertPIN(pOnlinePINData);
    }
    else
    {
        if(isOfflinePIN)
        {
            if(isPIN_OK)
            {
                pOnlineResponseData->bAction = d_ONLINE_ACTION_APPROVAL;
            }
            else
            {
                pOnlineResponseData->bAction = d_ONLINE_ACTION_DECLINE;
            }
        }
        else if(memcmp(SelectedAID, "\xA0\x00\x00\x00\x03", 5) == 0)
        {
            if(memcmp(pOnlinePINData->pPIN, "\x47\x67\x9C\x25\xF8\x48\x73\xA2", 8) == 0) 
            {          
                isPIN_OK = TRUE;
                pOnlineResponseData->bAction = d_ONLINE_ACTION_APPROVAL;
            }
            else
            {                   
                isPIN_OK = FALSE;
                pOnlineResponseData->bAction = d_ONLINE_ACTION_DECLINE;
            }
        }
        else
        {
            if(memcmp(pOnlinePINData->pPIN, "\x5C\x73\xAF\xC9\x85\x28\xCF\xF2", 8) == 0) 
            {
                isPIN_OK = TRUE;
                pOnlineResponseData->bAction = d_ONLINE_ACTION_APPROVAL;                
            }
            else
            {
                isPIN_OK = FALSE;
                pOnlineResponseData->bAction = d_ONLINE_ACTION_DECLINE;                
            }
        }
    }
        
//    CTOS_Delay(1500);
  
//    pOnlineResponseData->bAction = d_ONLINE_ACTION_APPROVAL;
    
    memcpy(baAuthorizationCode, "00", 2);
    pOnlineResponseData->pAuthorizationCode = baAuthorizationCode;
    pOnlineResponseData->pIssuerAuthenticationData = baIssuerAuthenticationData;
    pOnlineResponseData->pIssuerScript = baIssuerScript;
printf("OnTxnOnline 2\n");
}

static void OnTxnIssuerScriptResult2(IN BYTE* pScriptResult, IN USHORT pScriptResultLen)
{
	
}


void OnTxnResult2(IN BYTE bResult, IN BOOL IsSignatureRequired)
{

}

static void OnTotalAmountGet2(IN BYTE *pPAN, IN BYTE bPANLen, OUT ULONG *pAmount)
{
    *pAmount = 0;
}


static void OnExceptionFileCheck2(IN BYTE *pPAN, IN BYTE bPANLen, OUT BOOL *isException)
{
	
}


static BOOL OnCAPKRevocationCheck2(IN BYTE *pbRID, IN BYTE bCAPKIdx, BYTE *pbSerialNumuber)
{
    return FALSE;
}


void OnGetPINNotify2(IN BYTE bPINType, IN USHORT bRemainingCounter, OUT BOOL* pIsUseDefaultGetPINFunc, OUT DEFAULT_GETPIN_FUNC_PARA *pPara)
{
printf("OnGetPINNotify 1\n");
  BYTE pan[32];
  
  *pIsUseDefaultGetPINFunc = FALSE;
  isInsertPIN = TRUE;
  
  memset(pPara, 0x00, sizeof(DEFAULT_GETPIN_FUNC_PARA));
  pPara->usLineLeft_X = 5;
  pPara->usLineRight_X = 20;
  pPara->bPINDigitMaxLength = 12;
  pPara->bPINDigitMinLength = 4;
  pPara->usLinePosition_Y = 6;
  pPara->ulTimeout = 300;
  
  if (bPINType == d_NOTIFY_OFFLINE_PIN)
  {
    pPara->IsReverseLine = TRUE;
    pPara->IsRightToLeft = TRUE;
  
    //CTOS_LCDTPrintXY(1, 5, "Enter Offline PIN:");
    CTOS_LCDTPrintXY(1, 3, "Enter Offline PIN:");
  }else
  {
    pPara->ONLINEPIN_PARA.CipherKeyIndex = d_ONLINE_KEYINDEX;
    pPara->ONLINEPIN_PARA.CipherKeySet = d_ONLINE_KEYSET;
    pPara->ONLINEPIN_PARA.bPANLen = 16;
    memset(pan, 0x30, sizeof(pan));
    memset(pPara->ONLINEPIN_PARA.baPAN, 0x30, 16);
            
    //CTOS_LCDTPrintXY(1, 5, "Enter Online PIN:");
    CTOS_LCDTPrintXY(1, 3, "Enter Online PIN:");
  }
printf("OnGetPINNotify 2\n");
}


EMV_EVENT g_emv_event2 = 
{
    1,
	OnDisplayShow2,
    OnErrorMsg2, 
    OnEMVConfigActive2, 
    NULL,
	OnTxnDataGet2, 
    OnAppList2,
    OnAppSelectedConfirm2,
    OnTerminalDataGet2,
    OnCAPKGet2,
    OnGetPINNotify2,
    OnOnlinePINBlockGet2,
    OnOfflinePINBlockGet2,
    OnPINVerifyResult2,
    OnTxnOnline2,
    OnTxnIssuerScriptResult2,
    OnTxnResult2,
    OnTotalAmountGet2,
    OnExceptionFileCheck2,
    OnCAPKRevocationCheck2,
};


void Polling_Card(void)
{
    BYTE ATQA[1024];
    BYTE SAK[1024];
    BYTE CSN[1024];
    BYTE CSNLen;
    BYTE PUPI[1024];
    USHORT ret;
	BYTE buffer[16];
	BYTE g_baInputAmt2[20];
	USHORT g_usAmtLen2;
	BYTE Key;
    USHORT rtn;
    BYTE LCDbuff[32];
	USHORT 	usTk1Len, usTk2Len, usTk3Len;
	BYTE 	baTk1Buf[d_BUFF_SIZE], baTk2Buf[d_BUFF_SIZE], baTk3Buf[d_BUFF_SIZE];
	
	//EMVC
	CTOS_KMS2Init();
	rtn = EMV_Initialize(&g_emv_event2, d_EMV_CONFIG_FILE); 
    if(rtn != d_OK)
    {
        sprintf(LCDbuff, "initial ret %04X ", rtn);
        CTOS_LCDTPrintXY(1, 6, LCDbuff);     
		return d_NO;		
    }
	CTOS_KMS2Erase();
    write_online_key2();
    srand(time(NULL));
	
	//Clear MSR
	usTk1Len = usTk2Len = usTk3Len = d_BUFF_SIZE;
	CTOS_MSRRead(baTk1Buf, &usTk1Len, baTk2Buf, &usTk2Len, baTk3Buf, &usTk3Len);

	/*
    while(Key != d_KBD_CANCEL)
    {
		CTOS_KBDHit(&Key);
        //CTOS_LCDGShowPic(95,110,(BYTE *)baLCDLogo,sizeof(baLCDLogo),142); //not working in pinpad
		
        if(d_OK == CTOS_CLTypeAActiveFromIdle(0,ATQA,SAK,CSN,&CSNLen))
        {
            CTOS_CLPowerOff();
            CTOS_CLPowerOn();
            StartTrans(d_INIT_TRANS);//d_START_TRANS          
            return;
        }
        CTOS_Delay(100);
        if(d_OK == CTOS_CLTypeBActive(PUPI))
        {
            CTOS_CLPowerOff();
            CTOS_CLPowerOn();
            StartTrans(d_INIT_TRANS);//d_START_TRANS          
            return;
        }
		CTOS_Delay(100);
        ret = EMVPolling();
        if(ret == d_OK)
        {
            return;
        }else if(ret == d_PIN_FAIL){
			CTOS_LCDGShowBMPPic(0, 60, "fs_data/SwipeInsertTap_V3P_420.bmp");
		}
    }
	*/
    StartTrans(d_INIT_TRANS);//d_START_TRANS          
    return;
    
}
//------------------------------------------------------------------------------
void Transaction(void) {
    ULONG ulRtn;
    ULONG ulTxntype;
    BYTE *pstr;
	int i;
	time_t timer1;
	time_t timer2;

    //Perform Transaction via Transaction APIs	
    iBatchNo = 0;
	i = 0;
	timer1 = time(NULL);
    while (1) {
        //PageClean();
		CTOS_LCDGShowBMPPic(0, 0, "Welcome_V3.bmp");
        //EMVCL_StartIdleLEDBehavior(NULL);

		CTOS_FunRedirectSetDevice(0x01, 0x00001F00); 
		//EMVCL_StartIdleLEDBehavior(NULL);
		if(i == 0){
			CTOS_LCDGShowBMPPic(0, 0, "fs_data/Welcome_V3P.bmp");	//home/ap/pub/
			EMVCL_ShowVirtualLED(NULL);
			EMVCL_SetLED(0x0F, 0x08);
		}else{
			CTOS_LCDGShowBMPPic(0, 60, "fs_data/Welcome_V3P_420.bmp");	//home/ap/pub/
			EMVCL_SetLED(0x0F, 0x08);
		}
		
		//timer2 = time(NULL);
		//if((timer2 - timer1) >= 5){
		//	EMVCL_SetLED(0x0F, 0x08);
		//	timer1 = timer2;
		//}else{
		//	EMVCL_SetLED(0x0F, 0x00);
		//}
		
		//EMVCL_StartIdleLEDBehavior(NULL);
  
        CTOS_FunRedirectSetDevice(0x00, 0x00); 
		
        ulTxntype = 0 + g_bTxntype;

		CTOS_LCDTPrintXY(1, 8, " Enter Amount: ");
		//CTOS_LCDTPrintXY(1, 9, "   $                ");
		//CTOS_LCDTPrintXY(1, 9, "   $          0.00  ");
		if(Dollar_Sign == 1)
			CTOS_LCDTPrintXY(1, 9, "   $          0.00  ");
		else if(Dollar_Sign == 2)
			CTOS_LCDTPrintXY(1, 9, "   €         0.00  ");

        ulRtn = InputValue();
        if (ulRtn == d_NO) {
            break;
        }
		
		CTOS_LCDGShowBMPPic(0, 0, "SwipeInsertTap_V3.bmp");
        
        CTOS_FunRedirectSetDevice(0x01, 0x00001F00); 
		CTOS_LCDGShowBMPPic(0, 60, "fs_data/SwipeInsertTap_V3P_420.bmp");
		//EMVCL_ShowVirtualLED(NULL);
		EMVCL_SetLED(0x0F, 0x08);
		
        Polling_Card();
        CTOS_Delay(1000);
		
        CTOS_FunRedirectSetDevice(0x00, 0x00); 
        
		i++;
        CTOS_Delay(1000);
    }

    EMVCL_StopIdleLEDBehavior(NULL);
    EMVCL_SetLED(0x0F, 0x08);
}

void Do_Transaction(void) {

    BYTE bKey;

    while (1) {
        PageShow(d_PAGE_TRANSACTION);
next:
//        CTOS_KBDGet(&bKey);
          ForceMainDevice_KBDGet(&bKey);

        if (bKey == '1') {
            Transaction();
        } else if (bKey == '2') {
            SelectTxnType();
        } else if (bKey == '3') {
            ForedTxnOnline();
        } else if (bKey == d_KBD_CANCEL) {
            CTOS_CLPowerOff();
            break;
        } else {
            goto next;
        }
    }
}

