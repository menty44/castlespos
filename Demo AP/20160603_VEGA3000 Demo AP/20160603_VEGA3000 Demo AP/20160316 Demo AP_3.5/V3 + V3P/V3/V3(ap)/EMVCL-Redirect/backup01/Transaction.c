#include "EMV_appmain.h"
#include "emv_cl.h"
#include <ctos_clapi.h>
#include "wub_lib.h"
#include "ScreenDispaly.h"
#include "Transaction.h"
#include "debug.h"
#include "../sharedef.h"

//#include "bertlv.h"
#define _SIMULATE_ONLINE_RESULT

#define d_START_TRANS	0x00
#define d_INIT_TRANS	0x01

USHORT usTxResult;
char baInput[20];
int iLen;

STR sBuf[1024];
BYTE baTmp[5000];
BYTE baBuf[128];
BYTE baTemp[256];
BYTE baTemp2[256];
BYTE baTmp1[256];

EMVCL_ACT_DATA stACTData;
EMVCL_RC_DATA_EX stRCDataEx;
EMVCL_RC_DATA_ANALYZE stRCDataAnalyze;

int iBatchNo;

#define d_TLV_DATA_BUF_SIZE		1024
USHORT TLVDataLen;
BYTE TLVData[d_TLV_DATA_BUF_SIZE];

BYTE g_baInputCBAmt[20];
USHORT g_usCBAmtLen;
BYTE g_baInputAmt[20];
USHORT g_usAmtLen;
BYTE g_bTxntype;
ULONG ulAmt;
ULONG ulCBAmt;
BOOL g_isForcedOnl;

const BYTE baLCDLogo[]={ //Width=128, Height=142
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0xC0,0xE0,0xE0,0xE0,0xE0,0x38,0x38,0x38,0x38,0x38,0x18,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x18,0x38,0x38,0x38,0x38,0x38,0xE0,0xE0,0xE0,0xE0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0xC0,0xC0,0x70,0x70,0x38,0x38,0x0E,0x0E,0x0E,0x07,0x07,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x07,0x07,0x07,0x0E,0x0E,0x38,0x38,0x78,0x70,0xF0,0xC0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xE0,0xF0,0x70,0x1C,0x1E,0x0E,0x03,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x03,0x03,0x0E,0x1E,0x1C,0x70,0xF0,0xE0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xE0,0x38,0x1C,0x07,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xFC,0xFC,0xFC,0xFC,0xF8,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x1F,0x3C,0xF8,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xC0,0xF8,0x3C,0x1F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xFC,0xFC,0xFC,0xFC,0xF8,0xE0,0x00,0x00,0x00,0x00,0x03,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFC,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xE0,0xF8,0xF8,0x38,0xF8,0xF8,0xF8,0xE0,0xE0,0xE0,0xE0,0xE0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,0x00,0x03,0x1F,0x3C,0xF8,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0xC0,0xF8,0x3F,0x07,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xFE,0xFE,0xFE,0xF8,0xF0,0xC0,0x00,0x00,0x00,0x00,0x07,0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0xF8,0x80,0x00,0x00,0x00,0x00,0x07,0x7F,0xFF,0xFF,0xFF,0xFF,0xFE,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xFF,0xFF,0x07,0x00,0x00,0x00,0x00,0x80,0x80,0x81,0x81,0x81,0x81,0x01,0x07,0x07,0x07,0x07,0x0F,0x0F,0xFF,0xFE,0xF8,0x80,0x87,0xBF,0xF8,0xC0,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x80,0xFC,0x7F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFE,0xFE,0xFE,0xFC,0xF0,0xE0,0x00,0x00,0x00,0x01,0x0F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFE,0xE0,0x00,0x00,0x00,0x00,0x01,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x00,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFF,0x7F,0x01,0x00,0x00,0xF0,0xFC,0xFE,0x1F,0x0F,0x0F,0x0F,0x0F,0x1F,0x1E,0x7C,0xFC,0xF0,0xE0,0xE0,0xFC,0xFF,0x7F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0E,0x1E,0x1E,0x7C,0xFC,0xF0,0xE0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xE0,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xE0,0xC0,0xC0,0xC0,0xC3,0x1F,0x3F,0xFC,0xF8,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x07,0x1F,0x1F,0x3C,0xFC,0xF8,0xE0,0xE0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x1F,0xFF,0xFC,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x07,0x07,0x07,0x07,0x1F,0x1F,0x1F,0xFF,0xFF,0xFF,0xFC,0xF8,0xF8,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x07,0x1F,0x1F,0x3C,0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x1F,0xFF,0xFC,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x07,0x7F,0xF8,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x07,0x00,0x00,0x00,0x80,0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x3F,0x7F,0xF8,0xF0,0xC0,0x81,0x87,0x0F,0x3F,0x7E,0xF8,0xF0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x0F,0x7F,0xFE,0xF0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x0F,0x7F,0xF0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x03,0x03,0x03,0x01,0x00,0x00,0x00,0x00,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x03,0x00,0x00,0x00,0x00,0xE0,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0x0F,0x00,0x00,0x00,0x00,0x00,0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xFD,0xFF,0x1F,0x1F,0x1F,0x7E,0x7C,0xF0,0xE1,0xE3,0xE3,0xEF,0xFE,0xFC,0xF0,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x0F,0x1F,0xFE,0xFC,0xE0,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x03,0x07,0x3F,0xF8,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0xF8,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x07,0x00,0x00,0x00,0x00,0x00,0xE0,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x1F,0x1F,0x3C,0x3C,0xF8,0xF8,0xE0,0xE0,0xE3,0xC3,0xC3,0xC3,0xC3,0xC7,0xFF,0xFF,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x1F,0xFF,0xFC,0xE0,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x1C,0x38,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xE0,0xFB,0x3F,0x1F,0x07,0x07,0x07,0x03,0x03,0x03,0x07,0x1F,0x3F,0xFC,0xE0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x03,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x07,0x0F,0x3E,0x38,0x70,0xF0,0xC0,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x07,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0xC0,0xF0,0x70,0x38,0x3E,0x0E,0x07,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x07,0x07,0x0F,0x0F,0x0E,0x3E,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x03,0x03,0x0E,0x0E,0x1C,0x1C,0x70,0x70,0xE0,0xE0,0xE0,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0xE0,0xE0,0x70,0x70,0x7C,0x1C,0x1E,0x0E,0x0F,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x07,0x07,0x07,0x1C,0x1C,0x1C,0x1C,0x38,0x38,0x38,0x38,0x38,0x38,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0x20,0x38,0x38,0x38,0x38,0x38,0x1C,0x1C,0x1C,0x1C,0x04,0x07,0x07,0x07,0x03,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};


//------------------------------------------------------------------------------

void UnpackData(BYTE *baSBuf, UINT uiLen, BYTE *baTBuf) {
    UINT i;
    char cMe[3];

    strcpy(baTBuf, "");
    for (i = 0; i < uiLen; i++) {
        sprintf(cMe, "%02X", baSBuf[i]);
        strcat(baTBuf, cMe);
    }
}
//------------------------------------------------------------------------------

void ShowReverseLine(BYTE x, BYTE y, char *str) {
    CTOS_LCDTSetReverse(d_TRUE);
    CTOS_LCDTPrintXY(x, y, (STR *) str);
    CTOS_LCDTSetReverse(d_FALSE);
}
//------------------------------------------------------------------------------

ULONG ASCII2Int(BYTE *baSBuf, int iL) {
    unsigned long k;
    unsigned long iN;
    int i;

    iN = 0;
    k = 1;
    for (i = iL - 1; i >= 0; i--) {
        iN = (unsigned long) ((baSBuf[i] - '0') * k) + iN;
        k *= 10;
    }
    return iN;
}
//------------------------------------------------------------------------------

ULONG InputAmount(BYTE* strAmt, USHORT AmtBufSize, USHORT* usAmtLen) {
    int iX;
    int iY;
    BYTE bKey;
    USHORT tempLen = 0;
    memset(strAmt, '0', AmtBufSize);

    *usAmtLen = 0;
    iX = 1;
    iY = 4;

    while (1) {
        ForceMainDevice_KBDGet(&bKey);

        switch (bKey) {
            case d_KBD_ENTER: //Enter
                if (tempLen < 1) {
                    CTOS_Delay(100);
                    CTOS_Beep();
                    CTOS_Delay(100);
                    CTOS_Beep();
                } else {
                    if (tempLen == 1 && baInput[0] == '0') {
                        CTOS_Delay(100);
                        CTOS_Beep();
                        CTOS_Delay(100);
                        CTOS_Beep();
                        iX--;
                        TopRelative_LCDTPutchXY(iX, iY, ' ');
                        tempLen--;
                    } else {
                        strAmt[tempLen] = 0;
                        *usAmtLen = tempLen;
                        return d_OK;
                    }
                }
                break;
            case d_KBD_CANCEL: //Cancel
                tempLen = 1;
                strAmt[0] = '0';
                *usAmtLen = tempLen;
                return d_NO;

            case d_KBD_CLEAR: //Clear
                if (tempLen == 0) {
                    CTOS_Delay(100);
                    CTOS_Beep();
                    CTOS_Delay(100);
                    CTOS_Beep();
                } else {
                    iX--;
                    TopRelative_LCDTPutchXY(iX, iY, ' ');
                    tempLen--;
                }
                break;
            default:
                if ((bKey >= '0' && bKey <= '9') && tempLen < 7) {
                    TopRelative_LCDTPutchXY(iX, iY, bKey);
                    iX++;
                    strAmt[tempLen++] = bKey;
                } else {
                    CTOS_Delay(100);
                    CTOS_Beep();
                    CTOS_Delay(100);
                    CTOS_Beep();
                }
        }

    }
}
//------------------------------------------------------------------------------

ULONG InputValue(void) {
    ULONG ulRtn;

    ulRtn = 0;

    memset(g_baInputCBAmt, 0, sizeof (g_baInputCBAmt));
    memset(g_baInputAmt, 0, sizeof (g_baInputAmt));
    g_usCBAmtLen = 0;
    g_usAmtLen = 0;

    PageShow(d_PAGE_TRANSACTION_INPUT_AMOUNT);

    ulRtn = InputAmount(g_baInputAmt, sizeof (g_baInputAmt), &g_usAmtLen);
    if (ulRtn != d_OK) {
        return ulRtn;
    }

    if (g_bTxntype == 0x09) //Cash Back
    {
        PageShow(d_PAGE_TRANSACTION_INPUT_CB_AMOUNT);
        ulRtn = InputAmount(g_baInputCBAmt, sizeof (g_baInputCBAmt), &g_usCBAmtLen);
        return ulRtn;
    }

    return ulRtn;
}
//------------------------------------------------------------------------------

//USHORT CTOS_PrinterPutString(STR* baBuf) ;
//------------------------------------------------------------------------------

void PrintBlank(void) {
    CTOS_PrinterPutString("\n");
    CTOS_PrinterPutString("\n");
}
//------------------------------------------------------------------------------
#if 1

void Print_Receipt(EMVCL_RC_DATA_EX *data, BYTE isNeedSignature, ULONG ulValue) {
    //------------------------------------------------------
    //    PrintBlank();

    if (data->bSID == d_VW_SID_PAYPASS_MAG_STRIPE || data->bSID == d_VW_SID_PAYPASS_MCHIP) {
        sprintf(baBuf, "           Master PayPass");
    } else if (data->bSID == d_VW_SID_AE_EMV || data->bSID == d_VW_SID_AE_MAG_STRIPE) {
        sprintf(baBuf, "           American Express");
    } else if (data->bSID == d_VW_SID_JCB_WAVE_2 || data->bSID == d_VW_SID_JCB_WAVE_QVSDC) {
        sprintf(baBuf, "           J/Speedy");
    } else if (data->bSID == d_VW_SID_VISA_OLD_US || data->bSID == d_VW_SID_VISA_WAVE_2 || data->bSID == d_VW_SID_VISA_WAVE_QVSDC || data->bSID == d_VW_SID_VISA_WAVE_MSD) {
        sprintf(baBuf, "           Visa payWave");
    } else if (data->bSID == d_VW_DISCOVER) {
        sprintf(baBuf, "           Discover Zip");
    } else {
        sprintf(baBuf, "           Un-Know");
      
    }
        CTOS_PrinterPutString(baBuf);

    PrintBlank();

    sprintf(baBuf, "Credit Card");
    CTOS_PrinterPutString(baBuf);

    //Store ID
    sprintf(baBuf, "Store ID    :      8220101400255");
    CTOS_PrinterPutString(baBuf);

    //Terminal ID
    sprintf(baBuf, "Terminal ID :           01401493");
    CTOS_PrinterPutString(baBuf);
    CTOS_PrinterPutString("================================");

    //Card Type
    if (data->bSID == d_VW_SID_PAYPASS_MAG_STRIPE || data->bSID == d_VW_SID_PAYPASS_MCHIP) {
        sprintf(baBuf, "Card Type  : MASTER");
    } else if (data->bSID == d_VW_SID_AE_EMV || data->bSID == d_VW_SID_AE_MAG_STRIPE) {
        sprintf(baBuf, "Card Type  : AEMX");
    } else if (data->bSID == d_VW_SID_JCB_WAVE_2 || data->bSID == d_VW_SID_JCB_WAVE_QVSDC) {
        sprintf(baBuf, "Card Type  : JCB");
    } else if (data->bSID == d_VW_SID_VISA_OLD_US || data->bSID == d_VW_SID_VISA_WAVE_2 || data->bSID == d_VW_SID_VISA_WAVE_QVSDC || data->bSID == d_VW_SID_VISA_WAVE_MSD) {
        sprintf(baBuf, "Card Type  : VISA");
    } else if (data->bSID == d_VW_DISCOVER) {
        sprintf(baBuf, "Card Type  : DISCOVER");
    } else {
        sprintf(baBuf, "Card Type  : UN-KMOW");
    }
    CTOS_PrinterPutString(baBuf);
    CTOS_PrinterPutString(" ");

    //Card Number
    if (data->bSID == d_VW_SID_VISA_OLD_US || data->bSID == d_VW_SID_VISA_WAVE_2 || data->bSID == d_VW_SID_VISA_WAVE_QVSDC || data->bSID == d_VW_SID_VISA_WAVE_MSD) {
        memset(baTemp, 0x00, sizeof (baTemp));
        memset(baTemp2, 0x00, sizeof (baTemp2));
        memcpy(baTemp, &data->baTrack2Data[1], 4);
        memcpy(baTemp2, &data->baTrack2Data[13], 4);


    } else {
        UnpackData(data->baTrack2Data, 20, baTmp);
        memcpy(baTemp, baTmp, 4);
        memcpy(baTemp2, &baTmp[12], 4);
        baTemp2[16] = 0;

    }

    sprintf(baBuf, "Card Number: %s XXXX XXXX %s", baTemp, baTemp2);
    CTOS_PrinterPutString(baBuf);
    CTOS_PrinterPutString(" ");

    //Exp Date
    if (data->bSID == d_VW_SID_VISA_OLD_US || data->bSID == d_VW_SID_VISA_WAVE_2 || data->bSID == d_VW_SID_VISA_WAVE_QVSDC || data->bSID == d_VW_SID_VISA_WAVE_MSD) {
        memcpy(baTemp, &data->baTrack2Data[20], 2);
         baTemp[2] = 0;
         memcpy(baTmp1, &data->baTrack2Data[18], 2);
         baTmp1[2] = 0;


    } else {
        memcpy(baTemp, baTmp + 19, 2);
         baTemp[2] = 0;
         memcpy(baTmp1, baTmp + 17, 2);
         baTmp1[2] = 0;

    }
    
    sprintf(baBuf, "Exp Date   : %s/'%s", baTemp, baTmp1);
    CTOS_PrinterPutString(baBuf);
    CTOS_PrinterPutString(" ");

    //Trans Type
    CTOS_PrinterPutString("Trans Type : SALE");
    CTOS_PrinterPutString(" ");

    //Date
    memcpy(baTemp, data->baDateTime, 4);
    baTemp[4] = 0;
    memcpy(baTmp, data->baDateTime + 4, 2);
    baTmp[2] = 0;
    memcpy(baTmp1, data->baDateTime + 6, 2);
    baTmp1[2] = 0;
    sprintf(baBuf, "Date       : %s/%s/%s", baTemp, baTmp, baTmp1);
    //    DebugAddHEX("date:", baBuf, strlen(baBuf));
    //    CTOS_PrinterPutString(baBuf);
    //    CTOS_PrinterPutString(" ");

    //Time
    memcpy(baTemp, data->baDateTime + 8, 2);
    baTemp[2] = 0;
    memcpy(baTmp, data->baDateTime + 10, 2);
    baTmp[2] = 0;
    memcpy(baTmp1, data->baDateTime + 12, 2);
    baTmp1[2] = 0;
    sprintf(baBuf, "Time       : %s:%s:%s", baTemp, baTmp, baTmp1);
    //    DebugAddHEX("time:", baBuf, strlen(baBuf));
    //    CTOS_PrinterPutString(baBuf);
    //    CTOS_PrinterPutString(" ");

    //Auth Code
    memcpy(baTemp, data->baTrack2Data + 19, 2);
    baTemp[2] = 0;
    sprintf(baBuf, "Auth Code  : TT2738");
    CTOS_PrinterPutString(baBuf);
    CTOS_PrinterPutString(" ");

    //Batch No
    iBatchNo++;
    sprintf(baBuf, "Batch No   : %06d", iBatchNo);
    CTOS_PrinterPutString(baBuf);

    CTOS_PrinterPutString(" ");

    // AMOUNT
    sprintf(baBuf, "     AMOUNT:        $ %ld", ulValue);
    CTOS_PrinterPutString(baBuf);

    if (isNeedSignature) {
        sprintf(baBuf, "Signature  ");
        CTOS_PrinterPutString(baBuf);
        PrintBlank();
    }

    CTOS_PrinterPutString("================================");

    PrintBlank();
    PrintBlank();
}
#endif
//------------------------------------------------------------------------------

void TLVDataClear(void) {
    TLVDataLen = 0;
}
//------------------------------------------------------------------------------

void TLVDataRemove(ULONG tag) {
    WORD i;
    WORD j;
    USHORT len;
    ULONG tag_value;
    USHORT len_value;
    USHORT data_offset;
    BYTE temp[10];

    i = j = 0;
    while (i < TLVDataLen) {
        data_offset = TLV_Get_Value(&TLVData[i], &tag_value, &len_value);
        len = data_offset + len_value;
        if (tag == tag_value) {
            i += len;
            continue;
        } else {

            memcpy(&TLVData[j], &TLVData[i], len);
            j += len;
            i += len;

        }
    }

    TLVDataLen = j;
}
//------------------------------------------------------------------------------

short TLVDataAdd(ULONG tag, USHORT len, BYTE *buf) {
    USHORT i;
    BYTE str[20];
    ULONG tag_value;
    USHORT len_value;
    USHORT data_offset;
    BYTE temp[10];

    //sprintf(str, "Tag %04X ", tag);
    //DebugAddHEX(str, buf, len);

    i = 0;

    while (i < TLVDataLen) {
        data_offset = TLV_Get_Value(&TLVData[i], &tag_value, &len_value);
        if (tag == tag_value) {
            TLVDataRemove(tag);
            break;
        }

        i += (data_offset + len_value);
    }

    //Add new
    i = 0;

    if ((tag >> 16) > 0) {
        temp[i++] = (BYTE) (tag >> 16);
    }
    if ((tag >> 8) > 0) {
        temp[i++] = (BYTE) (tag >> 8);
    }
    temp[i++] = (BYTE) tag;

    if (len > 0xFF) {
        temp[i++] = 0x82;
        temp[i++] = len / 256;
        temp[i++] = len % 256;
    } else if (len > 0x7F) {
        temp[i++] = 0x81;
        temp[i++] = (BYTE) len;
    } else {
        temp[i++] = (BYTE) len;
    }

    if ((TLVDataLen + i + len) > d_TLV_DATA_BUF_SIZE) {
        return 1;
    }

    memcpy(&TLVData[TLVDataLen], temp, i);
    TLVDataLen += i;

    memcpy(&TLVData[TLVDataLen], buf, len);
    TLVDataLen += len;

    return 0;
}
//------------------------------------------------------------------------------

short TLVDataGet(ULONG tag, BYTE *buf) {
    USHORT i;
    ULONG tag_value;
    USHORT len_value;
    USHORT data_offset;

    i = 0;

    while (i < TLVDataLen) {
        data_offset = TLV_Get_Value(&TLVData[i], &tag_value, &len_value);
        if (tag == tag_value) {
            memcpy(buf, &TLVData[i + data_offset], len_value);
            return len_value;
        }

        i += (data_offset + len_value);
    }

    return 0;
}
//------------------------------------------------------------------------------

void TLVDataParse(BYTE *buf, USHORT len) {
    ULONG tag_value;
    USHORT len_value;
    USHORT i;
    USHORT offset;

    i = 0;
    while (i < len) {
        offset = TLV_Get_Value(&buf[i], &tag_value, &len_value);
        TLVDataAdd(tag_value, len_value, &buf[i + offset]);
        i += offset + len_value;
    }
}
//------------------------------------------------------------------------------

USHORT Online_Process(BYTE *baData, USHORT usDataLen) {
    BYTE baBuff[2048];
    BYTE key;
    USHORT usBuffLen;
    USHORT i;
    USHORT ret;

    //Send data to host
    usBuffLen = 0;
    baBuff[usBuffLen++] = 0x10;
    baBuff[usBuffLen++] = 0x02;
    for (i = 0; i < usDataLen; i++) {
        baBuff[usBuffLen++] = baData[i];
        if (baData[i] == 0x10) {
            baBuff[usBuffLen++] = baData[i];
        }
    }
    baBuff[usBuffLen++] = 0x00; //Ignore LRC check
    baBuff[usBuffLen++] = 0x10;
    baBuff[usBuffLen++] = 0x03;

    __DebugAddHEX("Data to Host", baBuff, usBuffLen);

    //Receive Response
    do {
#ifdef _SIMULATE_ONLINE_RESULT
//        ForceMainDevice_KBDHit(&key);
        key = '1';

        if (key == '1') {
            ret = d_EMVCL_OUTCOME_APPROVAL;
            break;
        } else if (key == '2') {
            ret = d_EMVCL_OUTCOME_DECLINED;
            break;
        }
#else

        i = sizeof (baBuff);
        if (CTOS_RS232RxData(d_COM1, baBuff, &i) == d_OK && i > 0) {
            if (baBuff[0] == '1') {
                ret = d_EMV_CHIP_ONL_APPROVAL;
            } else {
                ret = d_EMV_CHIP_ONL_DECLINED;
            }
            break;
        }

        ForceMainDevice_KBDHit(&key);

#endif 

    } while (key != d_KBD_CANCEL);

    if (key == d_KBD_CANCEL) {
        ret = d_EMVCL_OUTCOME_DECLINED;
    }

    return ret;
}
//------------------------------------------------------------------------------
//	x: X position
//	y: Y position
//	min: Minimum length of the input data
//	max: Maximum length of the input data
//	mask: If maskchar = 0, don't need mask char, if > 0, it will show to screen.

char Get_PIN_Input(BYTE x, BYTE y, BYTE min, BYTE max, char mask, char *buf, BYTE *len) {
    BYTE ilen;
    BYTE c[2];

    //CTOS_LCDTGotoXY(x, y);

    ilen = 0;
    c[1] = 0; //NULL

    while (TRUE) {
        ForceMainDevice_KBDGet(c);

        if (c[0] >= '0' && c[0] <= '9') //0-9
        {
            if (x <= 16 && ilen < max) {
                buf[ilen++] = c[0];
                if (mask == 0)
                    TopRelative_LCDTPutchXY(x, y, c[0]);
                else
                    TopRelative_LCDTPutchXY(x, y, mask);

                x++;
            }
        } else if (c[0] == d_KBD_CLEAR) //clear
        {
            if (ilen > 0) {
                ilen--;
                x--;
                TopRelative_LCDTPutchXY(x, y, ' ');
            }
        } else if (c[0] == d_KBD_CANCEL) //cancel
        {
            return FALSE;
        } else if (c[0] == d_KBD_ENTER && ilen >= min) //enter
        {
            *len = ilen;
            buf[ilen] = 0x00; //put end of string
            return TRUE;
        }
    }
}
//------------------------------------------------------------------------------

void StartTrans(BYTE bType) {
    BYTE bKey;
    BYTE is_online_request;
    BYTE NeedSignature;
    BYTE temp[20];
    BYTE upload_tx_buf[1024];
    USHORT upload_tx_len;
    BYTE pin[20];
    BYTE pin_len;
    ULONG ulAPRtn;
    BYTE *msg;
    BYTE *CVMStr;
    BYTE TransaRelatedData[100];
    BYTE lenn;

    BYTE bAction;
    BYTE baARC[2];
    UINT uiIADLen;
    BYTE baIAD[128];
    UINT uiScriptLen;
    BYTE baScript[256];
    ULONG ulScheme;
    ULONG ulValue;

    __DebugAddINT("               ", 0);
    __DebugAddINT("               ", 0);

    // amount - ascii to int
    ulAmt = ASCII2Int(g_baInputAmt, g_usAmtLen);
    ulCBAmt = ASCII2Int(g_baInputCBAmt, g_usCBAmtLen);
    ulAmt += ulCBAmt;


    sprintf(temp, " Amount:$%ld", ulAmt);
    PageSetString(1, temp);
    PageShow(d_PAGE_TRANSACTION_PRESENT_CARD);


//    EMVCL_ShowContactlessSymbol(NULL);
//    CTOS_LCDGShowPic(95,105,(BYTE *)baLCDLogo,sizeof(baLCDLogo),142);
    CTOS_LCDGShowPic(95,125,(BYTE *)baLCDLogo,sizeof(baLCDLogo),142);

    memset(&stACTData, 0, sizeof (EMVCL_ACT_DATA));
    memset(&stRCDataEx, 0, sizeof (EMVCL_RC_DATA_EX));
    memset(&stRCDataAnalyze, 0, sizeof (EMVCL_RC_DATA_ANALYZE));


    // perform transaction : EMVCL_StartTransactionEx
    stACTData.bStart = d_EMVCL_ACT_DATA_START_A;
    stACTData.bTagNum = 0;
    stACTData.usTransactionDataLen = 0;

    //Put 0x9F02 Amount, Authorized (Numeric)
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x9F;
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x02;
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x06;
    wub_long_2_bcd(ulAmt, temp, &lenn);
    memset(&TransaRelatedData[stACTData.usTransactionDataLen], 0, 6);
    memcpy(&TransaRelatedData[stACTData.usTransactionDataLen + 6 - lenn], temp, lenn);
    stACTData.usTransactionDataLen += 6;
    stACTData.bTagNum++;

    //Put 0x9F03
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x9F;
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x03;
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x06;
    wub_long_2_bcd(ulCBAmt, temp, &lenn);
    memset(&TransaRelatedData[stACTData.usTransactionDataLen], 0, 6);
    memcpy(&TransaRelatedData[stACTData.usTransactionDataLen + 6 - lenn], temp, lenn);

    stACTData.usTransactionDataLen += 6;
    stACTData.bTagNum++;

    //Put 0x9C
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x9C;
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x01;
    TransaRelatedData[stACTData.usTransactionDataLen++] = g_bTxntype;
    stACTData.bTagNum++;

    if (g_isForcedOnl == TRUE) {
        TransaRelatedData[stACTData.usTransactionDataLen++] = 0xDF;
        TransaRelatedData[stACTData.usTransactionDataLen++] = 0x9F;
        TransaRelatedData[stACTData.usTransactionDataLen++] = 0x01;
        TransaRelatedData[stACTData.usTransactionDataLen++] = 0x01;
        TransaRelatedData[stACTData.usTransactionDataLen++] = 0x01;
        stACTData.bTagNum++;
    }

    __DebugAddHEX("In Data", TransaRelatedData, stACTData.usTransactionDataLen);

    stACTData.pbaTransactionData = TransaRelatedData;

    if (bType == d_INIT_TRANS) {
        EMVCL_InitTransactionEx(stACTData.bTagNum, stACTData.pbaTransactionData, stACTData.usTransactionDataLen);

        do {
            ulAPRtn = EMVCL_PerformTransactionEx(&stRCDataEx);
            ForceMainDevice_KBDHit(&bKey);
            if (bKey == d_KBD_CANCEL) break;

            if (ulAPRtn == d_EMVCL_TX_CANCEL) {
                return;
            } else if (ulAPRtn == 0xA00000E0) {

            } else if (ulAPRtn != d_EMVCL_PENDING) {
                break;
            }
        } while (1);
    } else {
        __DebugAddSTR("Go EMVCL_StartTransactionEx");
        ulAPRtn = EMVCL_StartTransactionEx(&stACTData, &stRCDataEx);
        if (ulAPRtn == d_EMVCL_TX_CANCEL) {
            return;
        }
    }


    __DebugAddINT("TestPerform rtn", ulAPRtn);
    __DebugAddINT("SID", stRCDataEx.bSID);
    __DebugAddSTR(stRCDataEx.baDateTime);
    __DebugAddHEX("SCData Track1", stRCDataEx.baTrack1Data, stRCDataEx.bTrack1Len);
    __DebugAddHEX("SCData Track2", stRCDataEx.baTrack2Data, stRCDataEx.bTrack2Len);
    //DebugAddSTR(stRCDataEx.baTrack1Data);
    //DebugAddSTR(stR__DebugAddHEX("SCData Chip", stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
    __DebugAddHEX("SCData Additional", stRCDataEx.baAdditionalData, stRCDataEx.usAdditionalDataLen); //stRCDataEx.baTrack2Data);
    __DebugAddHEX("SCData baChipData", stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
    //	Show_TLV_Data("SCData Chip:", stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
    //	Show_TLV_Data("SCData Additional:", stRCDataEx.baAdditionalData, stRCDataEx.usAdditionalDataLen);

    PageClean();

    if (ulAPRtn != d_EMVCL_RC_DATA) {
        PageSetParameter(1, &ulAPRtn);
        PageShow(d_PAGE_TRANSACTION_NO_CARD_AND_USE_OTHER_CARD);
        ForceMainDevice_KBDGet(&bKey);
        return;
    }


    //Parse transaction response data	
    //Parse Scheme ID
    ulScheme = 0 + stRCDataEx.bSID;
    PageSetParameter(1, &ulScheme);
    //CTOS_LCDTPrintXY(1, 4, msg);

    //Parse received chip and additional data 
    TLVDataClear();
    TLVDataParse(stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
    TLVDataParse(stRCDataEx.baAdditionalData, stRCDataEx.usAdditionalDataLen);

    EMVCL_AnalyzeTransactionEx(&stRCDataEx, &stRCDataAnalyze);

    //After parsing transaction data, check if CVM is need and get the transaction result	
    //CVM Require - If Card need CVM, performing CVM at this moment
    NeedSignature = FALSE;
    CVMStr = "                ";

    if (stRCDataAnalyze.bCVMAnalysis == d_EMVCL_CVM_REQUIRED_SIGNATURE) {
        CVMStr = "CVM->Signature";
        NeedSignature = TRUE;
    } else if (stRCDataAnalyze.bCVMAnalysis == d_EMVCL_CVM_REQUIRED_ONLPIN) {
        CVMStr = "CVM->PIN";
        PageClean();

        PageShow(d_PAGE_TRANSACTION_ENTER_ONLINE_PIN);

        if (Get_PIN_Input(1, 2, 4, 16, '*', pin, &pin_len) == FALSE) {
            PageShow(d_PAGE_TRANSACTION_PIN_BY_PASS);
        }

        //set TVR byte 3 if need
        //ex : TLVDataGet(0x95, temp);
        // temp[2] |= 0x04;
        //TLVDataAdd(0x95, 5, temp);
    } else if (stRCDataAnalyze.bCVMAnalysis == d_EMVCL_CVM_REQUIRED_NOCVM) {
        CVMStr = "CVM->No CVM Req";
    }

    usTxResult = stRCDataAnalyze.usTransResult;
    __DebugAddINT("Transaction Result", usTxResult);


    PageShow(d_PAGE_TRANSACTION_SHOW_SCHEME_ID);

    is_online_request = FALSE;

    //Online
    if (usTxResult == d_EMVCL_OUTCOME_ONL) {
        is_online_request = TRUE;
        PageShow(d_PAGE_TRANSACTION_OUTCOME_GO_ONL);
    }//Offline Approval
    else if (usTxResult == d_EMVCL_OUTCOME_APPROVAL) {
        //        sprintf(temp, " Amount $ %ld", ulValue);

        sprintf(temp, " Amount $ %ld", ulAmt);
        PageSetString(1, temp);
        PageSetString(2, CVMStr);
        PageShow(d_PAGE_TRANSACTION_OUTCOME_OFFLINE_APPROVAL);

    }//Offline Declined
    else if (usTxResult == d_EMVCL_OUTCOME_DECLINED) {
        PageSetString(1, CVMStr);
        PageShow(d_PAGE_TRANSACTION_OUTCOME_OFFLINE_DECLINED);
    } else {
        PageShow(d_PAGE_TRANSACTION_OUTCOME_UNKNOWN);
        ForceMainDevice_KBDGet(&bKey);
        return;
    }

    //Online : send online data to host for online authrn.
    if (is_online_request == TRUE) {
        //Rrepare Upload Data to host
        upload_tx_len = 0;

        upload_tx_buf[upload_tx_len++] = 14;
        memcpy(&upload_tx_buf[upload_tx_len], stRCDataEx.baDateTime, 14);
        upload_tx_len += 14;

        upload_tx_buf[upload_tx_len++] = stRCDataEx.bTrack1Len;
        memcpy(&upload_tx_buf[upload_tx_len], stRCDataEx.baTrack1Data, stRCDataEx.bTrack1Len);
        upload_tx_len += stRCDataEx.bTrack1Len;

        upload_tx_buf[upload_tx_len++] = stRCDataEx.bTrack2Len;
        memcpy(&upload_tx_buf[upload_tx_len], stRCDataEx.baTrack2Data, stRCDataEx.bTrack2Len);
        upload_tx_len += stRCDataEx.bTrack2Len;

        upload_tx_buf[upload_tx_len++] = stRCDataEx.usChipDataLen / 256;
        upload_tx_buf[upload_tx_len++] = stRCDataEx.usChipDataLen % 256;
        memcpy(&upload_tx_buf[upload_tx_len], stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
        upload_tx_len += stRCDataEx.usChipDataLen;

        upload_tx_buf[upload_tx_len++] = stRCDataEx.usAdditionalDataLen / 256;
        upload_tx_buf[upload_tx_len++] = stRCDataEx.usAdditionalDataLen % 256;
        memcpy(&upload_tx_buf[upload_tx_len], stRCDataEx.baAdditionalData, stRCDataEx.usAdditionalDataLen);
        upload_tx_len += stRCDataEx.usAdditionalDataLen;

        //send upload data and get the online authen result
        usTxResult = Online_Process(upload_tx_buf, upload_tx_len);

#if 0
        //CTOS_Delay(3000);

        bAction = 0x01;
        memcpy(baARC, "00", 2);
        //uiIADLen = 0;
        uiIADLen = 10;
        memcpy(baIAD, "\x11\x22\x33\x44\x55\x66\x77\x88\x30\x30", 10);
        //uiScriptLen = 0;
        uiScriptLen = 35;
        memcpy(baScript, "\x72\x21\x9F\x18\x04\x11\x22\x33\x44\x86\x0D\x84\x24\x00\x00\x08\xAA\xBB\xCC\xDD\x11\x22\x33\x44\x86\x09\x84\x24\x00\x00\x04\x55\x66\x77\x88", 35);

        ulAPRtn = EMVCL_CompleteEx(bAction, baARC, uiIADLen, baIAD, uiScriptLen, baScript, &stRCDataEx);

        __DebugAddINT("complete rtn", ulAPRtn);
        __DebugAddINT("c SID", stRCDataEx.bSID);
        __DebugAddSTR(stRCDataEx.baDateTime);
        __DebugAddHEX("c SCData Track1", stRCDataEx.baTrack1Data, stRCDataEx.bTrack1Len);
        __DebugAddHEX("c SCData Track2", stRCDataEx.baTrack2Data, stRCDataEx.bTrack2Len);
        //DebugAddSTR(stRCDataEx.baTrack1Data);
        //DebugAddSTR(stRCDataEx.baTrack2Data);
        __DebugAddHEX("c SCData Chip", stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
        __DebugAddHEX("c SCData Additional", stRCDataEx.baAdditionalData, stRCDataEx.usAdditionalDataLen);
#endif

        //Online Approval
        if (usTxResult == d_EMVCL_OUTCOME_APPROVAL) {
            //            sprintf(temp, " Amount $ %ld", ulValue);
            sprintf(temp, " Amount $ %ld", ulAmt);
            PageSetString(1, temp);
            PageSetString(2, CVMStr);
            PageShow(d_PAGE_TRANSACTION_OUTCOME_ONLINE_APPROVAL);
        }//Online Declined
        else {
            PageSetString(1, CVMStr);
            PageShow(d_PAGE_TRANSACTION_OUTCOME_ONLINE_DECLINED);
        }
    }

    Print_Receipt(&stRCDataEx, NeedSignature, ulAmt);

    return;
}
//------------------------------------------------------------------------------

void SelectTxnType(void) {
    BYTE bKey;

    PageShow(d_PAGE_TRANSACTION_SELECT_TYPE);

    do {
        ForceMainDevice_KBDGet(&bKey);

        switch (bKey) {
            case d_KBD_1: //Purchase
                g_bTxntype = 0x00;
                break;
            case d_KBD_2: //Cash
                g_bTxntype = 0x01;
                break;
            case d_KBD_3: //Cash Back
                g_bTxntype = 0x09;
                break;
            case d_KBD_4: //Refund
                g_bTxntype = 0x20;
                break;
            case d_KBD_CANCEL: //Cancel
                return;
            default:
                continue;
        }

    } while (0);

    PageShow(d_PAGE_TRANSACTION_SELECT_TYPE_SET_OK);

    CTOS_Delay(500);
}
//------------------------------------------------------------------------------

void ForedTxnOnline(void) {
    BYTE bKey;

    PageShow(d_PAGE_TRANSACTION_FORCE_ONLINE);

    do {
        if (g_isForcedOnl == TRUE) {
            TopRelative_LCDTPrintXY(1, 2, "States : [Y]");
        } else {
            TopRelative_LCDTPrintXY(1, 2, "States : [N]");
        }
        ForceMainDevice_KBDGet(&bKey);

        switch (bKey) {
            case d_KBD_1:
                g_isForcedOnl = !g_isForcedOnl;
                break;
            case d_KBD_CANCEL: //Cancel
                return;
            default:
                continue;
        }

    } while (1);

    //CTOS_LCDTPrintXY(1, 8, "4. Set OK!!");
    //CTOS_Delay(500);
}
//------------------------------------------------------------------------------

void Transaction(void) {
    ULONG ulRtn;
    ULONG ulTxntype;
    BYTE *pstr;

    //Perform Transaction via Transaction APIs	
    iBatchNo = 0;
    while (1) {
        PageClean();
        EMVCL_StartIdleLEDBehavior(NULL);

        ulTxntype = 0 + g_bTxntype;
        PageSetParameter(1, &ulTxntype);
        PageShow(d_PAGE_TRANSACTION_CL_TRNSACTION);
        ulRtn = InputValue();
        if (ulRtn == d_NO) {
            break;
        }

        //If the mutual authen was ok, start a transaction.
        StartTrans(d_START_TRANS);
        //StartTrans(d_INIT_TRANS);

        CTOS_Delay(1000);
    }

    EMVCL_StopIdleLEDBehavior(NULL);
    EMVCL_SetLED(0x0F, 0x08);
}

void Do_Transaction(void) {

    BYTE bKey;

    while (1) {
        PageShow(d_PAGE_TRANSACTION);
next:
        ForceMainDevice_KBDGet(&bKey);

        if (bKey == '1') {
            Transaction();
        } else if (bKey == '2') {
            SelectTxnType();
        } else if (bKey == '3') {
            ForedTxnOnline();
        } else if (bKey == d_KBD_CANCEL) {
            CTOS_CLPowerOff();
            break;
        } else {
            goto next;
        }
    }
}

