#include "appmain.h"
#include "emv_cl.h"
#include <ctos_clapi.h>
#include "wub_lib.h"
#include "ScreenDispaly.h"
#include "Transaction.h"
#include "debug.h"
#include <emvaplib.h>
#include <emvlib.h>
#include <fcntl.h>
#include <linux/input.h>
#include <unistd.h>
#include <time.h>

#define _SIMULATE_ONLINE_RESULT

#define SignBMPFile "Signature.bmp"
#define MonoSignBMPFileName "Signature_Mono"
BYTE	MonoSignBMPFile[32];

#define d_START_TRANS	0x00
#define d_INIT_TRANS	0x01

EMVCL_INIT_DATA emvcl_initdat;

USHORT  usTxResult;
char    baInput[20];
int     iLen;

STR sBuf[1024];
BYTE baTmp[5000];
BYTE baBuf[128];
BYTE baTemp[256];
BYTE baTemp2[256];
BYTE baTmp1[256];

EMVCL_ACT_DATA stACTData;
EMVCL_RC_DATA_EX stRCDataEx;
EMVCL_RC_DATA_ANALYZE stRCDataAnalyze;

#define d_TLV_DATA_BUF_SIZE		1024
USHORT TLVDataLen;
BYTE TLVData[d_TLV_DATA_BUF_SIZE];

BYTE    g_baInputCBAmt[20];
USHORT  g_usCBAmtLen;
BYTE    g_baInputAmt[20];
USHORT  g_usAmtLen;
BYTE    g_bTxntype;
ULONG   ulAmt;
ULONG   ulCBAmt;
BOOL    g_isForcedOnl;

//Qt Simu
int     fd;
BYTE    str[256];
int     iX,iY;
int     temp_iX,temp_iY;
//BYTE    SignatureCanvas[320 * (480/8)];
BYTE    SignatureCanvas[180 * 320];

extern void Wave2TransactionEnable(void);
USHORT EMVPolling(ULONG ul);
//------------------------------------------------------------------------------

const BYTE baLCDLogo[]={ //Width=128, Height=142
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0xC0,0xE0,0xE0,0xE0,0xE0,0x38,0x38,0x38,0x38,0x38,0x18,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x18,0x38,0x38,0x38,0x38,0x38,0xE0,0xE0,0xE0,0xE0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0xC0,0xC0,0x70,0x70,0x38,0x38,0x0E,0x0E,0x0E,0x07,0x07,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x07,0x07,0x07,0x0E,0x0E,0x38,0x38,0x78,0x70,0xF0,0xC0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xE0,0xF0,0x70,0x1C,0x1E,0x0E,0x03,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x03,0x03,0x0E,0x1E,0x1C,0x70,0xF0,0xE0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xE0,0x38,0x1C,0x07,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xFC,0xFC,0xFC,0xFC,0xF8,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x1F,0x3C,0xF8,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xC0,0xF8,0x3C,0x1F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xFC,0xFC,0xFC,0xFC,0xF8,0xE0,0x00,0x00,0x00,0x00,0x03,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFC,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xE0,0xF8,0xF8,0x38,0xF8,0xF8,0xF8,0xE0,0xE0,0xE0,0xE0,0xE0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,0x00,0x03,0x1F,0x3C,0xF8,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0xC0,0xF8,0x3F,0x07,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xFE,0xFE,0xFE,0xF8,0xF0,0xC0,0x00,0x00,0x00,0x00,0x07,0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0xF8,0x80,0x00,0x00,0x00,0x00,0x07,0x7F,0xFF,0xFF,0xFF,0xFF,0xFE,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xFF,0xFF,0x07,0x00,0x00,0x00,0x00,0x80,0x80,0x81,0x81,0x81,0x81,0x01,0x07,0x07,0x07,0x07,0x0F,0x0F,0xFF,0xFE,0xF8,0x80,0x87,0xBF,0xF8,0xC0,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x80,0xFC,0x7F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFE,0xFE,0xFE,0xFC,0xF0,0xE0,0x00,0x00,0x00,0x01,0x0F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFE,0xE0,0x00,0x00,0x00,0x00,0x01,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x00,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFF,0x7F,0x01,0x00,0x00,0xF0,0xFC,0xFE,0x1F,0x0F,0x0F,0x0F,0x0F,0x1F,0x1E,0x7C,0xFC,0xF0,0xE0,0xE0,0xFC,0xFF,0x7F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0E,0x1E,0x1E,0x7C,0xFC,0xF0,0xE0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xE0,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xE0,0xC0,0xC0,0xC0,0xC3,0x1F,0x3F,0xFC,0xF8,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x07,0x1F,0x1F,0x3C,0xFC,0xF8,0xE0,0xE0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x1F,0xFF,0xFC,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x07,0x07,0x07,0x07,0x1F,0x1F,0x1F,0xFF,0xFF,0xFF,0xFC,0xF8,0xF8,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x07,0x1F,0x1F,0x3C,0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x1F,0xFF,0xFC,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x07,0x7F,0xF8,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x07,0x00,0x00,0x00,0x80,0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x3F,0x7F,0xF8,0xF0,0xC0,0x81,0x87,0x0F,0x3F,0x7E,0xF8,0xF0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x0F,0x7F,0xFE,0xF0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x0F,0x7F,0xF0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x03,0x03,0x03,0x01,0x00,0x00,0x00,0x00,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x03,0x00,0x00,0x00,0x00,0xE0,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0x0F,0x00,0x00,0x00,0x00,0x00,0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xFD,0xFF,0x1F,0x1F,0x1F,0x7E,0x7C,0xF0,0xE1,0xE3,0xE3,0xEF,0xFE,0xFC,0xF0,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x0F,0x1F,0xFE,0xFC,0xE0,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x03,0x07,0x3F,0xF8,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0xF8,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x07,0x00,0x00,0x00,0x00,0x00,0xE0,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x1F,0x1F,0x3C,0x3C,0xF8,0xF8,0xE0,0xE0,0xE3,0xC3,0xC3,0xC3,0xC3,0xC7,0xFF,0xFF,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x1F,0xFF,0xFC,0xE0,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x1C,0x38,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xE0,0xFB,0x3F,0x1F,0x07,0x07,0x07,0x03,0x03,0x03,0x07,0x1F,0x3F,0xFC,0xE0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x03,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x07,0x0F,0x3E,0x38,0x70,0xF0,0xC0,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x07,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0xC0,0xF0,0x70,0x38,0x3E,0x0E,0x07,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x07,0x07,0x0F,0x0F,0x0E,0x3E,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x03,0x03,0x0E,0x0E,0x1C,0x1C,0x70,0x70,0xE0,0xE0,0xE0,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0xE0,0xE0,0x70,0x70,0x7C,0x1C,0x1E,0x0E,0x0F,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x07,0x07,0x07,0x1C,0x1C,0x1C,0x1C,0x38,0x38,0x38,0x38,0x38,0x38,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0x20,0x38,0x38,0x38,0x38,0x38,0x1C,0x1C,0x1C,0x1C,0x04,0x07,0x07,0x07,0x03,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

//------------------------------------------------------------------------------

ULONG InputAmount(BYTE* strAmt, USHORT AmtBufSize, USHORT* usAmtLen) {
    int iX;
    int iY;
    BYTE bKey;
    USHORT tempLen = 0;
    memset(strAmt, '0', AmtBufSize);

    *usAmtLen = 0;
    iX = 1;
    iY = 5;

    while (1) {
        CTOS_KBDGet(&bKey);

        switch (bKey) {
            case d_KBD_ENTER: //Enter
                if (tempLen < 1) {
                    CTOS_Delay(100);
                    CTOS_Beep();
                    CTOS_Delay(100);
                    CTOS_Beep();
                } else {
                    if (tempLen == 1 && baInput[0] == '0') {
                        CTOS_Delay(100);
                        CTOS_Beep();
                        CTOS_Delay(100);
                        CTOS_Beep();
                        iX--;
                        TopRelative_LCDTPutchXY(iX, iY, ' ');
                        tempLen--;
                    } else {
                        strAmt[tempLen] = 0;
                        *usAmtLen = tempLen;
                        return d_OK;
                    }
                }
                break;
            case d_KBD_CANCEL: //Cancel
                tempLen = 1;
                strAmt[0] = '0';
                *usAmtLen = tempLen;
                return d_NO;

            case d_KBD_CLEAR: //Clear
                if (tempLen == 0) {
                    CTOS_Delay(100);
                    CTOS_Beep();
                    CTOS_Delay(100);
                    CTOS_Beep();
                } else {
                    iX--;
                    TopRelative_LCDTPutchXY(iX, iY, ' ');
                    tempLen--;
                }
                break;
            default:
                if ((bKey >= '0' && bKey <= '9') && tempLen < 7) {
                    TopRelative_LCDTPutchXY(iX, iY, bKey);
                    iX++;
                    strAmt[tempLen++] = bKey;
                } else {
                    CTOS_Delay(100);
                    CTOS_Beep();
                    CTOS_Delay(100);
                    CTOS_Beep();
                }
        }

    }
}
//------------------------------------------------------------------------------

ULONG InputValue(void) {
    ULONG ulRtn;

    ulRtn = 0;

    memset(g_baInputCBAmt, 0, sizeof (g_baInputCBAmt));
    memset(g_baInputAmt, 0, sizeof (g_baInputAmt));
    g_usCBAmtLen = 0;
    g_usAmtLen = 0;

    PageShow(d_PAGE_TRANSACTION_INPUT_AMOUNT);

    ulRtn = InputAmount(g_baInputAmt, sizeof (g_baInputAmt), &g_usAmtLen);
    if (ulRtn != d_OK) {
        return ulRtn;
    }

    if (g_bTxntype == 0x09) //Cash Back
    {
        PageShow(d_PAGE_TRANSACTION_INPUT_CB_AMOUNT);
        ulRtn = InputAmount(g_baInputCBAmt, sizeof (g_baInputCBAmt), &g_usCBAmtLen);
        return ulRtn;
    }

    return ulRtn;
}
//------------------------------------------------------------------------------
void UnpackData(BYTE *baSBuf, UINT uiLen, BYTE *baTBuf) {
    UINT i;
    char cMe[3];

    strcpy(baTBuf, "");
    for (i = 0; i < uiLen; i++) {
        sprintf(cMe, "%02X", baSBuf[i]);
        strcat(baTBuf, cMe);
    }
}
//------------------------------------------------------------------------------

static const BYTE baPrinterBufferLogo_Receipt2[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0xC0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF8,
    0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0x78, 0x78, 0x7C, 0x78, 0x78, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8,
    0xF8, 0xF0, 0xF0, 0xF0, 0xE0, 0xE0, 0xC0, 0xC0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0xF8, 0xFE, 0xFF, 0xFF, 0xFC, 0xF8,
    0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x80, 0x80,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0, 0xF8,
    0xF8, 0xFC, 0x7E, 0x3F, 0x1F, 0x1F, 0x0F, 0x07, 0x07, 0x87, 0x83, 0xC3, 0xC1, 0xE1, 0xE1, 0xE0,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0,
    0xE0, 0xE1, 0xC1, 0xC1, 0x83, 0x83, 0x07, 0x07, 0x0F, 0x1F, 0x1F, 0x3F, 0x7E, 0xFC, 0xFC, 0xF8,
    0xF0, 0xE0, 0xC0, 0x80, 0x80, 0xE0, 0xF8, 0xFE, 0xFF, 0xFF, 0x3F, 0x0F, 0x07, 0x03, 0x07, 0x1F,
    0x3F, 0xFF, 0xFF, 0xFC, 0xF0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0xF8, 0xFC,
    0xFE, 0xFF, 0xFF, 0x7F, 0x3F, 0x1F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x1F, 0x3F, 0x7F, 0xFF,
    0xFF, 0xFF, 0xFE, 0xFC, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xE0, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF8,
    0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0,
    0xF8, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x1F, 0x3F,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xF8, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x0F, 0x0F,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
    0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0x1F,
    0x1F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x1F, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xF8, 0xE0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xE0, 0xF8, 0xFC, 0xFF, 0x7F, 0x3F, 0x0F, 0x07, 0x03,
    0x01, 0xC0, 0xE0, 0xF0, 0xF8, 0xFC, 0xFE, 0x7E, 0x3F, 0x1F, 0x0F, 0x0F, 0x07, 0x07, 0x03, 0x83,
    0x83, 0xC1, 0xC1, 0xC1, 0xC1, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE1, 0xC1, 0xC1, 0xC1, 0x81, 0x83,
    0x03, 0x07, 0x07, 0x07, 0x0F, 0x1F, 0x3F, 0x7F, 0xFE, 0xFC, 0xF8, 0xF0, 0xE0, 0xC0, 0x81, 0x03,
    0xC7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x0F, 0x03, 0x00, 0x80, 0xE0, 0xF0, 0xF8, 0xE0, 0xC0,
    0x00, 0x00, 0x03, 0x07, 0x1F, 0x7F, 0xFF, 0xFE, 0xFC, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
    0x03, 0x03, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xC0, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x01, 0x00, 0x07, 0x3F, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFE, 0xF0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03,
    0x1F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFE, 0xFC, 0xF8, 0xF8, 0xF8, 0xF8, 0xF0, 0xF0, 0xF0, 0xE0,
    0xE1, 0xC1, 0xC1, 0x81, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFE,
    0xFC, 0xF8, 0xF8, 0xF8, 0xF8, 0xF0, 0xF0, 0xF0, 0xE0, 0xE0, 0xE1, 0xC1, 0x81, 0x81, 0x01, 0x01,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xC0, 0xF8, 0xFE, 0xFF, 0xFF, 0x3F, 0x07, 0x01, 0x00, 0x00, 0xE0, 0xF8, 0xFE,
    0xFF, 0xFF, 0x3F, 0x0F, 0x03, 0x01, 0x00, 0x80, 0xE0, 0xF0, 0xF8, 0xFC, 0xFE, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x7F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFE, 0xFE, 0xFC, 0xF8, 0xE0, 0xC0, 0x00, 0x01, 0x03, 0x0F, 0xDF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x1F, 0x0F, 0x03, 0x00, 0x80, 0xE0, 0xF8, 0xFC, 0xFF, 0xFF, 0x3F, 0x1F, 0x7F, 0xFF,
    0xFF, 0xFC, 0xF0, 0xE0, 0x80, 0x00, 0x01, 0x03, 0x0F, 0x1F, 0x7F, 0xFF, 0xFE, 0xF8, 0xE0, 0xC0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
    0xE0, 0xC0, 0xC0, 0xC0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xF0,
    0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF7, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF1, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC1, 0x01, 0x03, 0x03, 0x03, 0x07, 0x07, 0x07, 0x0F, 0x0F, 0x0F, 0x1F,
    0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x03,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC1, 0x01, 0x03,
    0x03, 0x03, 0x07, 0x07, 0x07, 0x0F, 0x0F, 0x0F, 0x1F, 0x1F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC,
    0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0xFF, 0xFF, 0xFF,
    0x0F, 0x00, 0x00, 0x00, 0x00, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xC1, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC1, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xFE, 0xFF, 0xFF, 0x7F, 0x1F, 0x07,
    0x01, 0x00, 0x80, 0xE0, 0xF8, 0xFE, 0xFF, 0x7F, 0x3F, 0x0F, 0x03, 0x00, 0x80, 0x80, 0x00, 0x00,
    0x03, 0x07, 0x1F, 0x7F, 0xFF, 0xFE, 0xFC, 0xF0, 0xC0, 0x80, 0x00, 0x01, 0x07, 0x1F, 0x3F, 0xFF,
    0xFF, 0xFC, 0xF0, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x3F, 0x7F,
    0xFF, 0xFF, 0xFF, 0xFC, 0xF8, 0xF0, 0xF0, 0xE0, 0xE0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF8, 0xFE, 0xFF,
    0xFF, 0xFF, 0x7F, 0x3F, 0x0F, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xFC, 0xFF, 0xFF,
    0xFF, 0xFF, 0x7F, 0x0F, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF8, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F,
    0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFE, 0xF8, 0xF0, 0xF0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xF0, 0xF0,
    0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x1F, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
    0xF0, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
    0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFE, 0xFC,
    0xF0, 0xF0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF8, 0xFE, 0xFF, 0xFF, 0xFF, 0x7F, 0x1F,
    0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0x00, 0x00, 0x00, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF,
    0xE0, 0x00, 0x00, 0x00, 0x00, 0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x1F, 0x07, 0x01, 0x00, 0x80, 0xE0,
    0xF8, 0xFE, 0xFF, 0x7F, 0x1F, 0x07, 0x03, 0x00, 0x00, 0xE0, 0xF8, 0xFE, 0xFF, 0xFF, 0xFE, 0xF8,
    0xF0, 0xC0, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x3F, 0x7F, 0xFF, 0xFE, 0xF8, 0xF0, 0xC0, 0x00, 0x00,
    0x03, 0x07, 0x1F, 0x7F, 0xFF, 0xFE, 0xFC, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x01, 0x01, 0x03, 0x03, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x03, 0x03, 0x03,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x03, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x03, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x03, 0x1F, 0xFF, 0xFF, 0xFF, 0xFC, 0xE0, 0x80, 0x00, 0x00, 0x07, 0x1F, 0x7F,
    0xFF, 0xFF, 0xF8, 0xF0, 0xC0, 0x80, 0x00, 0x03, 0x07, 0x1F, 0x3F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 0x1F, 0x0F, 0x03, 0x00, 0x00, 0xC0, 0xE0, 0xF8, 0xFE, 0xFF, 0x3F,
    0x1F, 0x07, 0x01, 0x00, 0x00, 0xC0, 0xF0, 0xFE, 0xFF, 0xFF, 0x3F, 0x0F, 0x03, 0x01, 0x07, 0x0F,
    0x3F, 0x7F, 0xFF, 0xFE, 0xF8, 0xE0, 0xC0, 0x00, 0x00, 0x01, 0x07, 0x0F, 0x3F, 0xFF, 0xFF, 0xFE,
    0xF8, 0xE0, 0x80, 0x00, 0x00, 0x03, 0x0F, 0x1F, 0x7F, 0xFF, 0xFE, 0xF8, 0xF0, 0xC0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
    0xF0, 0xE0, 0xE0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0,
    0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF0,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xF0, 0xF0, 0xF0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0,
    0xE0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xE0,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0xE0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x70, 0xF0, 0xF0, 0xF0, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xF0, 0xF0,
    0xF0, 0xF0, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x1F, 0x7F, 0xFF, 0xFE, 0xFC, 0xF0, 0xE0, 0xC0,
    0x80, 0x03, 0x07, 0x0F, 0x1F, 0x3F, 0x3F, 0x7E, 0xFC, 0xF8, 0xF0, 0xF0, 0xE0, 0xE0, 0xC1, 0xC1,
    0x83, 0x83, 0x83, 0x83, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x83, 0x83, 0x83, 0xC1,
    0xC1, 0xC0, 0xE0, 0xE0, 0xF0, 0xF8, 0xF8, 0x7C, 0x7E, 0x3F, 0x1F, 0x0F, 0x03, 0x01, 0x00, 0xC0,
    0xE0, 0xF0, 0xF8, 0xFE, 0xFF, 0x7F, 0x3F, 0x0F, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x07, 0x0F, 0x3F, 0xFF, 0xFF, 0xFC, 0xF8, 0xE0, 0xC0, 0x00, 0x00, 0x03, 0x07,
    0x1F, 0x7F, 0xFF, 0xFF, 0xFC, 0xF0, 0xE0, 0x80, 0x00, 0x01, 0x03, 0x0F, 0x3F, 0xFF, 0xFF, 0xFC,
    0xF8, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0xE1, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xC0, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xF8, 0xFE, 0xFF, 0xFF, 0xFF, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x07, 0x0F, 0x07, 0x07, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xE0,
    0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x7F, 0xFF, 0xFC, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0xFF,
    0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0x0F, 0x03, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0xFF, 0xFF, 0xFF, 0xFC, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0x0F, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03,
    0x07, 0xFF, 0xFF, 0xFF, 0xFC, 0xE0, 0x00, 0x00, 0x00, 0x80, 0xFC, 0xFF, 0xFF, 0xFF, 0x0F, 0x03,
    0x01, 0x00, 0x00, 0x00, 0x80, 0x80, 0x81, 0x83, 0x87, 0x87, 0x87, 0x87, 0x80, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x03, 0x1F, 0x3F, 0xFF, 0xFE, 0xF8, 0xE0, 0xF0, 0xFC, 0xFF, 0x7F, 0x1F, 0x07,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x0F, 0x1F,
    0x3F, 0x7F, 0x7E, 0xFC, 0xF8, 0xF8, 0xF0, 0xE0, 0xE0, 0xC1, 0xC1, 0x83, 0x83, 0x87, 0x07, 0x07,
    0x0F, 0x0F, 0x0F, 0x0F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x0F, 0x0F, 0x0F, 0x0F,
    0x07, 0x87, 0x83, 0x83, 0xC3, 0xC1, 0xE0, 0xE0, 0xF0, 0xF0, 0xF8, 0xFC, 0x7E, 0x7E, 0x3F, 0x1F,
    0x0F, 0x07, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x07, 0x0F, 0x3F, 0xFF, 0xFF, 0xFC, 0xF0, 0xE0,
    0x80, 0x00, 0x00, 0x03, 0x07, 0x1F, 0x7F, 0xFF, 0xFE, 0xFC, 0xF0, 0xC0, 0x80, 0x00, 0x01, 0x07,
    0x1F, 0x3F, 0xFF, 0xFE, 0xFC, 0xF0, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0x83, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x1F, 0x7F, 0xFF, 0xFF, 0xFF, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x80, 0xE0, 0xF8, 0xF0, 0xF0, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x01, 0x07, 0x0F, 0x7F, 0xFF, 0xFE, 0xFC, 0xFF, 0xFF,
    0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0xFF, 0xFF, 0xFF, 0xF0, 0xC0, 0x80, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xFF, 0xFF, 0xFF, 0x3F, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x3F, 0xFF, 0xFF, 0xFF, 0xF0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0,
    0xE0, 0xFF, 0xFF, 0xFF, 0x3F, 0x07, 0x00, 0x00, 0x00, 0x01, 0x3F, 0xFF, 0xFF, 0xFF, 0xF0, 0xC0,
    0x80, 0x00, 0x00, 0x00, 0x07, 0x07, 0x87, 0x87, 0xC7, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x07, 0x07, 0x0F, 0x0F, 0x0F, 0x1F, 0x1F,
    0x1F, 0x1F, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x1F, 0x1F, 0x1F,
    0x1F, 0x0F, 0x0F, 0x0F, 0x07, 0x07, 0x07, 0x03, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x07, 0x07, 0x07,
    0x07, 0x06, 0x04, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x07, 0x07, 0x07, 0x06, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x03, 0x07, 0x07, 0x07, 0x07, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x07, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
    0x0F, 0x07, 0x07, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x0F, 0x0F,
    0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x07, 0x0F, 0x0F, 0x0F,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x07, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
    0x07, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x07,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x07, 0x07, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

};


void Print_Receipt2(EMVCL_RC_DATA_EX *data, ULONG ulValue){
	BYTE baTemp[384 * 64]; // The width of paper is 384 dot.

    //Font atrributes
    CTOS_FONT_ATTRIB stFONT_ATTRIB;

    //Auxiliar char buffer
    UCHAR charBuffer[50];

    // Auxiliar PAN number
    UCHAR applicationAIDAux[40];

    // Auxiliar PAN number
    UCHAR PANNumberAux[40];

    // Lenght of PAN number
    BYTE lenghtPANNumber;

    BYTE Timer_printSTR[40] = {0};
	
	CTOS_RTC stRTC;
	USHORT usRtn;

	CTOS_PrinterFontSelectMode(d_FONT_FNT_MODE);
	
    CTOS_PrinterFline(5);
	
	//Print out the bank logo
    usRtn = CTOS_PrinterLogo((BYTE *) baPrinterBufferLogo_Receipt2, 0, 380, 10);
    CTOS_PrinterFline(12);
	
	if(usRtn != d_OK){
		CTOS_LCDTClearDisplay();
		CTOS_LCDTPrintXY(1, 4, "   Printer Error!   ");
		CTOS_LCDTPrintXY(1, 5, " Please Check Paper ");
		return;
	}

    stFONT_ATTRIB.X_Space = 0;
    //The height of the space between the font with next font
    stFONT_ATTRIB.Y_Space = 0;
    memset(baTemp, 0x00, sizeof (baTemp));
    stFONT_ATTRIB.FontSize = d_FONT_8x16;
    //Double de X size
    stFONT_ATTRIB.X_Zoom = 3;
    //Double de Y size
    stFONT_ATTRIB.Y_Zoom = 4;
    //The width of the space between the font with next font
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, (BYTE *) "VEGA3000", &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 6);
    CTOS_PrinterFline(20);
	
    //==============================
    //Print out the transaction data
    //==============================
    CTOS_PrinterPutString((BYTE *) "MER ID: 886289131771");
    CTOS_PrinterFline(5);
    strcpy((char *) applicationAIDAux, "BATCH NO: 000307");
    CTOS_PrinterPutString(applicationAIDAux);
    CTOS_PrinterFline(5);


	//Card Number
    if (data->bSID == d_VW_SID_VISA_OLD_US || data->bSID == d_VW_SID_VISA_WAVE_2 || data->bSID == d_VW_SID_VISA_WAVE_QVSDC || data->bSID == d_VW_SID_VISA_WAVE_MSD) {
        memset(baTemp, 0x00, sizeof (baTemp));
        memset(baTemp2, 0x00, sizeof (baTemp2));
        memcpy(baTemp, &data->baTrack2Data[1], 4);
        memcpy(baTemp2, &data->baTrack2Data[13], 4);

    } else {
        UnpackData(data->baTrack2Data, 20, baTmp);
        memcpy(baTemp, baTmp, 4);
        memcpy(baTemp2, &baTmp[12], 4);
        baTemp2[16] = 0;

    }
	
    
    stFONT_ATTRIB.FontSize = d_FONT_8x16;
    stFONT_ATTRIB.X_Zoom = 2;
    stFONT_ATTRIB.Y_Zoom = 2;

    CTOS_PrinterPutString((unsigned char *) "CARD NO:");
    CTOS_PrinterFline(12);

    lenghtPANNumber = strlen("  ********************");
	sprintf(PANNumberAux, "  %s **** **** %s", baTemp, baTemp2);
    //strcpy((char *) PANNumberAux, "  ********************");
	memcpy(TransHis[TransHisCount].CardNO, PANNumberAux, sizeof(PANNumberAux));//copy card number
	//strcpy(TransHis->CardNO, PANNumberAux);
	
	memset(baTemp, 0x00, sizeof (baTemp));
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, PANNumberAux, &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 8);
	
	//Exp Date
    if (data->bSID == d_VW_SID_VISA_OLD_US || data->bSID == d_VW_SID_VISA_WAVE_2 || data->bSID == d_VW_SID_VISA_WAVE_QVSDC || data->bSID == d_VW_SID_VISA_WAVE_MSD) {
        memcpy(baTemp, &data->baTrack2Data[20], 2);
         baTemp[2] = 0;
         memcpy(baTmp1, &data->baTrack2Data[18], 2);
         baTmp1[2] = 0;


    } else {
        memcpy(baTemp, baTmp + 19, 2);
         baTemp[2] = 0;
         memcpy(baTmp1, baTmp + 17, 2);
         baTmp1[2] = 0;

    }
	
	sprintf(baBuf, "EXP. DATE: 20%s/%s", baTmp1, baTemp);
	sprintf(TransHis[TransHisCount].ExpDate, "EXP. DATE: 20%s/%s", baTmp1, baTemp);
    CTOS_PrinterPutString(baBuf);
    CTOS_PrinterFline(5);
    CTOS_PrinterPutString((BYTE *) "ISSUER: 84188062");
    CTOS_PrinterFline(15);
	
	memset(baTemp, 0x00, sizeof (baTemp));
    stFONT_ATTRIB.FontSize = d_FONT_8x16;
    stFONT_ATTRIB.X_Zoom = 3;
    stFONT_ATTRIB.Y_Zoom = 2;
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, (BYTE *) "       BOOK/SALE", &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 6);
    CTOS_PrinterFline(12);

    CTOS_PrinterPutString((BYTE *) "TERM ID: 11010001   OPER ID: 002");
    CTOS_PrinterFline(5);
    CTOS_RTCGet(&stRTC);
    sprintf((char *) Timer_printSTR, "DATE:%02d/%02d/20%02d    TIME:%02d:%02d", stRTC.bDay, stRTC.bMonth, stRTC.bYear, stRTC.bHour, stRTC.bMinute);
	sprintf(TransHis[TransHisCount].TransTime, "DATE:%02d/%02d/20%02d    TIME:%02d:%02d", stRTC.bDay, stRTC.bMonth, stRTC.bYear, stRTC.bHour, stRTC.bMinute);
    CTOS_PrinterPutString((BYTE *) Timer_printSTR);
    //CTOS_PrinterPutString((BYTE *)"DATE: 31/10/2012    TIME: 14:52");
    CTOS_PrinterFline(5);
    CTOS_PrinterPutString((BYTE *) "REF NO: 855090913452");
    CTOS_PrinterFline(15);
	
	CTOS_PrinterFontSelectMode(d_FONT_TTF_MODE);
	CTOS_PrinterTTFSelect("arial.ttf", 0);

	TransHis[TransHisCount].Trans_Amount = (int)ulValue;
    //sprintf((char *) charBuffer, "      $ %d", (int)ulValue);
	int i, j;
	i = (int)ulValue / 100;
	j = (int)ulValue % 100;
	if(i == 0){
		if(Dollar_Sign == 1)
			sprintf((char *) charBuffer, "      $ 0.%02d", j);
		else if(Dollar_Sign == 2)
			sprintf((char *) charBuffer, "      € 0.%02d", j);
	}
	else{
		if(Dollar_Sign == 1)
			sprintf((char *) charBuffer, "      $ %d.%02d", i, j);
		else if(Dollar_Sign == 2)
			sprintf((char *) charBuffer, "      € %d.%02d", i, j);
	}
    stFONT_ATTRIB.FontSize = d_FONT_12x24;
    stFONT_ATTRIB.X_Zoom = 3;
    stFONT_ATTRIB.Y_Zoom = 2;
    memset(baTemp, 0x00, sizeof (baTemp));
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, (BYTE *) charBuffer, &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 6);

    CTOS_PrinterFline(40);
    //CTOS_PrinterLogo((BYTE *)SignatureCanvas, 0, 320, 60);
    //CTOS_PrinterFline(10);
    CTOS_PrinterPutString((BYTE *) "===== CARDHOLDER SIGNATURE =====");
    CTOS_PrinterFline(40);

    CTOS_PrinterPutString((BYTE *) "\n\n");
	TransHis[TransHisCount].Type = 0;
}

//------------------------------------------------------------------------------

void TLVDataClear(void) {
    TLVDataLen = 0;
}
//------------------------------------------------------------------------------

void TLVDataRemove(ULONG tag) {
    WORD i;
    WORD j;
    USHORT len;
    ULONG tag_value;
    USHORT len_value;
    USHORT data_offset;
    BYTE temp[10];

    i = j = 0;
    while (i < TLVDataLen) {
        data_offset = TLV_Get_Value(&TLVData[i], &tag_value, &len_value);
        len = data_offset + len_value;
        if (tag == tag_value) {
            i += len;
            continue;
        } else {

            memcpy(&TLVData[j], &TLVData[i], len);
            j += len;
            i += len;

        }
    }

    TLVDataLen = j;
}
//------------------------------------------------------------------------------

short TLVDataAdd(ULONG tag, USHORT len, BYTE *buf) {
    USHORT i;
    BYTE str[20];
    ULONG tag_value;
    USHORT len_value;
    USHORT data_offset;
    BYTE temp[10];

    //sprintf(str, "Tag %04X ", tag);
    //DebugAddHEX(str, buf, len);

    i = 0;

    while (i < TLVDataLen) {
        data_offset = TLV_Get_Value(&TLVData[i], &tag_value, &len_value);
        if (tag == tag_value) {
            TLVDataRemove(tag);
            break;
        }

        i += (data_offset + len_value);
    }

    //Add new
    i = 0;

    if ((tag >> 16) > 0) {
        temp[i++] = (BYTE) (tag >> 16);
    }
    if ((tag >> 8) > 0) {
        temp[i++] = (BYTE) (tag >> 8);
    }
    temp[i++] = (BYTE) tag;

    if (len > 0xFF) {
        temp[i++] = 0x82;
        temp[i++] = len / 256;
        temp[i++] = len % 256;
    } else if (len > 0x7F) {
        temp[i++] = 0x81;
        temp[i++] = (BYTE) len;
    } else {
        temp[i++] = (BYTE) len;
    }

    if ((TLVDataLen + i + len) > d_TLV_DATA_BUF_SIZE) {
        return 1;
    }

    memcpy(&TLVData[TLVDataLen], temp, i);
    TLVDataLen += i;

    memcpy(&TLVData[TLVDataLen], buf, len);
    TLVDataLen += len;

    return 0;
}
//------------------------------------------------------------------------------

short TLVDataGet(ULONG tag, BYTE *buf) {
    USHORT i;
    ULONG tag_value;
    USHORT len_value;
    USHORT data_offset;

    i = 0;

    while (i < TLVDataLen) {
        data_offset = TLV_Get_Value(&TLVData[i], &tag_value, &len_value);
        if (tag == tag_value) {
            memcpy(buf, &TLVData[i + data_offset], len_value);
            return len_value;
        }

        i += (data_offset + len_value);
    }

    return 0;
}
//------------------------------------------------------------------------------

void TLVDataParse(BYTE *buf, USHORT len) {
    ULONG tag_value;
    USHORT len_value;
    USHORT i;
    USHORT offset;

    i = 0;
    while (i < len) {
        offset = TLV_Get_Value(&buf[i], &tag_value, &len_value);
        TLVDataAdd(tag_value, len_value, &buf[i + offset]);
        i += offset + len_value;
    }
}
//------------------------------------------------------------------------------

USHORT Online_Process(BYTE *baData, USHORT usDataLen) {
    BYTE baBuff[2048];
    BYTE key;
    USHORT usBuffLen;
    USHORT i;
    USHORT ret;

    //Send data to host
    usBuffLen = 0;
    baBuff[usBuffLen++] = 0x10;
    baBuff[usBuffLen++] = 0x02;
    for (i = 0; i < usDataLen; i++) {
        baBuff[usBuffLen++] = baData[i];
        if (baData[i] == 0x10) {
            baBuff[usBuffLen++] = baData[i];
        }
    }
    baBuff[usBuffLen++] = 0x00; //Ignore LRC check
    baBuff[usBuffLen++] = 0x10;
    baBuff[usBuffLen++] = 0x03;

    __DebugAddHEX("Data to Host", baBuff, usBuffLen);

    //Receive Response
    do {
#ifdef _SIMULATE_ONLINE_RESULT
//        CTOS_KBDHit(&key);
        key = '1';

        if (key == '1') {
            ret = d_EMVCL_OUTCOME_APPROVAL;
            break;
        } else if (key == '2') {
            ret = d_EMVCL_OUTCOME_DECLINED;
            break;
        }
#else

        i = sizeof (baBuff);
        if (CTOS_RS232RxData(d_COM1, baBuff, &i) == d_OK && i > 0) {
            if (baBuff[0] == '1') {
                ret = d_EMV_CHIP_ONL_APPROVAL;
            } else {
                ret = d_EMV_CHIP_ONL_DECLINED;
            }
            break;
        }

        CTOS_KBDHit(&key);

#endif 

    } while (key != d_KBD_CANCEL);

    if (key == d_KBD_CANCEL) {
        ret = d_EMVCL_OUTCOME_DECLINED;
    }

    return ret;
}
//------------------------------------------------------------------------------
//	x: X position
//	y: Y position
//	min: Minimum length of the input data
//	max: Maximum length of the input data
//	mask: If maskchar = 0, don't need mask char, if > 0, it will show to screen.

char Get_PIN_Input(BYTE x, BYTE y, BYTE min, BYTE max, char mask, char *buf, BYTE *len) {
    BYTE ilen;
    BYTE c[2];

    //CTOS_LCDTGotoXY(x, y);

    ilen = 0;
    c[1] = 0; //NULL

    while (TRUE) {
        CTOS_KBDGet(c);

        if (c[0] >= '0' && c[0] <= '9') //0-9
        {
            if (x <= 16 && ilen < max) {
                buf[ilen++] = c[0];
                if (mask == 0)
                    TopRelative_LCDTPutchXY(x, y, c[0]);
                else
                    TopRelative_LCDTPutchXY(x, y, mask);

                x++;
            }
        } else if (c[0] == d_KBD_CLEAR) //clear
        {
            if (ilen > 0) {
                ilen--;
                x--;
                TopRelative_LCDTPutchXY(x, y, ' ');
            }
        } else if (c[0] == d_KBD_CANCEL) //cancel
        {
            return FALSE;
        } else if (c[0] == d_KBD_ENTER && ilen >= min) //enter
        {
            *len = ilen;
            buf[ilen] = 0x00; //put end of string
            return TRUE;
        }
    }
}
//------------------------------------------------------------------------------

void StartTrans(BYTE bType, ULONG ul) {//
    BYTE bKey;
    BYTE is_online_request;
    BYTE NeedSignature;
    BYTE temp[20];
    BYTE upload_tx_buf[1024];
    USHORT upload_tx_len;
    BYTE pin[20];
    BYTE pin_len;
    ULONG ulAPRtn;
    BYTE *msg;
    BYTE *CVMStr;
    BYTE TransaRelatedData[100];
    BYTE lenn;

    BYTE bAction;
    BYTE baARC[2];
    UINT uiIADLen;
    BYTE baIAD[128];
    UINT uiScriptLen;
    BYTE baScript[256];
    ULONG ulScheme;
    ULONG ulValue;
	USHORT ret;

    __DebugAddINT("               ", 0);
    __DebugAddINT("               ", 0);

    /*
    // amount - ascii to int
    ulAmt = ASCII2Int(g_baInputAmt, g_usAmtLen);
    ulCBAmt = ASCII2Int(g_baInputCBAmt, g_usCBAmtLen);
    ulAmt += ulCBAmt;


    sprintf(temp, " Amount:$%ld", ulAmt);
    PageSetString(1, temp);
    PageShow(d_PAGE_TRANSACTION_PRESENT_CARD);
    */
	//CTOS_LCDGShowBMPPic(0, 0, "Processing.bmp");
//    PageClean();
//    EMVCL_ShowContactlessSymbol(NULL);
//    CTOS_LCDGShowPic(95,55,(BYTE *)baLCDLogo,sizeof(baLCDLogo),142);     \\for 2.4" LCD
    
    //CTOS_LCDTPrintXY(1, 1, "                                   ");
    //CTOS_LCDTPrintXY(1, 2, "                                   ");
    
    EMVCL_ShowVirtualLED(NULL);
    EMVCL_SetLED(0x0F, 0x08);
    //CTOS_LCDGShowPic(95,135,(BYTE *)baLCDLogo,sizeof(baLCDLogo),142);

    memset(&stACTData, 0, sizeof (EMVCL_ACT_DATA));
    memset(&stRCDataEx, 0, sizeof (EMVCL_RC_DATA_EX));
    memset(&stRCDataAnalyze, 0, sizeof (EMVCL_RC_DATA_ANALYZE));


    // perform transaction : EMVCL_StartTransactionEx
    stACTData.bStart = d_EMVCL_ACT_DATA_START_A;
    stACTData.bTagNum = 0;
    stACTData.usTransactionDataLen = 0;

    //Put 0x9F02 Amount, Authorized (Numeric)
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x9F;
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x02;
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x06;
	ULONG ul2 = ul / 100;
    wub_long_2_bcd(ul2, temp, &lenn);
    memset(&TransaRelatedData[stACTData.usTransactionDataLen], 0, 6);
    memcpy(&TransaRelatedData[stACTData.usTransactionDataLen + 6 - lenn], temp, lenn);
    stACTData.usTransactionDataLen += 6;
    stACTData.bTagNum++;

    //Put 0x9F03
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x9F;
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x03;
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x06;
    wub_long_2_bcd(ulCBAmt, temp, &lenn);
    memset(&TransaRelatedData[stACTData.usTransactionDataLen], 0, 6);
    memcpy(&TransaRelatedData[stACTData.usTransactionDataLen + 6 - lenn], temp, lenn);

    stACTData.usTransactionDataLen += 6;
    stACTData.bTagNum++;

    //Put 0x9C
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x9C;
    TransaRelatedData[stACTData.usTransactionDataLen++] = 0x01;
    TransaRelatedData[stACTData.usTransactionDataLen++] = g_bTxntype;
    stACTData.bTagNum++;

    if (g_isForcedOnl == TRUE) {
        TransaRelatedData[stACTData.usTransactionDataLen++] = 0xDF;
        TransaRelatedData[stACTData.usTransactionDataLen++] = 0x9F;
        TransaRelatedData[stACTData.usTransactionDataLen++] = 0x01;
        TransaRelatedData[stACTData.usTransactionDataLen++] = 0x01;
        TransaRelatedData[stACTData.usTransactionDataLen++] = 0x01;
        stACTData.bTagNum++;
    }

    __DebugAddHEX("In Data", TransaRelatedData, stACTData.usTransactionDataLen);

    stACTData.pbaTransactionData = TransaRelatedData;

    if (bType == d_INIT_TRANS) {
        EMVCL_InitTransactionEx(stACTData.bTagNum, stACTData.pbaTransactionData, stACTData.usTransactionDataLen);

        do {
			CTOS_KBDHit(&bKey);
			
			ret = EMVPolling(ul);
			if(ret == d_OK)
			{
				return;
			}else if(ret == d_PIN_FAIL){
				EMVCL_CancelTransaction();
				return;
			}else if(ret == d_SIGN_FAIL){
				EMVCL_CancelTransaction();
				return;
			}
			
            ulAPRtn = EMVCL_PerformTransactionEx(&stRCDataEx);

            if (ulAPRtn == d_EMVCL_TX_CANCEL) {
                return;
            } else if (ulAPRtn == 0xA00000E0) {

            } else if (ulAPRtn != d_EMVCL_PENDING) {
                break;
            }
			
			if(bKey == d_KBD_CANCEL){
				EMVCL_CancelTransaction();
				return;
			}

        } while (1);
    } else {
        __DebugAddSTR("Go EMVCL_StartTransactionEx");
        ulAPRtn = EMVCL_StartTransactionEx(&stACTData, &stRCDataEx);
        if (ulAPRtn == d_EMVCL_TX_CANCEL) {
            return;
        }
    }
	CTOS_LCDGShowBMPPic(0, 60, "Processing_V3_420.bmp");

    __DebugAddINT("TestPerform rtn", ulAPRtn);
    __DebugAddINT("SID", stRCDataEx.bSID);
    __DebugAddSTR(stRCDataEx.baDateTime);
    __DebugAddHEX("SCData Track1", stRCDataEx.baTrack1Data, stRCDataEx.bTrack1Len);
    __DebugAddHEX("SCData Track2", stRCDataEx.baTrack2Data, stRCDataEx.bTrack2Len);
    //DebugAddSTR(stRCDataEx.baTrack1Data);
    //DebugAddSTR(stR__DebugAddHEX("SCData Chip", stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
    __DebugAddHEX("SCData Additional", stRCDataEx.baAdditionalData, stRCDataEx.usAdditionalDataLen); //stRCDataEx.baTrack2Data);
    __DebugAddHEX("SCData baChipData", stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
    //	Show_TLV_Data("SCData Chip:", stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
    //	Show_TLV_Data("SCData Additional:", stRCDataEx.baAdditionalData, stRCDataEx.usAdditionalDataLen);

    //PageClean();

    if (ulAPRtn != d_EMVCL_RC_DATA) {
        PageSetParameter(1, &ulAPRtn);
        //PageShow(d_PAGE_TRANSACTION_NO_CARD_AND_USE_OTHER_CARD);
        //CTOS_KBDGet(&bKey);
        return;
    }


    //Parse transaction response data	
    //Parse Scheme ID
    ulScheme = 0 + stRCDataEx.bSID;
    PageSetParameter(1, &ulScheme);
    //CTOS_LCDTPrintXY(1, 4, msg);

    //Parse received chip and additional data 
    TLVDataClear();
    TLVDataParse(stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
    TLVDataParse(stRCDataEx.baAdditionalData, stRCDataEx.usAdditionalDataLen);

    EMVCL_AnalyzeTransactionEx(&stRCDataEx, &stRCDataAnalyze);

    //After parsing transaction data, check if CVM is need and get the transaction result	
    //CVM Require - If Card need CVM, performing CVM at this moment
    NeedSignature = FALSE;
    CVMStr = "                ";

    if (stRCDataAnalyze.bCVMAnalysis == d_EMVCL_CVM_REQUIRED_SIGNATURE) {
        CVMStr = "CVM->Signature";
        NeedSignature = TRUE;
    } else if (stRCDataAnalyze.bCVMAnalysis == d_EMVCL_CVM_REQUIRED_ONLPIN) {
        CVMStr = "CVM->PIN";
        PageClean();

        //PageShow(d_PAGE_TRANSACTION_ENTER_ONLINE_PIN);

        if (Get_PIN_Input(1, 2, 4, 16, '*', pin, &pin_len) == FALSE) {
            //PageShow(d_PAGE_TRANSACTION_PIN_BY_PASS);
        }

        //set TVR byte 3 if need
        //ex : TLVDataGet(0x95, temp);
        // temp[2] |= 0x04;
        //TLVDataAdd(0x95, 5, temp);
    } else if (stRCDataAnalyze.bCVMAnalysis == d_EMVCL_CVM_REQUIRED_NOCVM) {
        CVMStr = "CVM->No CVM Req";
    }

    usTxResult = stRCDataAnalyze.usTransResult;
    __DebugAddINT("Transaction Result", usTxResult);


    //PageShow(d_PAGE_TRANSACTION_SHOW_SCHEME_ID);

    is_online_request = FALSE;

    //Online
    if (usTxResult == d_EMVCL_OUTCOME_ONL) {
        is_online_request = TRUE;
        //PageShow(d_PAGE_TRANSACTION_OUTCOME_GO_ONL);
    }//Offline Approval
    else if (usTxResult == d_EMVCL_OUTCOME_APPROVAL) {
        //        sprintf(temp, " Amount $ %ld", ulValue);

        sprintf(temp, " Amount $ %ld", ul);
        PageSetString(1, temp);
        PageSetString(2, CVMStr);
        //PageShow(d_PAGE_TRANSACTION_OUTCOME_OFFLINE_APPROVAL);

    }//Offline Declined
    else if (usTxResult == d_EMVCL_OUTCOME_DECLINED) {
        PageSetString(1, CVMStr);
       // PageShow(d_PAGE_TRANSACTION_OUTCOME_OFFLINE_DECLINED);
    } else {
        //PageShow(d_PAGE_TRANSACTION_OUTCOME_UNKNOWN);
        //CTOS_KBDGet(&bKey);
        return;
    }

    //Online : send online data to host for online authrn.
    if (is_online_request == TRUE) {
        //Rrepare Upload Data to host
        upload_tx_len = 0;

        upload_tx_buf[upload_tx_len++] = 14;
        memcpy(&upload_tx_buf[upload_tx_len], stRCDataEx.baDateTime, 14);
        upload_tx_len += 14;

        upload_tx_buf[upload_tx_len++] = stRCDataEx.bTrack1Len;
        memcpy(&upload_tx_buf[upload_tx_len], stRCDataEx.baTrack1Data, stRCDataEx.bTrack1Len);
        upload_tx_len += stRCDataEx.bTrack1Len;

        upload_tx_buf[upload_tx_len++] = stRCDataEx.bTrack2Len;
        memcpy(&upload_tx_buf[upload_tx_len], stRCDataEx.baTrack2Data, stRCDataEx.bTrack2Len);
        upload_tx_len += stRCDataEx.bTrack2Len;

        upload_tx_buf[upload_tx_len++] = stRCDataEx.usChipDataLen / 256;
        upload_tx_buf[upload_tx_len++] = stRCDataEx.usChipDataLen % 256;
        memcpy(&upload_tx_buf[upload_tx_len], stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
        upload_tx_len += stRCDataEx.usChipDataLen;

        upload_tx_buf[upload_tx_len++] = stRCDataEx.usAdditionalDataLen / 256;
        upload_tx_buf[upload_tx_len++] = stRCDataEx.usAdditionalDataLen % 256;
        memcpy(&upload_tx_buf[upload_tx_len], stRCDataEx.baAdditionalData, stRCDataEx.usAdditionalDataLen);
        upload_tx_len += stRCDataEx.usAdditionalDataLen;

        //send upload data and get the online authen result
        usTxResult = Online_Process(upload_tx_buf, upload_tx_len);

#if 0
        //CTOS_Delay(3000);

        bAction = 0x01;
        memcpy(baARC, "00", 2);
        //uiIADLen = 0;
        uiIADLen = 10;
        memcpy(baIAD, "\x11\x22\x33\x44\x55\x66\x77\x88\x30\x30", 10);
        //uiScriptLen = 0;
        uiScriptLen = 35;
        memcpy(baScript, "\x72\x21\x9F\x18\x04\x11\x22\x33\x44\x86\x0D\x84\x24\x00\x00\x08\xAA\xBB\xCC\xDD\x11\x22\x33\x44\x86\x09\x84\x24\x00\x00\x04\x55\x66\x77\x88", 35);

        ulAPRtn = EMVCL_CompleteEx(bAction, baARC, uiIADLen, baIAD, uiScriptLen, baScript, &stRCDataEx);

        __DebugAddINT("complete rtn", ulAPRtn);
        __DebugAddINT("c SID", stRCDataEx.bSID);
        __DebugAddSTR(stRCDataEx.baDateTime);
        __DebugAddHEX("c SCData Track1", stRCDataEx.baTrack1Data, stRCDataEx.bTrack1Len);
        __DebugAddHEX("c SCData Track2", stRCDataEx.baTrack2Data, stRCDataEx.bTrack2Len);
        //DebugAddSTR(stRCDataEx.baTrack1Data);
        //DebugAddSTR(stRCDataEx.baTrack2Data);
        __DebugAddHEX("c SCData Chip", stRCDataEx.baChipData, stRCDataEx.usChipDataLen);
        __DebugAddHEX("c SCData Additional", stRCDataEx.baAdditionalData, stRCDataEx.usAdditionalDataLen);
#endif

        //Online Approval
        if (usTxResult == d_EMVCL_OUTCOME_APPROVAL) {
            //            sprintf(temp, " Amount $ %ld", ulValue);
            sprintf(temp, " Amount $ %ld", ul);
            PageSetString(1, temp);
            PageSetString(2, CVMStr);
            //PageShow(d_PAGE_TRANSACTION_OUTCOME_ONLINE_APPROVAL);
        }//Online Declined
        else {
            PageSetString(1, CVMStr);
            //PageShow(d_PAGE_TRANSACTION_OUTCOME_ONLINE_DECLINED);
        }
    }

	if(Dollar_Sign == 1){
		CTOS_LCDGShowBMPPic(0, 60, "Printing.bmp");
		EMVCL_ShowVirtualLED(NULL);
		//EMVCL_SetLED(0x0F, 0x08);
	}else if(Dollar_Sign == 2){
		//CTOS_Delay(2000);
		CTOS_LCDGShowBMPPic(0, 60, "Printing_V3_420.bmp");
	}
	
	///CTOS_LCDGShowBMPPic(0, 0, "Printing.bmp");
	//EMVCL_ShowVirtualLED(NULL);
    //EMVCL_SetLED(0x0F, 0x08);
    //Print_Receipt(&stRCDataEx, NeedSignature, ulAmt);
	Print_Receipt2(&stRCDataEx, ul);

    return;
}
//------------------------------------------------------------------------------
//EMV Contact
#define d_BUFF_SIZE 128 
#define d_ONLINE_KEYSET         0x2001
#define d_ONLINE_KEYINDEX       0x0000
#define d_OFFLINE_KEYINDEX      0x0001
#define d_ONLINE_KEY            "\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11"
#define d_EMV_CONFIG_FILE       "emv_config.xml"

BYTE CardSNbuf[128];
BYTE CardExpDatebuf1[32];
BYTE CardExpDatebuf2[128];
ULONG g_ulAMT = 0;
BOOL isOfflinePIN = FALSE;
BOOL isPIN_OK = FALSE;
BOOL isInsertPIN = FALSE;
static BYTE baAuthorizationCode[4]; 
static BYTE baIssuerAuthenticationData[128];
static BYTE baIssuerScript[256]; 

CTOS_FONT_ATTRIB FONT_ATTRIB;
BYTE SelectedAID[16];
CTOS_RTC stRTC;

//int wub_strlen(unsigned char *str);

void PrintCenter(BYTE y, STR *sBuf) {
    CTOS_LCDTPrintXY(1, y, (BYTE*) "                ");
    CTOS_LCDTPrintXY((16 - wub_strlen(sBuf)) / 2 + 1, y, sBuf);
}

static void prt_sample2(ULONG ul, BYTE ContactType) {// 1:ICC 2:MSR
    BYTE	baTemp[384 * 64]; // The width of paper is 384 dot.
    BYTE	prtBuf[128];//Buffer for PrintOut
    USHORT	usRtn;//Function Return

    //CTOS_LCDTClearDisplay();
    //CTOS_LCDGShowBMPPic(0, 0, "Qt_Test.bmp");
    //CTOS_LCDTPrintXY(1, 6, "Printing...          ");
	CTOS_PrinterFontSelectMode(d_FONT_FNT_MODE);
	
    //Font atrributes
    CTOS_FONT_ATTRIB stFONT_ATTRIB;

    //Auxiliar char buffer
    UCHAR charBuffer[50];

    // Auxiliar PAN number
    UCHAR applicationAIDAux[40];

    // Auxiliar PAN number
    UCHAR PANNumberAux[40];

    // Lenght of PAN number
    BYTE lenghtPANNumber;

    BYTE Timer_printSTR[40] = {0};

    CTOS_PrinterFline(5);

    //Print out the bank logo
    usRtn = CTOS_PrinterLogo((BYTE *) baPrinterBufferLogo_Receipt2, 0, 380, 10);
    CTOS_PrinterFline(12);
	
	if(usRtn != d_OK){
		CTOS_LCDTClearDisplay();
		CTOS_LCDGShowBMPPic(0, 0, "Welcome.bmp");
		CTOS_LCDTPrintXY(1, 4, "   Printer Error!   ");
		CTOS_LCDTPrintXY(1, 5, " Please Check Paper ");
		return;
	}

    stFONT_ATTRIB.X_Space = 0;
    //The height of the space between the font with next font
    stFONT_ATTRIB.Y_Space = 0;
    memset(baTemp, 0x00, sizeof (baTemp));
    stFONT_ATTRIB.FontSize = d_FONT_8x16;
    //Double de X size
    stFONT_ATTRIB.X_Zoom = 3;
    //Double de Y size
    stFONT_ATTRIB.Y_Zoom = 4;
    //The width of the space between the font with next font
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, (BYTE *) "VEGA3000", &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 6);
    CTOS_PrinterFline(20);

    //==============================
    //Print out the transaction data
    //==============================
    CTOS_PrinterPutString((BYTE *) "MER ID: 886289131771");
    CTOS_PrinterFline(5);
    strcpy((char *) applicationAIDAux, "BATCH NO: 000307");
    CTOS_PrinterPutString(applicationAIDAux);
    CTOS_PrinterFline(5);


    memset(baTemp, 0x00, sizeof (baTemp));

    stFONT_ATTRIB.FontSize = d_FONT_8x16;
    stFONT_ATTRIB.X_Zoom = 2;
    stFONT_ATTRIB.Y_Zoom = 2;

    CTOS_PrinterPutString((unsigned char *) "CARD NO:");
    CTOS_PrinterFline(12);

	memset(prtBuf, 0x00, sizeof(prtBuf));
	sprintf(prtBuf, "  %c%c%c%c **** **** %c%c%c%c", CardSNbuf[0], CardSNbuf[1], CardSNbuf[2], CardSNbuf[3], CardSNbuf[12], CardSNbuf[13], CardSNbuf[14], CardSNbuf[15]);
	
    lenghtPANNumber = strlen("  ********************");
    strcpy((char *) PANNumberAux, prtBuf);
	memcpy(TransHis[TransHisCount].CardNO, PANNumberAux, sizeof(PANNumberAux));
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, PANNumberAux, &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 8);
	
	/*
	memset(prtBuf, 0x00, sizeof(prtBuf));
	sprintf(prtBuf, "Test(10-19) : %c%c%c%c%c%c%c%c%c%c", CardExpDatebuf2[10], CardExpDatebuf2[11], CardExpDatebuf2[12], CardExpDatebuf2[13], CardExpDatebuf2[14], CardExpDatebuf2[15], CardExpDatebuf2[16], CardExpDatebuf2[17], CardExpDatebuf2[18], CardExpDatebuf2[19]);
	CTOS_PrinterPutString((char *) prtBuf);
    CTOS_PrinterFline(5);
	*/
	
	if(ContactType == 1){	//ICC
		memset(prtBuf, 0x00, sizeof(prtBuf));
		sprintf(prtBuf, "EXP. DATE: 20%c%c/%c%c", CardExpDatebuf1[0], CardExpDatebuf1[1], CardExpDatebuf1[2], CardExpDatebuf1[3]);
		CTOS_PrinterPutString((char *)prtBuf);
		CTOS_PrinterFline(5);
	}else if(ContactType == 2){	//MSR
		memset(prtBuf, 0x00, sizeof(prtBuf));
		sprintf(prtBuf, "EXP. DATE: 20%c%c/%c%c", CardExpDatebuf2[0], CardExpDatebuf2[1], CardExpDatebuf2[2], CardExpDatebuf2[3]);
		CTOS_PrinterPutString((char *)prtBuf);
		CTOS_PrinterFline(5);
	}else{
		CTOS_PrinterPutString((BYTE *) "EXP. DATE: 2016/08");
		CTOS_PrinterFline(5);
	}
	memcpy(TransHis[TransHisCount].ExpDate, prtBuf, sizeof(prtBuf));
	 
    CTOS_PrinterPutString((BYTE *) "ISSUER: 84188062");
    CTOS_PrinterFline(15);

    memset(baTemp, 0x00, sizeof (baTemp));
    stFONT_ATTRIB.FontSize = d_FONT_8x16;
    stFONT_ATTRIB.X_Zoom = 3;
    stFONT_ATTRIB.Y_Zoom = 2;
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, (BYTE *) "       BOOK/SALE", &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 6);
    CTOS_PrinterFline(12);

    CTOS_PrinterPutString((BYTE *) "TERM ID: 11010001   OPER ID: 002");
    CTOS_PrinterFline(5);
    CTOS_RTCGet(&stRTC);
    sprintf((char *) Timer_printSTR, "DATE:%02d/%02d/20%02d    TIME:%02d:%02d", stRTC.bDay, stRTC.bMonth, stRTC.bYear, stRTC.bHour, stRTC.bMinute);
	sprintf(TransHis[TransHisCount].TransTime, "DATE:%02d/%02d/20%02d    TIME:%02d:%02d", stRTC.bDay, stRTC.bMonth, stRTC.bYear, stRTC.bHour, stRTC.bMinute);
    CTOS_PrinterPutString((BYTE *) Timer_printSTR);
    //CTOS_PrinterPutString((BYTE *)"DATE: 31/10/2012    TIME: 14:52");
    CTOS_PrinterFline(5);
    CTOS_PrinterPutString((BYTE *) "REF NO: 855090913452");
    CTOS_PrinterFline(15);

	CTOS_PrinterFontSelectMode(d_FONT_TTF_MODE);
	CTOS_PrinterTTFSelect("arial.ttf", 0);
    //sprintf((char *) charBuffer, "      $ %ld", ul);
	TransHis[TransHisCount].Trans_Amount = (int)ul;
	int i, j;
	i = (int)ul / 100;
	j = (int)ul % 100;
	if(i == 0){
		if(Dollar_Sign == 1)
			sprintf((char *) charBuffer, "      $ 0.%02d", j);
		else if(Dollar_Sign == 2)
			sprintf((char *) charBuffer, "      € 0.%02d", j);
	}
		//sprintf((char *) charBuffer, "      $ 0.%02d", j);
	else{
		if(Dollar_Sign == 1)
			sprintf((char *) charBuffer, "      $ %d.%02d", i, j);
		else if(Dollar_Sign == 2)
			sprintf((char *) charBuffer, "      € %d.%02d", i, j);
	}
		//sprintf((char *) charBuffer, "      $ %d.%02d", i, j);
    stFONT_ATTRIB.FontSize = d_FONT_12x24;
    stFONT_ATTRIB.X_Zoom = 3;
    stFONT_ATTRIB.Y_Zoom = 2;
    memset(baTemp, 0x00, sizeof (baTemp));
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, (BYTE *) charBuffer, &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 6);
    
	if(ContactType == 2){
		CTOS_PrinterBMPPic(0, MonoSignBMPFile);
		strcpy(TransHis[TransHisCount].Signature, MonoSignBMPFile);
		//CTOS_PrinterLogo((BYTE *)SignatureCanvas, 0, 320, 60);
		//memcpy(TransHis[TransHisCount].SignatureCanvas, SignatureCanvas, sizeof(SignatureCanvas));
		TransHis[TransHisCount].Type = 2;
	}
	else if(ContactType == 1){
		CTOS_PrinterFline(40);
		TransHis[TransHisCount].Type = 1;
	}
    //CTOS_PrinterFline(10);
    usRtn = CTOS_PrinterPutString((BYTE *) "===== CARDHOLDER SIGNATURE =====");
    CTOS_PrinterFline(40);

	if(usRtn != d_OK){
		CTOS_LCDTClearDisplay();
		CTOS_LCDGShowBMPPic(0, 0, "Welcome.bmp");
		CTOS_LCDTPrintXY(1, 4, "   Printer Error!   ");
		CTOS_LCDTPrintXY(1, 5, " Please Check Paper ");
		return;
	}
	
    CTOS_PrinterPutString((BYTE *) "\n\n");
}

USHORT IccTXNProcess(void)
{
    BYTE SelectedAIDLen, label_len, label[32];
    USHORT len;
    BYTE value[128], buff[128]={0}, msg[256];
    USHORT ret;
    memset(msg, 0x00, 256);
	
    //CTOS_LCDGShowBMPPic(0, 0, "Qt_Test.bmp"); 
	
    ret = EMV_TxnAppSelect(SelectedAID, &SelectedAIDLen, label, &label_len);
    sprintf(buff, "select ret %04X ", ret);
//    CTOS_LCDTPrintXY(1, 7, buff);
    if (ret == d_OK)
    {        
        len = sizeof(value);
        EMV_DataGet(d_TAG_PAN, &len, value);
        memset(buff, 0, sizeof(buff));
        len = wub_hex_2_str(value, buff, len);
		memcpy(CardSNbuf, buff, sizeof(buff));
		
		EMV_DataGet(0x5F24, &len, value);//0x0057
        memset(buff, 0, sizeof(buff));
        len = wub_hex_2_str(value, buff, len);
		memcpy(CardExpDatebuf1, buff, sizeof(buff));
		
        ret = EMV_TxnPerform(); //ICC with some problem, mark temporary
		
		//CTOS_LCDTPrintXY(1, 3, "Connecting...        ");
		CTOS_Delay(1000);
		
		return d_OK;
    }
    else
    {
        CTOS_LCDTClearDisplay();
		CTOS_LCDGShowBMPPic(0, 0, "Welcome.bmp");
        
        memset(buff, 0x00 ,sizeof(buff));
        wub_memcpy(buff, "\x2C\x02", 2);
        sprintf(&buff[2], "Card Error %04X ", ret);
        CTOS_LCDTPrintXY(1, 3, &buff[2]);
        
		return d_NO;
    }

}

USHORT MSRTXNProcess(BYTE *baTK1, USHORT TK1Len, BYTE *baTK2, USHORT TK2Len, BYTE *baTK3, USHORT TK3Len)
{
    BYTE baPAN[32];
    int i = 1;
    memset(baPAN, 0x00, 32);
	
	//Avoiding non-CreditCards
	//if(TK3Len > 0)
	//	return d_NO;
	
	BYTE CardExpFlag = 0;
	int j = 0;
	while(1){
		if(CardExpFlag){
			CardExpDatebuf2[0] = baTK2[j];
			CardExpDatebuf2[1] = baTK2[j+1];
			CardExpDatebuf2[2] = baTK2[j+2];
			CardExpDatebuf2[3] = baTK2[j+3];

			CardExpFlag = 0;
			break;
		}
		if(j > TK2Len)
			break;
	
		if(baTK2[j] == '=')
			CardExpFlag++;
	
		j++;
	}
	
    if(baTK2[0] == ';')
    {
        while(baTK2[i] != '=' || i > TK2Len)
        {
            baPAN[i - 1] = baTK2[i];
            i++;
        } 
		memcpy(CardSNbuf, baPAN, sizeof(baPAN));

		CTOS_LCDGShowBMPPic(0, 0, "Processing.bmp");
		EMVCL_ShowVirtualLED(NULL);
		EMVCL_SetLED(0x0F, 0x08);
		/*
		CTOS_LCDGShowBMPPic(0, 0, "Qt_Test.bmp");
		
		PrintCenter(4, "Processing...");
		CTOS_Delay(1000);

		PrintCenter(4, "Connecting...");
		CTOS_Delay(1000);
		*/
		
		return d_OK;
    }
	return d_NO;
}

USHORT InputPIN(void){
	BYTE	ICCKey;
	BYTE	ICCPIN[13];
	BYTE	ICCStar[13];
	USHORT	ICCPINLen;
	USHORT	ICCStarLen;
	
	CTOS_LCDGShowBMPPic(0, 0, "EnterPIN.bmp");
	EMVCL_ShowVirtualLED(NULL);
	EMVCL_SetLED(0x0F, 0x08);
	
	memset(ICCPIN, 0x00, sizeof(ICCPIN));
	memset(ICCStar, 0x00, sizeof(ICCStar));
	ICCStarLen = ICCPINLen = 0;
	while(1){

		CTOS_KBDGet(&ICCKey);
		
		switch(ICCKey){
			case d_KBD_ENTER:
				if((ICCPINLen < 4) || (ICCPINLen > 12)){
					CTOS_Delay(100);
					CTOS_Beep();
					CTOS_Delay(100);
					CTOS_Beep();
				}else{
					if(strcmp(ICCPIN, "8418") == 0){
						return d_OK;
					}else{
						CTOS_LCDTPrintXY(1, 9, "     Wrong PIN!    ");
						CTOS_Delay(100);
						CTOS_Beep();
						CTOS_Delay(100);
						CTOS_Beep();
						CTOS_Delay(500);
						CTOS_LCDTPrintXY(1, 8, "                   ");
						CTOS_LCDTPrintXY(1, 9, "                   ");
						memset(ICCPIN, 0x00, sizeof(ICCPIN));
						memset(ICCStar, 0x00, sizeof(ICCStar));
						ICCPINLen = 0;
						ICCStarLen = 0;
						
						continue;
					}
				}
				break;
				
			case d_KBD_CANCEL:
				return d_NO;
				break;
				
			case d_KBD_CLEAR:
				if (ICCPINLen == 0) {
					CTOS_Delay(100);
					CTOS_Beep();
					CTOS_Delay(100);
					CTOS_Beep();
				}else{
					ICCPIN[--ICCPINLen] = 0x00;
					ICCStar[ICCPINLen] = 0x00;
					//ICCStar[--ICCStarLen] = 0x00;
					CTOS_LCDTPrintXY(1, 8, "                    ");
					//CTOS_LCDTPrintXY(1, 9, "                    ");
					
					//CTOS_LCDTPrintXY((13 - ICCPINLen), 8, ICCStar);
					//CTOS_LCDTPrintXY((13 - ICCPINLen), 9, ICCPIN);
					
					if((ICCPINLen % 2) == 1)
						CTOS_LCDTPrintXY((11 - (ICCPINLen/2)), 8, ICCStar);
					else if((ICCPINLen % 2) == 0)
						CTOS_LCDTPrintXY((11 - (ICCPINLen/2)), 8, ICCStar);
				}
				break;
			
			default:
				if((ICCKey >= '0' && ICCKey <= '9') && ICCPINLen < 12){
					ICCStar[ICCPINLen] = '*';//
					ICCPIN[ICCPINLen++] = ICCKey;
					//ICCStar[ICCStarLen++] = '*';
					CTOS_LCDTPrintXY(1, 8, "                    ");
					//CTOS_LCDTPrintXY(1, 9, "                    ");
					
					//CTOS_LCDTPrintXY((13 - ICCPINLen), 8, ICCStar);
					//CTOS_LCDTPrintXY((13 - ICCPINLen), 9, ICCPIN);
					
					if((ICCPINLen % 2) == 1)
						CTOS_LCDTPrintXY((10 - (ICCPINLen/2)), 8, ICCStar);
					else if((ICCPINLen % 2) == 0)
						CTOS_LCDTPrintXY((11 - (ICCPINLen/2)), 8, ICCStar);
				}else{
					CTOS_Delay(100);
					CTOS_Beep();
				}
				break;
		}
	}
}

void TouchOpen2(void){
    BYTE key;
    iX = 0, iY = 0;
    temp_iX = 0, temp_iY = 0;
    
    fd = open("/dev/input/event0", O_RDONLY | O_NONBLOCK ); //To open the touch panel's event and set non-block
    if(fd < 0){
        CTOS_LCDTPrintXY(1, 10, "TouchPanel Open Fail");
        CTOS_KBDGet(&key);
        return;
    }

    if(ioctl(fd, EVIOCGNAME(sizeof(str)), str) < 0) //To get the name of this input event
    {
        CTOS_LCDTPrintXY(1, 10, "   ioctl Open Fail  ");
        CTOS_KBDGet(&key);
        return;
    }
}

void Signature(void){
    BYTE    key;
    ULONG   rb;
    struct  input_event ev[5];
    BYTE    count = 0;
    int     TouchTimerFlag = 0;   
    int     i;
	ULONG	startT, endT;

Start_Touch:    
    memset(SignatureCanvas, 0x00, sizeof(SignatureCanvas));
	iX = 0, iY = 0;
    temp_iX = 0, temp_iY = 0;
    //SignatureCanvas[320 * (480/8)] = {0};
    
    CTOS_LCDGShowBMPPic(0, 0, "WaitforSign.bmp");
	EMVCL_ShowVirtualLED(NULL);
	EMVCL_SetLED(0x0F, 0x08);
    //TouchOpen();
	/*
    CTOS_LCDGSetBox(59,     //x_start
            79,             //y_start
            202,            //x_width
            322,            //y_width
            1);             //solid_box

    CTOS_LCDGSetBox(60,     //x_start
            80,             //y_start
            200,            //x_width
            320,            //y_width
            0);             //hollow_box
			*/
    
    while(1){
        CTOS_KBDHit(&key);
        if(key == d_KBD_CANCEL){
            goto Cnl_Touch;
        }else if(key == d_KBD_CLEAR){
            goto Start_Touch;
        }else if(key == d_KBD_ENTER){
            goto EXIT;
        }

        //if(TouchTimerFlag == 1){
         //   if(CTOS_TimeOutCheck(TIMER_ID_1) == d_YES){
         //       goto EXIT;
        //    }
        //}

		//if(TouchTimerFlag == 1){
		//	endT = CTOS_TickGet();
        //    if((endT - startT) > 1000){
        //        goto EXIT;
        //    }
        //}

        rb = read(fd, ev, sizeof(struct input_event) * 5);
        if (rb == -1)
            continue;

        if ( rb < sizeof(struct input_event) )
        {
            CTOS_LCDTPrintXY(1, 8, "  Read Input Fail!  ");
            close(fd);
            return;
        }

        if(TouchTimerFlag == 0){
            //CTOS_TimeOutSet(TIMER_ID_1, 1500);
			//startT = CTOS_TickGet();
            TouchTimerFlag = 1;
            //CTOS_LCDTPrintXY(1, 16, "    Timer Start!    ");
        }

        for (count = 0; count < rb/sizeof(struct input_event); count++){    
            if(EV_KEY == ev[count].type){
                if (ev[count].value == 1 ){
                    ;
                }
                else{
                        iX = iY = 0;
                }
            }
            if(EV_ABS == ev[count].type) //absolute values to the touch panel
            {
                if(ev[count].code == 0) // code 0 is equal to X-axis's coordinate
                {
                    temp_iX = ev[count].value;
                }
                else if(ev[count].code == 1) //code 1 is equal to Y-axis's coordinate
                {
                    temp_iY = ev[count].value;
                }
            }
            if(EV_SYN == ev[count].type){
                iX = temp_iX;
                iY = temp_iY;
                break;
            }

        }


        if ((iX != 0 ) && (iY != 0 )){
            if((iX > 0) && (iX < 320) && (iY > 150) && (iY < 330)){
                //---- draw touch point.
                CTOS_LCDGSetBox(iX,iY,5,5,1);
                for(i=(iX-2); i<=(iX+2); i++){
                    //SignatureCanvas[i + ((iY/8) * 320)] = 0xFF;
                    //SignatureCanvas[i + ((iY/8) * 320)] += 0x01 << (iY%8);
                    if((iY%8) == 0){
                        SignatureCanvas[i + ((iY/8) * 320)] = SignatureCanvas[i + ((iY/8) * 320)] | (0x01 << (iY%8)) | (0x01 << ((iY+1)%8)) | (0x01 << ((iY+2)%8));
                        //SignatureCanvas[i + ((iY/8) * 320)] =
                        continue;
                    }
                    if((iY%8) == 1){
                        SignatureCanvas[i + ((iY/8) * 320)] = SignatureCanvas[i + ((iY/8) * 320)] | (0x01 << (iY%8)) | (0x01 << ((iY+1)%8)) | (0x01 << ((iY-1)%8)) | (0x01 << ((iY+2)%8));
                        //SignatureCanvas[i + ((iY/8) * 320)] =
                        continue;
                    }
                    if((iY%8) == 6){
                        SignatureCanvas[i + ((iY/8) * 320)] = SignatureCanvas[i + ((iY/8) * 320)] | (0x01 << (iY%8)) | (0x01 << ((iY-1)%8)) | (0x01 << ((iY+1)%8)) | (0x01 << ((iY-2)%8));
                        continue;
                    }
                    if((iY%8) == 7){
                        SignatureCanvas[i + ((iY/8) * 320)] = SignatureCanvas[i + ((iY/8) * 320)] | (0x01 << (iY%8)) | (0x01 << ((iY-1)%8)) | (0x01 << ((iY-2)%8));
                        continue;
                    }
                    SignatureCanvas[i + ((iY/8) * 320)] = SignatureCanvas[i + ((iY/8) * 320)] | (0x01 << (iY%8)) | (0x01 << ((iY-1)%8)) | (0x01 << ((iY+1)%8)) | (0x01 << ((iY-2)%8)) | (0x01 << ((iY+2)%8));
                }  
            }          
        }

        //if(CTOS_TimeOutCheck(TIMER_ID_1) == d_YES){
        //    goto EXIT;
        //}

		//if(TouchTimerFlag == 1){
		//	endT = CTOS_TickGet();
        //    if((endT - startT) > 1000){
        //        goto EXIT;
        //    }
        //}
    }
	
    
Cnl_Touch:		
    //close(fd);
    return;
        
EXIT:    
    //close(fd);
    return;
}

BOOL TouchSignature(void){
	BYTE key;
	
Start_Sign:
	CTOS_LCDGShowBMPPic(0, 0, "WaitforSign.bmp");
	EMVCL_ShowVirtualLED(NULL);
	EMVCL_SetLED(0x0F, 0x08);
	memset(MonoSignBMPFile, 0x00, sizeof(MonoSignBMPFile));
	
	CTOS_LCDGSetBox(0,148,320,184,1);
	CTOS_TouchSignatureStart(1, 150, 318, 180, SignBMPFile, 0);
	//CTOS_TouchSignatureStart(0, 150, 320, 180, SignBMPFile, 0);
	
Continue_Sign:	
	CTOS_KBDGet(&key);
	sprintf(MonoSignBMPFile, "%s%d.bmp", MonoSignBMPFileName, TransHisCount);
	if(key == d_KBD_CANCEL){
		return 0;
	}else if(key == d_KBD_CLEAR){
		CTOS_TouchSignatureTerminate();
		unlink(SignBMPFile);
		goto Start_Sign;
	}else if(key == d_KBD_ENTER){
		CTOS_TouchSignatureTerminate();
        CTOS_BMPConverter(SignBMPFile, MonoSignBMPFile, d_BMP_CONVERT_ONE_BIT_COLOR);
		
		return 1;
	}else{
		goto Continue_Sign;
	}
}

USHORT Tx_EMV(ULONG ul){
	BYTE	SC_Status;
	BYTE	ICCTrade_Finishflag = 0;
	BYTE	MSRTrade_Finishflag = 0;
	USHORT 	usTk1Len, usTk2Len, usTk3Len;
	BYTE 	baTk1Buf[d_BUFF_SIZE], baTk2Buf[d_BUFF_SIZE], baTk3Buf[d_BUFF_SIZE];
	USHORT 	rtn;
	BYTE	buff[32];
	BYTE	ICCKey;
	BYTE	ICCPIN[8];
	BYTE	ICCStar[8];
	USHORT	ICCPINLen;
	USHORT	ICCStarLen;
	
	memset(ICCPIN, 0x00, sizeof(ICCPIN));
	memset(ICCStar, 0x00, sizeof(ICCStar));
	ICCStarLen = ICCPINLen = 0;
	//CTOS_LCDGShowBMPPic(0, 0, "background00.bmp");
	//ICC-----------------------------------------
	CTOS_SCStatus(d_SC_USER, &SC_Status);
	if(SC_Status & d_MK_SC_PRESENT)
	{
		EMVCL_CancelTransaction();
		//CTOS_LCDTClearDisplay();
		rtn = IccTXNProcess();
		
		if(rtn == d_OK)
			ICCTrade_Finishflag = 1;
		if(ICCTrade_Finishflag)
		{
			ICCTrade_Finishflag = 0;
			
			//enter pin code
			if(InputPIN() == d_NO){
				return d_PIN_FAIL;
			}
			
			//print
			CTOS_LCDGShowBMPPic(0, 0, "Printing.bmp");
			EMVCL_ShowVirtualLED(NULL);
			EMVCL_SetLED(0x0F, 0x08);
			prt_sample2(ul, 1);
			
			do{	
				CTOS_SCStatus(d_SC_USER, &SC_Status);
			}while(SC_Status & d_MK_SC_PRESENT);
				
			return d_OK;
		}
	}
	
	//MSR-----------------------------------------
	usTk1Len = usTk2Len = usTk3Len = d_BUFF_SIZE;
	rtn = CTOS_MSRRead(baTk1Buf, &usTk1Len, baTk2Buf, &usTk2Len, baTk3Buf, &usTk3Len);
	if(rtn != d_OK ||  usTk2Len == 0){
		/*
		CTOS_LCDTClearDisplay();
		sprintf(buff, "Card Error %04X ", rtn);
		CTOS_LCDTPrintXY(1, 4, buff);
		CTOS_LCDTPrintXY(1, 3, "      Error        ");
		*/
	}
	else{
		EMVCL_CancelTransaction();
		//CTOS_LCDTClearDisplay();
		rtn = MSRTXNProcess(baTk1Buf, usTk1Len, baTk2Buf, usTk2Len, baTk3Buf, usTk3Len);
		if(rtn == d_OK)
			MSRTrade_Finishflag = 1;
		if(MSRTrade_Finishflag)
		{
			MSRTrade_Finishflag = 0;
			
			//get signature
			if(!TouchSignature())
				return d_SIGN_FAIL;
			
			//print
			CTOS_LCDGShowBMPPic(0, 0, "Printing.bmp");
			EMVCL_ShowVirtualLED(NULL);
			EMVCL_SetLED(0x0F, 0x08);
			prt_sample2(ul, 2);
			return d_OK;
		}else{
			CTOS_LCDGShowBMPPic(0, 0, "SwipeInsertTap.bmp");
			EMVCL_ShowVirtualLED(NULL);
			EMVCL_SetLED(0x0F, 0x08);
		}
	}
	return d_NO;
}

void write_online_key(void)
{
  USHORT usRet;
  CTOS_KMS2KEYWRITE_PARA stKeyWritePara;
  
  memset(&stKeyWritePara, 0x00, sizeof(CTOS_KMS2KEYWRITE_PARA));
  
  stKeyWritePara.Info.KeySet = d_ONLINE_KEYSET;
  //stKeyWritePara.Info.KeySet = 0x1001;
  stKeyWritePara.Info.KeyIndex = d_ONLINE_KEYINDEX;
  stKeyWritePara.Info.KeyVersion = 0x01;
  stKeyWritePara.Info.KeyType = KMS2_KEYTYPE_3DES;
  stKeyWritePara.Info.KeyAttribute = KMS2_KEYATTRIBUTE_PIN;
  
  stKeyWritePara.Protection.Mode = KMS2_KEYPROTECTIONMODE_PLAINTEXT;
  //stKeyWritePara.Protection.Mode = KMS2_KEYPROTECTIONMODE_KPK_ECB;
  //stKeyWritePara.Verification.KeyCheckValueLength = 4;
  //stKeyWritePara.Verification.pKeyCheckValue = check_value;
  
  stKeyWritePara.Value.KeyLength = 16;
  stKeyWritePara.Value.pKeyData = d_ONLINE_KEY;
      
  usRet = CTOS_KMS2KeyWrite(&stKeyWritePara);
  printf("write_online_key usRet = %x\n",usRet);
  
  stKeyWritePara.Info.KeyIndex = d_OFFLINE_KEYINDEX;
  stKeyWritePara.Info.KeyAttribute = KMS2_KEYATTRIBUTE_ENCRYPT+KMS2_KEYATTRIBUTE_DECRYPT;
  
  usRet = CTOS_KMS2KeyWrite(&stKeyWritePara);
}

void OnDisplayShow(IN char *pStrMsg)  //add '\n' break line
{
//printf("OnDisplayShow 1\n");
    //CTOS_LCDTPrintXY(1, 3, pStrMsg);
//printf("OnDisplayShow 2\n");
}

void OnErrorMsg(IN char *pStrMsg)
{
//printf("OnErrorMsg 1\n");
    CTOS_LCDTPrintXY(1, 6, pStrMsg);
//printf("OnErrorMsg 2\n");
}

// This function will be called during EMV_Initialize;
void OnEMVConfigActive(INOUT BYTE* pActiveIndex)
{
	
}

USHORT OnTxnDataGet(OUT EMV_TXNDATA *pTxnData)
{
//printf("OnTxnDataGet 1\n");
    pTxnData->Version = 1;
    pTxnData->ulAmount = g_ulAMT;
//printf("OnTxnDataGet 2\n");    
    return d_OK;
}

#define d_FONTSIZE 16

BYTE ShowAPList(BYTE start_y, BYTE max_y, BYTE *sHeaderString, BYTE iHeaderStrLen, BYTE apnum, char aplist[][17], BYTE *selitem)
{
	BYTE str[20], i, curr_top, curr_off, c;
	BYTE hx = 1, hy = 1;
	BYTE baHeader[17];

	CTOS_LCDTClearDisplay();

	//Show [AP List]
	if (iHeaderStrLen <= d_FONTSIZE) {
		//by Center
		hx = ((d_FONTSIZE - iHeaderStrLen) / 2) + 1;
		memset(baHeader, 0x20, sizeof (baHeader));
		memcpy(&baHeader[hx - 1], sHeaderString, iHeaderStrLen);
		CTOS_LCDTPrintXY(1, 1, baHeader);
	}
        
	curr_top = 0;
	curr_off = 0; //Offset from curr_top

	while (1) {
		for (i = start_y; i <= max_y; i++)
			CTOS_LCDTPrintXY(1, i, (BYTE*)"                ");

		for (i = 0; i < max_y - start_y + 1; i++) {
			if (curr_top + i >= apnum)
				break;

			if (i == curr_off)
				CTOS_LCDTSetReverse(TRUE);

			CTOS_LCDTPrintXY(1, start_y + i, (BYTE*)aplist[curr_top + i]);

			if (i == curr_off)
				CTOS_LCDTSetReverse(FALSE);
		}

		CTOS_KBDGet(&c);

		//UP for V7, F1 for V9
		if (c == d_KBD_UP || c == d_KBD_F1) {
			if (curr_off > 0) {
				curr_off--;
			}
			else if (curr_top > 0 && curr_off == 0) {
				curr_top--;
			}
		} else if (c == d_KBD_DOWN || c == d_KBD_F4) {
			if (curr_top + curr_off + 1 < apnum) {
				if (curr_off < max_y - start_y) {
					curr_off++;
				} else if (curr_top + curr_off < apnum) {
					curr_top++;
				}
			}
		} else if (c == d_KBD_ENTER) {
			*selitem = curr_top + curr_off;
			return 0;
		} else if (c == d_KBD_CANCEL) {
			return 1;
		} else if (c >= '1' && c <= '9') {
			*selitem = c - '0' - 1;
			return 0;
		}
	}
}

// Range of pAppSelectedIndex value is 0 to (AppNum-1)    
USHORT OnAppList(IN BYTE AppNum, IN char AppLabel[][d_LABEL_STR_SIZE+1], OUT BYTE *pAppSelectedIndex)
{
//printf("OnAppList 1\n");
  BYTE sHeaderString[17];
    
    
    memset(sHeaderString, 0x00, sizeof(sHeaderString));
    sprintf(sHeaderString, "APP List");
//printf("OnAppList 2\n");    
    if (ShowAPList(2, 6, sHeaderString, strlen(sHeaderString), AppNum, AppLabel, pAppSelectedIndex) != 0)
        return d_EMVAPLIB_ERR_ABORT_TX;
//printf("OnAppList 3\n");    
    return d_EMVAPLIB_OK;
    
}

// Return d_OK to indicate CONFIRMED        
USHORT OnAppSelectedConfirm(IN BOOL IsRequiredbyCard, IN BYTE *pLabel, IN BYTE bLabelLen)
{
  return d_OK;
}
    
BOOL OnTerminalDataGet(IN USHORT usTag, INOUT USHORT *pLen, OUT BYTE *pValue)
{
    
    return FALSE;
}
    
BOOL OnCAPKGet(IN BYTE *pRID, IN BYTE bKeyIndex, OUT BYTE *pModulus, OUT USHORT *pModulusLen, OUT BYTE *pExponent, OUT USHORT *pExponentLen)
{
    
    return FALSE;
}
    
// Return d_OK to indicate Online PIN block is ready for application
USHORT OnOnlinePINBlockGet(OUT ONLINE_PIN_DATA *pOnlinePINData)
{
	return 0;
}
   
static int iTestCancel(void)
{
	return 0;
}

// Return d_OK to indicate Offline PIN block is ready for Kernel
// If this function uses KMS_GetEncOfflinePIN function to get offline pin, return d_EMV_ENTER_KMS_OFFLINEPIN to indicate enciphed offline PIN is ready for Kernel    
USHORT OnOfflinePINBlockGet(void)
{
	return 0;
}

void OnPINVerifyResult(IN USHORT usResult)
{
printf("OnPINVerifyResult 1\n");
   BYTE data[32];
    
   isOfflinePIN = TRUE;
   memset(data, 0, sizeof(data));
    
   if (usResult == d_PIN_RESULT_OK) 
   {
       isPIN_OK = TRUE;
       //"PIN Verify OK"
       sprintf(data, "PIN Verify OK");
   }
   else if (usResult == d_PIN_RESULT_FAIL) 
   {
       isPIN_OK = FALSE;
       //"!PIN Wrong!"
       sprintf(data, "PIN Wrong");
   }
   else if (usResult == d_PIN_RESULT_BLOCKED || usResult == d_PIN_RESULT_FAILBLOCKED) 
   {
       isPIN_OK = FALSE;
       //"!PIN Blocked!"
       sprintf(data, "PIN Blocked");
   }
   
   CTOS_LCDTPrintXY(1, 4, data);
   CTOS_Delay(2000);
	printf("OnPINVerifyResult 2\n");
}

void OnTxnOnline(IN ONLINE_PIN_DATA *pOnlinePINData, OUT EMV_ONLINE_RESPONSE_DATA* pOnlineResponseData)
{
printf("OnTxnOnline 1\n");
    if(pOnlinePINData->bPINLen == 0 && !isInsertPIN)
    {
        isPIN_OK = TRUE;
        pOnlineResponseData->bAction = d_ONLINE_ACTION_APPROVAL;
//        ret = InsertPIN(pOnlinePINData);
    }
    else
    {
        if(isOfflinePIN)
        {
            if(isPIN_OK)
            {
                pOnlineResponseData->bAction = d_ONLINE_ACTION_APPROVAL;
            }
            else
            {
                pOnlineResponseData->bAction = d_ONLINE_ACTION_DECLINE;
            }
        }
        else if(memcmp(SelectedAID, "\xA0\x00\x00\x00\x03", 5) == 0)
        {
            if(memcmp(pOnlinePINData->pPIN, "\x47\x67\x9C\x25\xF8\x48\x73\xA2", 8) == 0) 
            {          
                isPIN_OK = TRUE;
                pOnlineResponseData->bAction = d_ONLINE_ACTION_APPROVAL;
            }
            else
            {                   
                isPIN_OK = FALSE;
                pOnlineResponseData->bAction = d_ONLINE_ACTION_DECLINE;
            }
        }
        else
        {
            if(memcmp(pOnlinePINData->pPIN, "\x5C\x73\xAF\xC9\x85\x28\xCF\xF2", 8) == 0) 
            {
                isPIN_OK = TRUE;
                pOnlineResponseData->bAction = d_ONLINE_ACTION_APPROVAL;                
            }
            else
            {
                isPIN_OK = FALSE;
                pOnlineResponseData->bAction = d_ONLINE_ACTION_DECLINE;                
            }
        }
    }
        
//    CTOS_Delay(1500);
  
//    pOnlineResponseData->bAction = d_ONLINE_ACTION_APPROVAL;
    
    memcpy(baAuthorizationCode, "00", 2);
    pOnlineResponseData->pAuthorizationCode = baAuthorizationCode;
    pOnlineResponseData->pIssuerAuthenticationData = baIssuerAuthenticationData;
    pOnlineResponseData->pIssuerScript = baIssuerScript;
printf("OnTxnOnline 2\n");
}

void OnTxnIssuerScriptResult(IN BYTE* pScriptResult, IN USHORT pScriptResultLen)
{
	
}

void OnTxnResult(IN BYTE bResult, IN BOOL IsSignatureRequired)
{

}

void OnTotalAmountGet(IN BYTE *pPAN, IN BYTE bPANLen, OUT ULONG *pAmount)
{
    *pAmount = 0;
}

void OnExceptionFileCheck(IN BYTE *pPAN, IN BYTE bPANLen, OUT BOOL *isException)
{
	
}

BOOL OnCAPKRevocationCheck(IN BYTE *pbRID, IN BYTE bCAPKIdx, BYTE *pbSerialNumuber)
{
    return FALSE;
}

void OnGetPINNotify(IN BYTE bPINType, IN USHORT bRemainingCounter, OUT BOOL* pIsUseDefaultGetPINFunc, OUT DEFAULT_GETPIN_FUNC_PARA *pPara)
{
printf("OnGetPINNotify 1\n");
  BYTE pan[32];
  
  *pIsUseDefaultGetPINFunc = FALSE;
  isInsertPIN = TRUE;
  
  memset(pPara, 0x00, sizeof(DEFAULT_GETPIN_FUNC_PARA));
  pPara->usLineLeft_X = 5;
  pPara->usLineRight_X = 20;
  pPara->bPINDigitMaxLength = 12;
  pPara->bPINDigitMinLength = 4;
  pPara->usLinePosition_Y = 6;
  pPara->ulTimeout = 300;
  
  if (bPINType == d_NOTIFY_OFFLINE_PIN)
  {
    pPara->IsReverseLine = TRUE;
    pPara->IsRightToLeft = TRUE;
  
    //CTOS_LCDTPrintXY(1, 5, "Enter Offline PIN:");
    CTOS_LCDTPrintXY(1, 3, "Enter Offline PIN:");
  }else
  {
    pPara->ONLINEPIN_PARA.CipherKeyIndex = d_ONLINE_KEYINDEX;
    pPara->ONLINEPIN_PARA.CipherKeySet = d_ONLINE_KEYSET;
    pPara->ONLINEPIN_PARA.bPANLen = 16;
    memset(pan, 0x30, sizeof(pan));
    memset(pPara->ONLINEPIN_PARA.baPAN, 0x30, 16);
            
    //CTOS_LCDTPrintXY(1, 5, "Enter Online PIN:");
    CTOS_LCDTPrintXY(1, 3, "Enter Online PIN:");
  }
printf("OnGetPINNotify 2\n");
}

void OnOutputCardAPDU(IN BYTE *pTxAPDU, IN USHORT TxAPUDLen, IN BYTE *pRxAPDU, IN USHORT RxAPDULen)
{
  BYTE buff[1024];
  
  memset(buff, 0, sizeof(buff));
  CTOS_PrinterPutString("TxAPDU");
  wub_hex_2_str(pTxAPDU, buff, TxAPUDLen);
  CTOS_PrinterPutString(buff);
  
  memset(buff, 0, sizeof(buff));
  CTOS_PrinterPutString("RxAPDU");
  wub_hex_2_str(pRxAPDU, buff, RxAPDULen);
  CTOS_PrinterPutString(buff);
  
}

EMV_EVENT g_emv_event = 
{
    1,
	OnDisplayShow,
    OnErrorMsg, 
    OnEMVConfigActive, 
    NULL,
	OnTxnDataGet, 
    OnAppList,
    OnAppSelectedConfirm,
    OnTerminalDataGet,
    OnCAPKGet,
    OnGetPINNotify,
    OnOnlinePINBlockGet,
    OnOfflinePINBlockGet,
    OnPINVerifyResult,
    OnTxnOnline,
    OnTxnIssuerScriptResult,
    OnTxnResult,
    OnTotalAmountGet,
    OnExceptionFileCheck,
    OnCAPKRevocationCheck,
};


USHORT EMVPolling(ULONG ul) {
    BYTE ret;
    BYTE buff[32];
    USHORT rtn;

	/*
    CTOS_KMS2Init();
     
    ret = EMV_Initialize(&g_emv_event, d_EMV_CONFIG_FILE); 
    if(ret != d_OK)
    {
        sprintf(buff, "initial ret %04X ", ret);
        CTOS_LCDTPrintXY(1, 6, buff);  
        return d_NO;
    }
    CTOS_KMS2Erase();
    write_online_key();
    srand(time(NULL));
	*/

    rtn = Tx_EMV(ul);
    if(rtn == d_OK)
            return d_OK;
    return rtn;
}

void Polling_Card(ULONG ul)//
{
    BYTE ATQA[1024] = {0};
    BYTE SAK[1024] = {0};
    BYTE CSN[1024] = {0};
    BYTE CSNLen = 0;
    BYTE PUPI[1024] = {0};
	USHORT Rtn;
	BYTE Key;
	BYTE 			buff[32];
	USHORT 	usTk1Len, usTk2Len, usTk3Len;
	BYTE 	baTk1Buf[d_BUFF_SIZE], baTk2Buf[d_BUFF_SIZE], baTk3Buf[d_BUFF_SIZE];

	//Init EMVC
	CTOS_KMS2Init();
     
    Rtn = EMV_Initialize(&g_emv_event, d_EMV_CONFIG_FILE); 
    if(Rtn != d_OK)
    {
        sprintf(buff, "initial ret %04X ", Rtn);
        CTOS_LCDTPrintXY(1, 6, buff);  
        return;
    }
    CTOS_KMS2Erase();
    write_online_key();
    srand(time(NULL));
	
	//Clear MSR
	usTk1Len = usTk2Len = usTk3Len = d_BUFF_SIZE;
	CTOS_MSRRead(baTk1Buf, &usTk1Len, baTk2Buf, &usTk2Len, baTk3Buf, &usTk3Len);

	/*
    //PageClean();
    while(Key != d_KBD_CANCEL)
    {
		CTOS_KBDHit(&Key);
        //CTOS_LCDGShowPic(95,110,(BYTE *)baLCDLogo,sizeof(baLCDLogo),142);
		Rtn = CTOS_CLTypeAActiveFromIdle(0,ATQA,SAK,CSN,&CSNLen);
        if(Rtn == d_OK)
        {
            CTOS_CLPowerOff();
            CTOS_CLPowerOn();
            StartTrans(d_START_TRANS, ul);//ul    
			TransHisCount++;
            return;
        }
        CTOS_Delay(100);
		Rtn = CTOS_CLTypeBActive(PUPI);
        if(Rtn == d_OK)
        {
            CTOS_CLPowerOff();
            CTOS_CLPowerOn();
            StartTrans(d_START_TRANS, ul);//ul
			TransHisCount++;
            return;
        }
		CTOS_Delay(100);
		Rtn = EMVPolling(ul);
        if(Rtn == d_OK)
        {
			TransHisCount++;
            return;
        }else if(Rtn == d_PIN_FAIL){
			CTOS_LCDGShowBMPPic(0, 0, "SwipeInsertTap.bmp");
			EMVCL_ShowVirtualLED(NULL);
			EMVCL_SetLED(0x0F, 0x08);
		}
        
    }
	*/
	StartTrans(d_INIT_TRANS, ul);//ul
	TransHisCount++;
	return;
}
//------------------------------------------------------------------------------

BOOL CancelTransactionEvent(void) {
    BYTE k;

    CTOS_KBDHit(&k);

    if (k == '1') {
        return TRUE;
    }

    return FALSE;
}
//------------------------------------------------------------------------------

void ShowMessageEvent(BYTE bKernel, EMVCL_USER_INTERFACE_REQ_DATA *stUserInterfaceRequestData) {
    __DebugAddSTR("Enter Show Message Event");

    __DebugAddINT("Current Kernel", bKernel);
    __DebugAddHEX("Usr Req Data", (BYTE*) stUserInterfaceRequestData, sizeof (EMVCL_USER_INTERFACE_REQ_DATA));
}
//------------------------------------------------------------------------------
//------------------------------------------------------------------------------

void Transaction(ULONG ul) {//
    BYTE bKey;
    ULONG ulRtn;
    
    g_usScreenTopOffset = 0;
    g_ScreenSize_X = 20;
    g_ScreenSize_Y = 10;

    __DebugInit();

    __DebugAddINT("EMVCL_SetLED Rtn", ulRtn);

    g_isForcedOnl = FALSE;
    Wave2TransactionEnable();        

	EMVCL_StartIdleLEDBehavior(NULL);

	CTOS_LCDGShowBMPPic(0, 0, "SwipeInsertTap.bmp");
	EMVCL_ShowVirtualLED(NULL);
	EMVCL_SetLED(0x0F, 0x08);
	Polling_Card(ul);//
	CTOS_Delay(1000);

    EMVCL_StopIdleLEDBehavior(NULL);
    EMVCL_SetLED(0x0F, 0x08);
}