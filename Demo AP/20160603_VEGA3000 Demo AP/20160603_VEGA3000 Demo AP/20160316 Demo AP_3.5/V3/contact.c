/** 
**	A Template for developing new terminal application
**/

#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdarg.h>
/** These two files are necessary for calling CTOS API **/
#include <ctosapi.h>
#include <emvaplib.h>
#include <emvlib.h>
#include <fcntl.h>
#include <linux/input.h>
#include <unistd.h> 
#include "Transaction.h"
#include "appmain.h"

#define SignBMPFile "Signature.bmp"
#define MonoSignBMPFile "Signature_Mono.bmp"

#define MSR 1
#define SC  2
#define CL 3
#define V3_24_AP 1
#define Scan_key_timer  10
#define Screen_saver_timer 100
#define Show_screen_saver_timer 100

//extern BYTE baPrinterp_1[];
//extern BYTE baPrinterLogo[];
extern const BYTE EZ710BU_2F[320 * 240 * 3];
extern const BYTE QPROX_3F[320 * 240 * 3];

//EMV
#define d_BUFF_SIZE 128 
#define d_ONLINE_KEYSET         0x2001
#define d_ONLINE_KEYINDEX       0x0000
#define d_OFFLINE_KEYINDEX      0x0001
#define d_ONLINE_KEY            "\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11\x11"
#define d_EMV_CONFIG_FILE       "emv_config.xml"

BYTE CardSNbuf[128];
BYTE CardExpDatebuf1[32];
BYTE CardExpDatebuf2[128];
/*
ULONG g_ulAMT = 0;
BOOL isOfflinePIN = FALSE;
BOOL isPIN_OK = FALSE;
BOOL isInsertPIN = FALSE;
static BYTE baAuthorizationCode[4]; 
static BYTE baIssuerAuthenticationData[128];
static BYTE baIssuerScript[256]; 
*/

CTOS_FONT_ATTRIB FONT_ATTRIB;
//BYTE SelectedAID[16];

//Qt Simu
int     fd;
BYTE    str[256];
int     iX,iY;
int     temp_iX,temp_iY;
//BYTE    SignatureCanvas[320 * (480/8)];
BYTE    SignatureCanvas[180 * 320];

//****************************************************************************
USHORT usTk1Len, usTk2Len, usTk3Len;
BYTE baTk1Buf[79 + 10], baTk2Buf[40 + 10], baTk3Buf[107 + 10];
char sInputAmount[20]; //Input Amount String
ULONG ulTxAmount;
CTOS_RTC stRTC;
int wub_strlen(unsigned char *str);
//****************************************************************************
extern ULONG ASCII2Int(BYTE *baSBuf, int iL);
extern unsigned int wub_hex_2_str(unsigned char *hex, unsigned char *str, unsigned int len);
extern ULONG EMVCL_ShowVirtualLED(void *pPara);
extern ULONG EMVCL_SetLED(BYTE bIndex, BYTE bOnOff);
extern void wub_memcpy(unsigned char *dest, unsigned char *sour, unsigned int len);

void PrintSet11(void) {
    FONT_ATTRIB.FontSize = d_FONT_12x24; //Font Size = 12x24 //
    FONT_ATTRIB.X_Zoom = 1; //The width magnifies X_Zoom diameters //
    FONT_ATTRIB.Y_Zoom = 1; //The height magnifies Y_Zoom diameters //
    FONT_ATTRIB.X_Space = 0;
    FONT_ATTRIB.Y_Space = 0;
}

void PrintSet12(void) {
    FONT_ATTRIB.FontSize = d_FONT_12x24; //Font Size = 12x24 //
    FONT_ATTRIB.X_Zoom = 1; //The width magnifies X_Zoom diameters //
    FONT_ATTRIB.Y_Zoom = 2; //The height magnifies Y_Zoom diameters //
    FONT_ATTRIB.X_Space = 0;
    FONT_ATTRIB.Y_Space = 0;
}

void PrintSet22(void) {
    FONT_ATTRIB.FontSize = d_FONT_12x24; //Font Size = 12x24 //
    FONT_ATTRIB.X_Zoom = 2; //The width magnifies X_Zoom diameters //
    FONT_ATTRIB.Y_Zoom = 2; //The height magnifies Y_Zoom diameters //
    FONT_ATTRIB.X_Space = 0;
    FONT_ATTRIB.Y_Space = 0;
}
//****************************************************************************

void Print_Normal(BYTE *sInputAmount) {
    BYTE bKey;
    //ULONG j;
    BYTE baTemp[384 * 736], strprint[50] = {0};

//    CTOS_PrinterLogo((BYTE *) baPrinterLogo, 0, 328, 6);
    PrintSet11();
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 64, "          SALE TESTING          ", &FONT_ATTRIB);
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 88, "       CASTLES TECHNOLOGY       ", &FONT_ATTRIB);
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 112, "          HAPPY RETAIL          ", &FONT_ATTRIB);
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 136, "           BANK CARDS           ", &FONT_ATTRIB);
    PrintSet22();
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 110, 200, "DEMO", &FONT_ATTRIB);
    PrintSet11();
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 10, 280, "Date/Time", &FONT_ATTRIB);
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 10, 304, "MERCHANT ID: 000009876543210", &FONT_ATTRIB);
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 10, 328, "BATCH NUM  : 000001", &FONT_ATTRIB);
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 10, 352, "INVOICE NUM: 00001", &FONT_ATTRIB);
    PrintSet22();
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 80, 400, "WAVE SALE", &FONT_ATTRIB);
    PrintSet11();
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 10, 470, "CARD NUM: 4563 0181 0005 1401", &FONT_ATTRIB);
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 10, 494, "EXP DATE: 09/10", &FONT_ATTRIB);
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 10, 528, "APPR CODE: 111", &FONT_ATTRIB);
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 10, 552, "CARD TYPE: BANK", &FONT_ATTRIB);
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 10, 576, "REF NUM: 010203040506", &FONT_ATTRIB);
    PrintSet12();
    memset(strprint, 0, sizeof (strprint));
    sprintf(strprint, "AMOUNT:  EURO  %s", sInputAmount);
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 10, 648, strprint, &FONT_ATTRIB);
    PrintSet11();

    CTOS_PrinterBufferOutput((BYTE *) baTemp, 88);
    CTOS_LanguagePrinterFontSize(d_FONT_24x24, 0, d_FONT_TYPE1);

    CTOS_PrinterPutString("\fr     NO SIGNATURE REQUIRED     ");
    CTOS_PrinterPutString(" ");
    CTOS_PrinterPutString("SIGN:_______________________");
    CTOS_PrinterPutString(" ");
    CTOS_PrinterPutString(" ");
    CTOS_PrinterPutString("I AGREE TO PAY THE ABOVE TOTAL  ");
    CTOS_PrinterPutString("AMOUNT, ACCORDING TO THE CARD ");
    CTOS_PrinterPutString("ISSUER AGREEMENT");
    CTOS_PrinterPutString(" ");
    CTOS_PrinterPutString("CUSTOMER COPY");
    CTOS_PrinterPutString(" ");
    CTOS_PrinterPutString(" ");
    CTOS_PrinterPutString(" ");
    CTOS_PrinterPutString(" ");
    CTOS_PrinterPutString(" ");
    CTOS_PrinterPutString(" ");
}

typedef struct {
    BYTE bType;
    BYTE baATQA[2];
    BYTE bSAK;
    BYTE bCSNLen;
    BYTE baCSN[10];
    BYTE bAutoPPS;
    UINT uiATSLen;
    BYTE baATS[128];
    BYTE baPUPI[4];
} CL_CARD_INFO;


/*
ULONG A_ActiveIdle(CL_CARD_INFO *pstIccInfo)
{
    BYTE bBaudRate;
    ULONG ulRtn;

    bBaudRate = 0x00; // 106K baud rate
    pstIccInfo->bType = 0x00; // clear ICC type
    ulRtn = CTOS_CLActiveIdle(bBaudRate, pstIccInfo->baATQA, &pstIccInfo->bSAK, &pstIccInfo->bCSNLen, pstIccInfo->baCSN);
    if(ulRtn != 0)
    {
        return ulRtn;
    }

    pstIccInfo->bType = 1;
    return 0;
}

ULONG A_Rats(CL_CARD_INFO *pstIccInfo)
{
    ULONG ulRtn;
    USHORT uslen;

    uslen = sizeof(pstIccInfo->baATS);
    pstIccInfo->bAutoPPS = 0; // Use default 106K baud rate
    ulRtn = CTOS_TclRATS(pstIccInfo->bAutoPPS, &uslen, pstIccInfo->baATS, sizeof(pstIccInfo->baATS));
    if(ulRtn != 0)
    {
        return ulRtn;
    }

    pstIccInfo->bType = 1; // CL type A
    pstIccInfo->uiATSLen = uslen;
    return 0;
}

ULONG B_Poweron(CL_CARD_INFO *pstIccInfo)
{
    ULONG ulRtn;

    pstIccInfo->bType = 0x00; // clear ICC type
    ulRtn = CTOS_CLTypeBPowerOn(pstIccInfo->baPUPI);
    if(ulRtn != 0)
    {
        return ulRtn;
    }

    pstIccInfo->bType = 2; // CL type B
    return 0;
}
 */
const BYTE baPrinterBufferLogo_Receipt2[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0xC0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF8,
    0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0x78, 0x78, 0x7C, 0x78, 0x78, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8,
    0xF8, 0xF0, 0xF0, 0xF0, 0xE0, 0xE0, 0xC0, 0xC0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0xF8, 0xFE, 0xFF, 0xFF, 0xFC, 0xF8,
    0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x80, 0x80,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0, 0xF8,
    0xF8, 0xFC, 0x7E, 0x3F, 0x1F, 0x1F, 0x0F, 0x07, 0x07, 0x87, 0x83, 0xC3, 0xC1, 0xE1, 0xE1, 0xE0,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0,
    0xE0, 0xE1, 0xC1, 0xC1, 0x83, 0x83, 0x07, 0x07, 0x0F, 0x1F, 0x1F, 0x3F, 0x7E, 0xFC, 0xFC, 0xF8,
    0xF0, 0xE0, 0xC0, 0x80, 0x80, 0xE0, 0xF8, 0xFE, 0xFF, 0xFF, 0x3F, 0x0F, 0x07, 0x03, 0x07, 0x1F,
    0x3F, 0xFF, 0xFF, 0xFC, 0xF0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0xF8, 0xFC,
    0xFE, 0xFF, 0xFF, 0x7F, 0x3F, 0x1F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x1F, 0x3F, 0x7F, 0xFF,
    0xFF, 0xFF, 0xFE, 0xFC, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xE0, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF8,
    0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0,
    0xF8, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x1F, 0x3F,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xF8, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0x0F, 0x0F,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
    0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0x1F,
    0x1F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x1F, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xF8, 0xE0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xE0, 0xF8, 0xFC, 0xFF, 0x7F, 0x3F, 0x0F, 0x07, 0x03,
    0x01, 0xC0, 0xE0, 0xF0, 0xF8, 0xFC, 0xFE, 0x7E, 0x3F, 0x1F, 0x0F, 0x0F, 0x07, 0x07, 0x03, 0x83,
    0x83, 0xC1, 0xC1, 0xC1, 0xC1, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE1, 0xC1, 0xC1, 0xC1, 0x81, 0x83,
    0x03, 0x07, 0x07, 0x07, 0x0F, 0x1F, 0x3F, 0x7F, 0xFE, 0xFC, 0xF8, 0xF0, 0xE0, 0xC0, 0x81, 0x03,
    0xC7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x0F, 0x03, 0x00, 0x80, 0xE0, 0xF0, 0xF8, 0xE0, 0xC0,
    0x00, 0x00, 0x03, 0x07, 0x1F, 0x7F, 0xFF, 0xFE, 0xFC, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
    0x03, 0x03, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xC0, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x01, 0x00, 0x07, 0x3F, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFE, 0xF0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03,
    0x1F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFE, 0xFC, 0xF8, 0xF8, 0xF8, 0xF8, 0xF0, 0xF0, 0xF0, 0xE0,
    0xE1, 0xC1, 0xC1, 0x81, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFE,
    0xFC, 0xF8, 0xF8, 0xF8, 0xF8, 0xF0, 0xF0, 0xF0, 0xE0, 0xE0, 0xE1, 0xC1, 0x81, 0x81, 0x01, 0x01,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xC0, 0xF8, 0xFE, 0xFF, 0xFF, 0x3F, 0x07, 0x01, 0x00, 0x00, 0xE0, 0xF8, 0xFE,
    0xFF, 0xFF, 0x3F, 0x0F, 0x03, 0x01, 0x00, 0x80, 0xE0, 0xF0, 0xF8, 0xFC, 0xFE, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x7F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFE, 0xFE, 0xFC, 0xF8, 0xE0, 0xC0, 0x00, 0x01, 0x03, 0x0F, 0xDF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x1F, 0x0F, 0x03, 0x00, 0x80, 0xE0, 0xF8, 0xFC, 0xFF, 0xFF, 0x3F, 0x1F, 0x7F, 0xFF,
    0xFF, 0xFC, 0xF0, 0xE0, 0x80, 0x00, 0x01, 0x03, 0x0F, 0x1F, 0x7F, 0xFF, 0xFE, 0xF8, 0xE0, 0xC0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
    0xE0, 0xC0, 0xC0, 0xC0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xF0,
    0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF7, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF1, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC1, 0x01, 0x03, 0x03, 0x03, 0x07, 0x07, 0x07, 0x0F, 0x0F, 0x0F, 0x1F,
    0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x03,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC1, 0x01, 0x03,
    0x03, 0x03, 0x07, 0x07, 0x07, 0x0F, 0x0F, 0x0F, 0x1F, 0x1F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC,
    0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0xFF, 0xFF, 0xFF,
    0x0F, 0x00, 0x00, 0x00, 0x00, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xC1, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC1, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xFE, 0xFF, 0xFF, 0x7F, 0x1F, 0x07,
    0x01, 0x00, 0x80, 0xE0, 0xF8, 0xFE, 0xFF, 0x7F, 0x3F, 0x0F, 0x03, 0x00, 0x80, 0x80, 0x00, 0x00,
    0x03, 0x07, 0x1F, 0x7F, 0xFF, 0xFE, 0xFC, 0xF0, 0xC0, 0x80, 0x00, 0x01, 0x07, 0x1F, 0x3F, 0xFF,
    0xFF, 0xFC, 0xF0, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x3F, 0x7F,
    0xFF, 0xFF, 0xFF, 0xFC, 0xF8, 0xF0, 0xF0, 0xE0, 0xE0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF8, 0xFE, 0xFF,
    0xFF, 0xFF, 0x7F, 0x3F, 0x0F, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xFC, 0xFF, 0xFF,
    0xFF, 0xFF, 0x7F, 0x0F, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF8, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F,
    0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFE, 0xF8, 0xF0, 0xF0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xF0, 0xF0,
    0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x1F, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
    0xF0, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
    0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFE, 0xFC,
    0xF0, 0xF0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF8, 0xFE, 0xFF, 0xFF, 0xFF, 0x7F, 0x1F,
    0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0x00, 0x00, 0x00, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF,
    0xE0, 0x00, 0x00, 0x00, 0x00, 0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x1F, 0x07, 0x01, 0x00, 0x80, 0xE0,
    0xF8, 0xFE, 0xFF, 0x7F, 0x1F, 0x07, 0x03, 0x00, 0x00, 0xE0, 0xF8, 0xFE, 0xFF, 0xFF, 0xFE, 0xF8,
    0xF0, 0xC0, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x3F, 0x7F, 0xFF, 0xFE, 0xF8, 0xF0, 0xC0, 0x00, 0x00,
    0x03, 0x07, 0x1F, 0x7F, 0xFF, 0xFE, 0xFC, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x01, 0x01, 0x03, 0x03, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x03, 0x03, 0x03,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x03, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x03, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x03, 0x1F, 0xFF, 0xFF, 0xFF, 0xFC, 0xE0, 0x80, 0x00, 0x00, 0x07, 0x1F, 0x7F,
    0xFF, 0xFF, 0xF8, 0xF0, 0xC0, 0x80, 0x00, 0x03, 0x07, 0x1F, 0x3F, 0x3F, 0x7F, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 0x1F, 0x0F, 0x03, 0x00, 0x00, 0xC0, 0xE0, 0xF8, 0xFE, 0xFF, 0x3F,
    0x1F, 0x07, 0x01, 0x00, 0x00, 0xC0, 0xF0, 0xFE, 0xFF, 0xFF, 0x3F, 0x0F, 0x03, 0x01, 0x07, 0x0F,
    0x3F, 0x7F, 0xFF, 0xFE, 0xF8, 0xE0, 0xC0, 0x00, 0x00, 0x01, 0x07, 0x0F, 0x3F, 0xFF, 0xFF, 0xFE,
    0xF8, 0xE0, 0x80, 0x00, 0x00, 0x03, 0x0F, 0x1F, 0x7F, 0xFF, 0xFE, 0xF8, 0xF0, 0xC0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
    0xF0, 0xE0, 0xE0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0,
    0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF0,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xF0, 0xF0, 0xF0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0,
    0xE0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xE0,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0xE0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x70, 0xF0, 0xF0, 0xF0, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xF0, 0xF0,
    0xF0, 0xF0, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x1F, 0x7F, 0xFF, 0xFE, 0xFC, 0xF0, 0xE0, 0xC0,
    0x80, 0x03, 0x07, 0x0F, 0x1F, 0x3F, 0x3F, 0x7E, 0xFC, 0xF8, 0xF0, 0xF0, 0xE0, 0xE0, 0xC1, 0xC1,
    0x83, 0x83, 0x83, 0x83, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x83, 0x83, 0x83, 0xC1,
    0xC1, 0xC0, 0xE0, 0xE0, 0xF0, 0xF8, 0xF8, 0x7C, 0x7E, 0x3F, 0x1F, 0x0F, 0x03, 0x01, 0x00, 0xC0,
    0xE0, 0xF0, 0xF8, 0xFE, 0xFF, 0x7F, 0x3F, 0x0F, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x07, 0x0F, 0x3F, 0xFF, 0xFF, 0xFC, 0xF8, 0xE0, 0xC0, 0x00, 0x00, 0x03, 0x07,
    0x1F, 0x7F, 0xFF, 0xFF, 0xFC, 0xF0, 0xE0, 0x80, 0x00, 0x01, 0x03, 0x0F, 0x3F, 0xFF, 0xFF, 0xFC,
    0xF8, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0xE1, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xC0, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xF8, 0xFE, 0xFF, 0xFF, 0xFF, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x07, 0x0F, 0x07, 0x07, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xE0,
    0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0x7F, 0xFF, 0xFC, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0xFF,
    0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0x0F, 0x03, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0xFF, 0xFF, 0xFF, 0xFC, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0x0F, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03,
    0x07, 0xFF, 0xFF, 0xFF, 0xFC, 0xE0, 0x00, 0x00, 0x00, 0x80, 0xFC, 0xFF, 0xFF, 0xFF, 0x0F, 0x03,
    0x01, 0x00, 0x00, 0x00, 0x80, 0x80, 0x81, 0x83, 0x87, 0x87, 0x87, 0x87, 0x80, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x03, 0x1F, 0x3F, 0xFF, 0xFE, 0xF8, 0xE0, 0xF0, 0xFC, 0xFF, 0x7F, 0x1F, 0x07,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x0F, 0x1F,
    0x3F, 0x7F, 0x7E, 0xFC, 0xF8, 0xF8, 0xF0, 0xE0, 0xE0, 0xC1, 0xC1, 0x83, 0x83, 0x87, 0x07, 0x07,
    0x0F, 0x0F, 0x0F, 0x0F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x0F, 0x0F, 0x0F, 0x0F,
    0x07, 0x87, 0x83, 0x83, 0xC3, 0xC1, 0xE0, 0xE0, 0xF0, 0xF0, 0xF8, 0xFC, 0x7E, 0x7E, 0x3F, 0x1F,
    0x0F, 0x07, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x07, 0x0F, 0x3F, 0xFF, 0xFF, 0xFC, 0xF0, 0xE0,
    0x80, 0x00, 0x00, 0x03, 0x07, 0x1F, 0x7F, 0xFF, 0xFE, 0xFC, 0xF0, 0xC0, 0x80, 0x00, 0x01, 0x07,
    0x1F, 0x3F, 0xFF, 0xFE, 0xFC, 0xF0, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0x83, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x1F, 0x7F, 0xFF, 0xFF, 0xFF, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x80, 0xE0, 0xF8, 0xF0, 0xF0, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x01, 0x07, 0x0F, 0x7F, 0xFF, 0xFE, 0xFC, 0xFF, 0xFF,
    0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0xFF, 0xFF, 0xFF, 0xF0, 0xC0, 0x80, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xFF, 0xFF, 0xFF, 0x3F, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x3F, 0xFF, 0xFF, 0xFF, 0xF0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0,
    0xE0, 0xFF, 0xFF, 0xFF, 0x3F, 0x07, 0x00, 0x00, 0x00, 0x01, 0x3F, 0xFF, 0xFF, 0xFF, 0xF0, 0xC0,
    0x80, 0x00, 0x00, 0x00, 0x07, 0x07, 0x87, 0x87, 0xC7, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x07, 0x07, 0x0F, 0x0F, 0x0F, 0x1F, 0x1F,
    0x1F, 0x1F, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x1F, 0x1F, 0x1F,
    0x1F, 0x0F, 0x0F, 0x0F, 0x07, 0x07, 0x07, 0x03, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x07, 0x07, 0x07,
    0x07, 0x06, 0x04, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x07, 0x07, 0x07, 0x06, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x03, 0x07, 0x07, 0x07, 0x07, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x07, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
    0x0F, 0x07, 0x07, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x0F, 0x0F,
    0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x07, 0x0F, 0x0F, 0x0F,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x07, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
    0x07, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x07,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x07, 0x07, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

};

static void prt_sample(BYTE *iCounter) {
    BYTE baTemp[384 * 64]; // The width of paper is 384 dot.

    //Font atrributes
    CTOS_FONT_ATTRIB stFONT_ATTRIB;

    //Auxiliar char buffer
    UCHAR charBuffer[50];

    // Auxiliar PAN number
    UCHAR applicationAIDAux[40];

    // Auxiliar PAN number
    UCHAR PANNumberAux[40];

    // Lenght of PAN number
    BYTE lenghtPANNumber;

    BYTE Timer_printSTR[40] = {0};

    CTOS_PrinterFline(5);

    //Print out the bank logo
    CTOS_PrinterLogo((BYTE *) baPrinterBufferLogo_Receipt2, 0, 380, 10);
    CTOS_PrinterFline(12);

    stFONT_ATTRIB.X_Space = 0;
    //The height of the space between the font with next font
    stFONT_ATTRIB.Y_Space = 0;
    memset(baTemp, 0x00, sizeof (baTemp));
    stFONT_ATTRIB.FontSize = d_FONT_8x16;
    //Double de X size
    stFONT_ATTRIB.X_Zoom = 3;
    //Double de Y size
    stFONT_ATTRIB.Y_Zoom = 4;
    //The width of the space between the font with next font
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, (BYTE *) "VEGA3000", &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 6);
    CTOS_PrinterFline(20);

    //==============================
    //Print out the transaction data
    //==============================
    CTOS_PrinterPutString((BYTE *) "MER ID: 886289131771");
    CTOS_PrinterFline(5);
    strcpy((char *) applicationAIDAux, "BATCH NO: 000307");
    CTOS_PrinterPutString(applicationAIDAux);
    CTOS_PrinterFline(5);


    memset(baTemp, 0x00, sizeof (baTemp));

    stFONT_ATTRIB.FontSize = d_FONT_8x16;
    stFONT_ATTRIB.X_Zoom = 2;
    stFONT_ATTRIB.Y_Zoom = 2;

    CTOS_PrinterPutString((unsigned char *) "CARD NO:");
    CTOS_PrinterFline(12);

    lenghtPANNumber = strlen("  ********************");
    strcpy((char *) PANNumberAux, "  ********************");
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, PANNumberAux, &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 8);

    CTOS_PrinterPutString((BYTE *) "EXP. DATE: 2016/08");
    CTOS_PrinterFline(5);
    CTOS_PrinterPutString((BYTE *) "ISSUER: 84188062");
    CTOS_PrinterFline(15);

    memset(baTemp, 0x00, sizeof (baTemp));
    stFONT_ATTRIB.FontSize = d_FONT_8x16;
    stFONT_ATTRIB.X_Zoom = 3;
    stFONT_ATTRIB.Y_Zoom = 2;
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, (BYTE *) "       BOOK/SALE", &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 6);
    CTOS_PrinterFline(12);

    CTOS_PrinterPutString((BYTE *) "TERM ID: 11010001   OPER ID: 002");
    CTOS_PrinterFline(5);
    CTOS_RTCGet(&stRTC);
    sprintf((char *) Timer_printSTR, "DATE:%02d/%02d/20%02d    TIME:%02d:%02d", stRTC.bDay, stRTC.bMonth, stRTC.bYear, stRTC.bHour, stRTC.bMinute);
    CTOS_PrinterPutString((BYTE *) Timer_printSTR);
    //CTOS_PrinterPutString((BYTE *)"DATE: 31/10/2012    TIME: 14:52");
    CTOS_PrinterFline(5);
    CTOS_PrinterPutString((BYTE *) "REF NO: 855090913452");
    CTOS_PrinterFline(15);

    sprintf((char *) charBuffer, "      $ %s", iCounter);
    stFONT_ATTRIB.FontSize = d_FONT_8x16;
    stFONT_ATTRIB.X_Zoom = 3;
    stFONT_ATTRIB.Y_Zoom = 4;
    memset(baTemp, 0x00, sizeof (baTemp));
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, (BYTE *) charBuffer, &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 6);

    CTOS_PrinterFline(40);
    CTOS_PrinterPutString((BYTE *) "===== CARDHOLDER SIGNATURE =====");
    CTOS_PrinterFline(10);

    CTOS_PrinterPutString((BYTE *) "\n\n");
}

//****************************************************************************

//unsigned int wub_strlen(unsigned char *str) {
//    unsigned int i;
//    i = 0;
//    while (str[i++] != 0x00);
//    return i - 1;
//}

void PrintCenter(BYTE y, STR *sBuf) {
    CTOS_LCDTPrintXY(1, y, (BYTE*) "                ");
    CTOS_LCDTPrintXY((16 - wub_strlen(sBuf)) / 2 + 1, y, sBuf);
}

//	x: X position
//	y: Y position
//	min: Minimum length of the input data
//	max: Maximum length of the input data
//	mask: If maskchar = 0, don't need mask char, if > 0, it will show to screen.

char AP_Get_Input(BYTE x, BYTE y, BYTE min, BYTE max, char mask, char *buf, BYTE *len) {
    BYTE ilen;
    BYTE c[2];
    BYTE isGetDot;

    CTOS_LCDTGotoXY(x, y);

    ilen = 0;
    c[1] = 0; //NULL
    isGetDot = FALSE;

    while (TRUE) {
        CTOS_KBDGet(c);

        if ((c[0] >= '0' && c[0] <= '9') || c[0] == d_KBD_DOT) //0-9 and .
        {
            if (x <= 16 && ilen < max) {
                if (c[0] == d_KBD_DOT) //d_KBD_DOT = Q'
                {
                    if (isGetDot == TRUE)
                        continue;

                    c[0] = '.';
                    isGetDot = TRUE;
                }

                buf[ilen++] = c[0];
                if (mask == 0)
                    CTOS_LCDTPutchXY(x, y, c[0]);
                else
                    CTOS_LCDTPutchXY(x, y, mask);

                x++;
            }
        } else if (c[0] == d_KBD_CLEAR) //clear
        {
            if (ilen > 0) {
                if (buf[ilen - 1] == '.')
                    isGetDot = FALSE;

                ilen--;
                x--;
                CTOS_LCDTPutchXY(x, y, ' ');
            }
        } else if (c[0] == d_KBD_CANCEL) //cancel
        {
            return FALSE;
        } else if (c[0] == d_KBD_ENTER && ilen >= min) //enter
        {
            *len = ilen;
            buf[ilen] = 0x00; //put end of string
            return TRUE;
        }
    }
}

void Tx(BYTE Type) {
    USHORT ret;
    BYTE c, baATR[128], bATRLen, CardType;
    BYTE str[50], i, key, key1 = 0, j = 0, SC_Status;
    ULONG cnt;
    BYTE SelectedAIDLen;
    BYTE label[32];
    BYTE label_len;
    BYTE buff[128]={0};
    BYTE value[128];
    USHORT len;

    //Input Amount
//    CTOS_LCDTClearDisplay();
//    CTOS_LCDGShowBMPPic(0, 0, "background00.bmp");
//    CTOS_LCDTPrintXY(1, 1, "\fr      SALE      \fn");
//    PrintCenter(3, "Enter amount");
//    CTOS_LCDTPrintXY(1, 4, "$");

    memset(sInputAmount, 0, sizeof (sInputAmount));
    memset(baATR, 0, sizeof (baATR));
    bATRLen = sizeof (baATR);

        CTOS_SCStatus(d_SC_USER, &SC_Status);

        //ret = CTOS_SCResetISO(0, d_SC_5V, baATR, &bATRLen, &CardType);
        if (Type == MSR || (SC_Status & d_MK_SC_PRESENT && Type == SC) || Type == CL) {
//////////////////////////////////////////////////////////////////////////////////////////////////////       

                //len = sizeof(value);
                
                //EMV_DataGet(d_TAG_TRACK2_EQUIVALENT_DATA, &len, value);
                //memset(buff, 0, sizeof(buff));
                //len = wub_hex_2_str(value, buff, len);


//////////////////////////////////////////////////////////////////////////////////////////////////////
            CTOS_LCDTClearDisplay();
            CTOS_LCDGShowBMPPic(0, 0, "background00.bmp");
//            CTOS_LCDTPrintXY(1, 1, "\fr Communications \fn");
            CTOS_LEDSet(0, 1);
            PrintCenter(4, "Processing...");

            CTOS_Delay(1000);

            PrintCenter(4, "Connecting...");

            CTOS_Delay(1000);

            CTOS_LCDTClearDisplay();
            CTOS_LCDGShowBMPPic(0, 0, "background00.bmp");
//            CTOS_LCDTPrintXY(1, 1, "\fr    Approval    \fn");
            CTOS_LEDSet(0, 0);
            CTOS_LEDSet(2, 1);

            memset(str, 0, sizeof (str));
            sprintf(str, "      $ %s", sInputAmount);
//            CTOS_LCDTPrintXY(1, 4, str);
#if V3_24_AP
            PrintCenter(6, "Print Wait...");
            prt_sample(g_baInputAmt);
            PrintCenter(6, "");
#else

#endif
            //Print_Normal(sInputAmount);
        } else {
            CTOS_LCDTClearDisplay();
            CTOS_LCDGShowBMPPic(0, 0, "background00.bmp");
//            CTOS_LCDTPrintXY(1, 1, "\fr    Approval    \fn");
            PrintCenter(5, "Card Error!!");
            PrintCenter(6, "Remove Card"); //Remove Card

            memset(str, 0, sizeof (str));
            for (i = 3; i > 0; i--) {
                memset(str, 0, sizeof (str));
                sprintf(str, " Please Wait %d ", i - 1);
                CTOS_LCDTPrintXY(1, 6, str);
                CTOS_Delay(1000);
            }
        }

    if (Type == MSR) {
        PrintCenter(6, " Please Any Key ");
        CTOS_KBDGet(&key1);
        CTOS_LEDSet(0, 0);
        CTOS_LEDSet(2, 0);
    } else {
        PrintCenter(6, "Remove Card"); //Remove Card
        do {
            CTOS_SCStatus(d_SC_USER, &c);
        } while (c & d_MK_SC_PRESENT);
        CTOS_LEDSet(0, 0);
        CTOS_LEDSet(2, 0);
    }

    CTOS_LCDTClearDisplay();
    CTOS_LCDGShowBMPPic(0, 0, "background00.bmp");
}

/*
void write_online_key(void)
{
  USHORT usRet;
  CTOS_KMS2KEYWRITE_PARA stKeyWritePara;
  
  memset(&stKeyWritePara, 0x00, sizeof(CTOS_KMS2KEYWRITE_PARA));
  
  stKeyWritePara.Info.KeySet = d_ONLINE_KEYSET;
  //stKeyWritePara.Info.KeySet = 0x1001;
  stKeyWritePara.Info.KeyIndex = d_ONLINE_KEYINDEX;
  stKeyWritePara.Info.KeyVersion = 0x01;
  stKeyWritePara.Info.KeyType = KMS2_KEYTYPE_3DES;
  stKeyWritePara.Info.KeyAttribute = KMS2_KEYATTRIBUTE_PIN;
  
  stKeyWritePara.Protection.Mode = KMS2_KEYPROTECTIONMODE_PLAINTEXT;
  //stKeyWritePara.Protection.Mode = KMS2_KEYPROTECTIONMODE_KPK_ECB;
  //stKeyWritePara.Verification.KeyCheckValueLength = 4;
  //stKeyWritePara.Verification.pKeyCheckValue = check_value;
  
  stKeyWritePara.Value.KeyLength = 16;
  stKeyWritePara.Value.pKeyData = d_ONLINE_KEY;
      
  usRet = CTOS_KMS2KeyWrite(&stKeyWritePara);
  printf("write_online_key usRet = %x\n",usRet);
  
  stKeyWritePara.Info.KeyIndex = d_OFFLINE_KEYINDEX;
  stKeyWritePara.Info.KeyAttribute = KMS2_KEYATTRIBUTE_ENCRYPT+KMS2_KEYATTRIBUTE_DECRYPT;
  
  usRet = CTOS_KMS2KeyWrite(&stKeyWritePara);
}

void OnDisplayShow(IN char *pStrMsg)  //add '\n' break line
{
//printf("OnDisplayShow 1\n");
    //CTOS_LCDTPrintXY(1, 3, pStrMsg);
//printf("OnDisplayShow 2\n");
}

void OnErrorMsg(IN char *pStrMsg)
{
//printf("OnErrorMsg 1\n");
    CTOS_LCDTPrintXY(1, 6, pStrMsg);
//printf("OnErrorMsg 2\n");
}

// This function will be called during EMV_Initialize;
void OnEMVConfigActive(INOUT BYTE* pActiveIndex)
{
	
}

USHORT OnTxnDataGet(OUT EMV_TXNDATA *pTxnData)
{
//printf("OnTxnDataGet 1\n");
    pTxnData->Version = 1;
    pTxnData->ulAmount = g_ulAMT;
//printf("OnTxnDataGet 2\n");    
    return d_OK;
}

#define d_FONTSIZE 16

BYTE ShowAPList(BYTE start_y, BYTE max_y, BYTE *sHeaderString, BYTE iHeaderStrLen, BYTE apnum, char aplist[][17], BYTE *selitem)
{
	BYTE str[20], i, curr_top, curr_off, c;
	BYTE hx = 1, hy = 1;
	BYTE baHeader[17];

	CTOS_LCDTClearDisplay();

	//Show [AP List]
	if (iHeaderStrLen <= d_FONTSIZE) {
		//by Center
		hx = ((d_FONTSIZE - iHeaderStrLen) / 2) + 1;
		memset(baHeader, 0x20, sizeof (baHeader));
		memcpy(&baHeader[hx - 1], sHeaderString, iHeaderStrLen);
		CTOS_LCDTPrintXY(1, 1, baHeader);
	}
        
	curr_top = 0;
	curr_off = 0; //Offset from curr_top

	while (1) {
		for (i = start_y; i <= max_y; i++)
			CTOS_LCDTPrintXY(1, i, (BYTE*)"                ");

		for (i = 0; i < max_y - start_y + 1; i++) {
			if (curr_top + i >= apnum)
				break;

			if (i == curr_off)
				CTOS_LCDTSetReverse(TRUE);

			CTOS_LCDTPrintXY(1, start_y + i, (BYTE*)aplist[curr_top + i]);

			if (i == curr_off)
				CTOS_LCDTSetReverse(FALSE);
		}

		CTOS_KBDGet(&c);

		//UP for V7, F1 for V9
		if (c == d_KBD_UP || c == d_KBD_F1) {
			if (curr_off > 0) {
				curr_off--;
			}
			else if (curr_top > 0 && curr_off == 0) {
				curr_top--;
			}
		} else if (c == d_KBD_DOWN || c == d_KBD_F4) {
			if (curr_top + curr_off + 1 < apnum) {
				if (curr_off < max_y - start_y) {
					curr_off++;
				} else if (curr_top + curr_off < apnum) {
					curr_top++;
				}
			}
		} else if (c == d_KBD_ENTER) {
			*selitem = curr_top + curr_off;
			return 0;
		} else if (c == d_KBD_CANCEL) {
			return 1;
		} else if (c >= '1' && c <= '9') {
			*selitem = c - '0' - 1;
			return 0;
		}
	}
}

// Range of pAppSelectedIndex value is 0 to (AppNum-1)    
USHORT OnAppList(IN BYTE AppNum, IN char AppLabel[][d_LABEL_STR_SIZE+1], OUT BYTE *pAppSelectedIndex)
{
//printf("OnAppList 1\n");
  BYTE sHeaderString[17];
    
    
    memset(sHeaderString, 0x00, sizeof(sHeaderString));
    sprintf(sHeaderString, "APP List");
//printf("OnAppList 2\n");    
    if (ShowAPList(2, 6, sHeaderString, strlen(sHeaderString), AppNum, AppLabel, pAppSelectedIndex) != 0)
        return d_EMVAPLIB_ERR_ABORT_TX;
//printf("OnAppList 3\n");    
    return d_EMVAPLIB_OK;
    
}

// Return d_OK to indicate CONFIRMED        
USHORT OnAppSelectedConfirm(IN BOOL IsRequiredbyCard, IN BYTE *pLabel, IN BYTE bLabelLen)
{
  return d_OK;
}
    
BOOL OnTerminalDataGet(IN USHORT usTag, INOUT USHORT *pLen, OUT BYTE *pValue)
{
    
    return FALSE;
}
    
BOOL OnCAPKGet(IN BYTE *pRID, IN BYTE bKeyIndex, OUT BYTE *pModulus, OUT USHORT *pModulusLen, OUT BYTE *pExponent, OUT USHORT *pExponentLen)
{
    
    return FALSE;
}
    
// Return d_OK to indicate Online PIN block is ready for application
USHORT OnOnlinePINBlockGet(OUT ONLINE_PIN_DATA *pOnlinePINData)
{
	return 0;
}
   
static int iTestCancel(void)
{
	return 0;
}

// Return d_OK to indicate Offline PIN block is ready for Kernel
// If this function uses KMS_GetEncOfflinePIN function to get offline pin, return d_EMV_ENTER_KMS_OFFLINEPIN to indicate enciphed offline PIN is ready for Kernel    
USHORT OnOfflinePINBlockGet(void)
{
	return 0;
}

void OnPINVerifyResult(IN USHORT usResult)
{
printf("OnPINVerifyResult 1\n");
   BYTE data[32];
    
   isOfflinePIN = TRUE;
   memset(data, 0, sizeof(data));
    
   if (usResult == d_PIN_RESULT_OK) 
   {
       isPIN_OK = TRUE;
       //"PIN Verify OK"
       sprintf(data, "PIN Verify OK");
   }
   else if (usResult == d_PIN_RESULT_FAIL) 
   {
       isPIN_OK = FALSE;
       //"!PIN Wrong!"
       sprintf(data, "PIN Wrong");
   }
   else if (usResult == d_PIN_RESULT_BLOCKED || usResult == d_PIN_RESULT_FAILBLOCKED) 
   {
       isPIN_OK = FALSE;
       //"!PIN Blocked!"
       sprintf(data, "PIN Blocked");
   }
   
   CTOS_LCDTPrintXY(1, 4, data);
   CTOS_Delay(2000);
	printf("OnPINVerifyResult 2\n");
}

void OnTxnOnline(IN ONLINE_PIN_DATA *pOnlinePINData, OUT EMV_ONLINE_RESPONSE_DATA* pOnlineResponseData)
{
printf("OnTxnOnline 1\n");
    if(pOnlinePINData->bPINLen == 0 && !isInsertPIN)
    {
        isPIN_OK = TRUE;
        pOnlineResponseData->bAction = d_ONLINE_ACTION_APPROVAL;
//        ret = InsertPIN(pOnlinePINData);
    }
    else
    {
        if(isOfflinePIN)
        {
            if(isPIN_OK)
            {
                pOnlineResponseData->bAction = d_ONLINE_ACTION_APPROVAL;
            }
            else
            {
                pOnlineResponseData->bAction = d_ONLINE_ACTION_DECLINE;
            }
        }
        else if(memcmp(SelectedAID, "\xA0\x00\x00\x00\x03", 5) == 0)
        {
            if(memcmp(pOnlinePINData->pPIN, "\x47\x67\x9C\x25\xF8\x48\x73\xA2", 8) == 0) 
            {          
                isPIN_OK = TRUE;
                pOnlineResponseData->bAction = d_ONLINE_ACTION_APPROVAL;
            }
            else
            {                   
                isPIN_OK = FALSE;
                pOnlineResponseData->bAction = d_ONLINE_ACTION_DECLINE;
            }
        }
        else
        {
            if(memcmp(pOnlinePINData->pPIN, "\x5C\x73\xAF\xC9\x85\x28\xCF\xF2", 8) == 0) 
            {
                isPIN_OK = TRUE;
                pOnlineResponseData->bAction = d_ONLINE_ACTION_APPROVAL;                
            }
            else
            {
                isPIN_OK = FALSE;
                pOnlineResponseData->bAction = d_ONLINE_ACTION_DECLINE;                
            }
        }
    }
        
//    CTOS_Delay(1500);
  
//    pOnlineResponseData->bAction = d_ONLINE_ACTION_APPROVAL;
    
    memcpy(baAuthorizationCode, "00", 2);
    pOnlineResponseData->pAuthorizationCode = baAuthorizationCode;
    pOnlineResponseData->pIssuerAuthenticationData = baIssuerAuthenticationData;
    pOnlineResponseData->pIssuerScript = baIssuerScript;
printf("OnTxnOnline 2\n");
}

void OnTxnIssuerScriptResult(IN BYTE* pScriptResult, IN USHORT pScriptResultLen)
{
	
}

void OnTxnResult(IN BYTE bResult, IN BOOL IsSignatureRequired)
{

}

void OnTotalAmountGet(IN BYTE *pPAN, IN BYTE bPANLen, OUT ULONG *pAmount)
{
    *pAmount = 0;
}

void OnExceptionFileCheck(IN BYTE *pPAN, IN BYTE bPANLen, OUT BOOL *isException)
{
	
}

BOOL OnCAPKRevocationCheck(IN BYTE *pbRID, IN BYTE bCAPKIdx, BYTE *pbSerialNumuber)
{
    return FALSE;
}

void OnGetPINNotify(IN BYTE bPINType, IN USHORT bRemainingCounter, OUT BOOL* pIsUseDefaultGetPINFunc, OUT DEFAULT_GETPIN_FUNC_PARA *pPara)
{
printf("OnGetPINNotify 1\n");
  BYTE pan[32];
  
  *pIsUseDefaultGetPINFunc = FALSE;
  isInsertPIN = TRUE;
  
  memset(pPara, 0x00, sizeof(DEFAULT_GETPIN_FUNC_PARA));
  pPara->usLineLeft_X = 5;
  pPara->usLineRight_X = 20;
  pPara->bPINDigitMaxLength = 12;
  pPara->bPINDigitMinLength = 4;
  pPara->usLinePosition_Y = 6;
  pPara->ulTimeout = 300;
  
  if (bPINType == d_NOTIFY_OFFLINE_PIN)
  {
    pPara->IsReverseLine = TRUE;
    pPara->IsRightToLeft = TRUE;
  
    //CTOS_LCDTPrintXY(1, 5, "Enter Offline PIN:");
    CTOS_LCDTPrintXY(1, 3, "Enter Offline PIN:");
  }else
  {
    pPara->ONLINEPIN_PARA.CipherKeyIndex = d_ONLINE_KEYINDEX;
    pPara->ONLINEPIN_PARA.CipherKeySet = d_ONLINE_KEYSET;
    pPara->ONLINEPIN_PARA.bPANLen = 16;
    memset(pan, 0x30, sizeof(pan));
    memset(pPara->ONLINEPIN_PARA.baPAN, 0x30, 16);
            
    //CTOS_LCDTPrintXY(1, 5, "Enter Online PIN:");
    CTOS_LCDTPrintXY(1, 3, "Enter Online PIN:");
  }
printf("OnGetPINNotify 2\n");
}

void OnOutputCardAPDU(IN BYTE *pTxAPDU, IN USHORT TxAPUDLen, IN BYTE *pRxAPDU, IN USHORT RxAPDULen)
{
  BYTE buff[1024];
  
  memset(buff, 0, sizeof(buff));
  CTOS_PrinterPutString("TxAPDU");
  wub_hex_2_str(pTxAPDU, buff, TxAPUDLen);
  CTOS_PrinterPutString(buff);
  
  memset(buff, 0, sizeof(buff));
  CTOS_PrinterPutString("RxAPDU");
  wub_hex_2_str(pRxAPDU, buff, RxAPDULen);
  CTOS_PrinterPutString(buff);
  
}

EMV_EVENT g_emv_event = 
{
    1,
	OnDisplayShow,
    OnErrorMsg, 
    OnEMVConfigActive, 
    NULL,
	OnTxnDataGet, 
    OnAppList,
    OnAppSelectedConfirm,
    OnTerminalDataGet,
    OnCAPKGet,
    OnGetPINNotify,
    OnOnlinePINBlockGet,
    OnOfflinePINBlockGet,
    OnPINVerifyResult,
    OnTxnOnline,
    OnTxnIssuerScriptResult,
    OnTxnResult,
    OnTotalAmountGet,
    OnExceptionFileCheck,
    OnCAPKRevocationCheck,
};
*/

static void prt_sample2(BYTE *iCounter, BYTE ContactType) {// 1:ICC 2:MSR
    BYTE	baTemp[384 * 64]; // The width of paper is 384 dot.
	BYTE	prtBuf[128];//Buffer for PrintOut
	USHORT	usRtn;//Function Return
	
	//CTOS_LCDTClearDisplay();
	//CTOS_LCDGShowBMPPic(0, 0, "Welcome.bmp");
	//CTOS_LCDTPrintXY(1, 6, "Printing...          ");
	CTOS_PrinterFontSelectMode(d_FONT_FNT_MODE);
	
    //Font atrributes
    CTOS_FONT_ATTRIB stFONT_ATTRIB;

    //Auxiliar char buffer
    UCHAR charBuffer[50];

    // Auxiliar PAN number
    UCHAR applicationAIDAux[40];

    // Auxiliar PAN number
    UCHAR PANNumberAux[40];

    // Lenght of PAN number
    BYTE lenghtPANNumber;

    BYTE Timer_printSTR[40] = {0};

    CTOS_PrinterFline(5);

    //Print out the bank logo
    usRtn = CTOS_PrinterLogo((BYTE *) baPrinterBufferLogo_Receipt2, 0, 380, 10);
    CTOS_PrinterFline(12);
	
	if(usRtn != d_OK){
		CTOS_LCDTClearDisplay();
		//CTOS_LCDGShowBMPPic(0, 0, "Welcome.bmp");
		CTOS_LCDTPrintXY(1, 4, "   Printer Error!   ");
		CTOS_LCDTPrintXY(1, 5, " Please Check Paper ");
		return;
	}

    stFONT_ATTRIB.X_Space = 0;
    //The height of the space between the font with next font
    stFONT_ATTRIB.Y_Space = 0;
    memset(baTemp, 0x00, sizeof (baTemp));
    stFONT_ATTRIB.FontSize = d_FONT_8x16;
    //Double de X size
    stFONT_ATTRIB.X_Zoom = 3;
    //Double de Y size
    stFONT_ATTRIB.Y_Zoom = 4;
    //The width of the space between the font with next font
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, (BYTE *) "VEGA3000", &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 6);
    CTOS_PrinterFline(20);

    //==============================
    //Print out the transaction data
    //==============================
    CTOS_PrinterPutString((BYTE *) "MER ID: 886289131771");
    CTOS_PrinterFline(5);
    strcpy((char *) applicationAIDAux, "BATCH NO: 000307");
    CTOS_PrinterPutString(applicationAIDAux);
    CTOS_PrinterFline(5);


    memset(baTemp, 0x00, sizeof (baTemp));

    stFONT_ATTRIB.FontSize = d_FONT_8x16;
    stFONT_ATTRIB.X_Zoom = 2;
    stFONT_ATTRIB.Y_Zoom = 2;

    CTOS_PrinterPutString((unsigned char *) "CARD NO:");
    CTOS_PrinterFline(12);

	memset(prtBuf, 0x00, sizeof(prtBuf));
	sprintf(prtBuf, "  %c%c%c%c **** **** %c%c%c%c", CardSNbuf[0], CardSNbuf[1], CardSNbuf[2], CardSNbuf[3], CardSNbuf[12], CardSNbuf[13], CardSNbuf[14], CardSNbuf[15]);
	
    lenghtPANNumber = strlen("  ********************");
    strcpy((char *) PANNumberAux, prtBuf);
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, PANNumberAux, &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 8);
	
	/*
	memset(prtBuf, 0x00, sizeof(prtBuf));
	sprintf(prtBuf, "Test(10-19) : %c%c%c%c%c%c%c%c%c%c", CardExpDatebuf2[10], CardExpDatebuf2[11], CardExpDatebuf2[12], CardExpDatebuf2[13], CardExpDatebuf2[14], CardExpDatebuf2[15], CardExpDatebuf2[16], CardExpDatebuf2[17], CardExpDatebuf2[18], CardExpDatebuf2[19]);
	CTOS_PrinterPutString((char *) prtBuf);
    CTOS_PrinterFline(5);
	*/
	
	if(ContactType == 1){	//ICC
		memset(prtBuf, 0x00, sizeof(prtBuf));
		sprintf(prtBuf, "EXP. DATE: 20%c%c/%c%c", CardExpDatebuf1[0], CardExpDatebuf1[1], CardExpDatebuf1[2], CardExpDatebuf1[3]);
		CTOS_PrinterPutString((char *)prtBuf);
		CTOS_PrinterFline(5);
	}else if(ContactType == 2){	//MSR
		memset(prtBuf, 0x00, sizeof(prtBuf));
		sprintf(prtBuf, "EXP. DATE: 20%c%c/%c%c", CardExpDatebuf2[0], CardExpDatebuf2[1], CardExpDatebuf2[2], CardExpDatebuf2[3]);
		CTOS_PrinterPutString((char *)prtBuf);
		CTOS_PrinterFline(5);
	}else{
		CTOS_PrinterPutString((BYTE *) "EXP. DATE: 2016/08");
		CTOS_PrinterFline(5);
	}
	 
    CTOS_PrinterPutString((BYTE *) "ISSUER: 84188062");
    CTOS_PrinterFline(15);

    memset(baTemp, 0x00, sizeof (baTemp));
    stFONT_ATTRIB.FontSize = d_FONT_8x16;
    stFONT_ATTRIB.X_Zoom = 3;
    stFONT_ATTRIB.Y_Zoom = 2;
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, (BYTE *) "       BOOK/SALE", &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 6);
    CTOS_PrinterFline(12);

    CTOS_PrinterPutString((BYTE *) "TERM ID: 11010001   OPER ID: 002");
    CTOS_PrinterFline(5);
    CTOS_RTCGet(&stRTC);
    sprintf((char *) Timer_printSTR, "DATE:%02d/%02d/20%02d    TIME:%02d:%02d", stRTC.bDay, stRTC.bMonth, stRTC.bYear, stRTC.bHour, stRTC.bMinute);
    CTOS_PrinterPutString((BYTE *) Timer_printSTR);
    //CTOS_PrinterPutString((BYTE *)"DATE: 31/10/2012    TIME: 14:52");
    CTOS_PrinterFline(5);
    CTOS_PrinterPutString((BYTE *) "REF NO: 855090913452");
    CTOS_PrinterFline(15);

    //sprintf((char *) charBuffer, "      $ %s", iCounter);
	int i, j, k;
	ULONG ulAmt;
	
	CTOS_PrinterFontSelectMode(d_FONT_TTF_MODE);
	CTOS_PrinterTTFSelect("arial.ttf", 0);
	
	k = strlen(iCounter);
	ulAmt = ASCII2Int(iCounter, k);
	
	i = (int)ulAmt / 100;
	j = (int)ulAmt % 100;
	if(i == 0){
		if(Dollar_Sign == 1)
			sprintf((char *) charBuffer, "      $ 0.%02d", j);
		else if(Dollar_Sign == 2)
			sprintf((char *) charBuffer, "       0.%02d", j);
	}
	else{
		if(Dollar_Sign == 1)
			sprintf((char *) charBuffer, "      $ %d.%02d", i, j);
		else if(Dollar_Sign == 2)
			sprintf((char *) charBuffer, "       %d.%02d", i, j);
	}
		
    stFONT_ATTRIB.FontSize = d_FONT_12x24;
    stFONT_ATTRIB.X_Zoom = 3;
    stFONT_ATTRIB.Y_Zoom = 2;
    memset(baTemp, 0x00, sizeof (baTemp));
    CTOS_PrinterBufferPutString((BYTE *) baTemp, 0, 0, (BYTE *) charBuffer, &stFONT_ATTRIB);
    CTOS_PrinterBufferOutput((BYTE *) baTemp, 6);

	if(ContactType == 2){
		//CTOS_PrinterLogo((BYTE *)SignatureCanvas, 0, 320, 60);
		CTOS_PrinterBMPPic(0, MonoSignBMPFile);
	}else
		CTOS_PrinterFline(40);
    usRtn = CTOS_PrinterPutString((BYTE *) "===== CARDHOLDER SIGNATURE =====");
    CTOS_PrinterFline(40);

	if(usRtn != d_OK){
		CTOS_LCDTClearDisplay();
		CTOS_LCDGShowBMPPic(0, 0, "Welcome.bmp");
		CTOS_LCDTPrintXY(1, 4, "   Printer Error!   ");
		CTOS_LCDTPrintXY(1, 5, " Please Check Paper ");
		return;
	}
	
    CTOS_PrinterPutString((BYTE *) "\n\n");
}

USHORT IccTXNProcess(void)
{
    BYTE SelectedAIDLen, label_len, label[32];
    USHORT len;
    BYTE value[128], buff[128]={0}, msg[256];
    USHORT ret;
    memset(msg, 0x00, 256);
	
    //CTOS_LCDGShowBMPPic(0, 0, "background00.bmp"); 
    ret = EMV_TxnAppSelect(SelectedAID, &SelectedAIDLen, label, &label_len);
	
    sprintf(buff, "select ret %04X ", ret);
//    CTOS_LCDTPrintXY(1, 7, buff);
    if (ret == d_OK)
    {        
        len = sizeof(value);
        EMV_DataGet(d_TAG_PAN, &len, value);
        memset(buff, 0, sizeof(buff));
        len = wub_hex_2_str(value, buff, len);
		memcpy(CardSNbuf, buff, sizeof(buff));
		
		EMV_DataGet(0x5F24, &len, value);//0x0057
        memset(buff, 0, sizeof(buff));
        len = wub_hex_2_str(value, buff, len);
		memcpy(CardExpDatebuf1, buff, sizeof(buff));
		
        ret = EMV_TxnPerform(); //ICC with some problem, mark temporary
		
		CTOS_LCDGShowBMPPic(0, 0, "Processing.bmp");
		EMVCL_ShowVirtualLED(NULL);
		EMVCL_SetLED(0x0F, 0x08);
		//CTOS_LCDTPrintXY(1, 3, "Connecting...        ");
		CTOS_Delay(1000);
		
		return d_OK;
    }
    else
    {
        CTOS_LCDTClearDisplay();
		CTOS_LCDGShowBMPPic(0, 0, "Welcome.bmp");
		EMVCL_ShowVirtualLED(NULL);
		EMVCL_SetLED(0x0F, 0x08);
        
        memset(buff, 0x00 ,sizeof(buff));
        wub_memcpy(buff, "\x2C\x02", 2);
        sprintf(&buff[2], "Card Error %04X ", ret);
        //CTOS_LCDTPrintXY(1, 3, &buff[2]);
        
		return d_NO;
    }

}

USHORT MSRTXNProcess(BYTE *baTK1, USHORT TK1Len, BYTE *baTK2, USHORT TK2Len, BYTE *baTK3, USHORT TK3Len)
{
    BYTE baPAN[32];
    int i = 1;
    memset(baPAN, 0x00, 32);
	
	//Avoiding non-CreditCards
	//if(TK3Len > 0)
	//	return d_NO;
	
	BYTE CardExpFlag = 0;
	int j = 0;
	while(1){
		if(CardExpFlag){
			CardExpDatebuf2[0] = baTK2[j];
			CardExpDatebuf2[1] = baTK2[j+1];
			CardExpDatebuf2[2] = baTK2[j+2];
			CardExpDatebuf2[3] = baTK2[j+3];

			CardExpFlag = 0;
			break;
		}
		if(j > TK2Len)
			break;
	
		if(baTK2[j] == '=')
			CardExpFlag++;
	
		j++;
	}
	
    if(baTK2[0] == ';')
    {
        while(baTK2[i] != '=' || i > TK2Len)
        {
            baPAN[i - 1] = baTK2[i];
            i++;
        } 
		memcpy(CardSNbuf, baPAN, sizeof(baPAN));

		CTOS_LCDGShowBMPPic(0, 0, "Processing.bmp");
		EMVCL_ShowVirtualLED(NULL);
		EMVCL_SetLED(0x0F, 0x08);
		/*
		CTOS_LCDGShowBMPPic(0, 0, "background00.bmp");
		
		PrintCenter(4, "Processing...");
		CTOS_Delay(1000);

		PrintCenter(4, "Connecting...");
		CTOS_Delay(1000);
		*/
		
		return d_OK;
    }
	return d_NO;
}

USHORT InputPIN(void){
	BYTE	ICCKey;
	BYTE	ICCPIN[13];
	BYTE	ICCStar[13];
	USHORT	ICCPINLen;
	USHORT	ICCStarLen;
	
	CTOS_LCDGShowBMPPic(0, 0, "EnterPIN.bmp");
	EMVCL_ShowVirtualLED(NULL);
	EMVCL_SetLED(0x0F, 0x08);
	
	memset(ICCPIN, 0x00, sizeof(ICCPIN));
	memset(ICCStar, 0x00, sizeof(ICCStar));
	ICCStarLen = ICCPINLen = 0;
	ICCKey = 0;
	while(1){

		CTOS_KBDGet(&ICCKey);
		
		switch(ICCKey){
			case d_KBD_ENTER:
				if((ICCPINLen < 4) || (ICCPINLen > 12)){
					CTOS_Delay(100);
					CTOS_Beep();
					CTOS_Delay(100);
					CTOS_Beep();
				}else{
					if(strcmp(ICCPIN, "8418") == 0){
						return d_OK;
					}else{
						CTOS_LCDTPrintXY(1, 9, "     Wrong PIN!    ");
						CTOS_Delay(100);
						CTOS_Beep();
						CTOS_Delay(100);
						CTOS_Beep();
						CTOS_Delay(500);
						CTOS_LCDTPrintXY(1, 8, "                   ");
						CTOS_LCDTPrintXY(1, 9, "                   ");
						memset(ICCPIN, 0x00, sizeof(ICCPIN));
						memset(ICCStar, 0x00, sizeof(ICCStar));
						ICCPINLen = 0;
						ICCStarLen = 0;
						
						continue;
					}
				}
				break;
				
			case d_KBD_CANCEL:
				return d_NO;
				break;
				
			case d_KBD_CLEAR:
				if (ICCPINLen == 0) {
					CTOS_Delay(100);
					CTOS_Beep();
					CTOS_Delay(100);
					CTOS_Beep();
				}else{
					ICCPIN[--ICCPINLen] = 0x00;
					ICCStar[ICCPINLen] = 0x00;
					//ICCStar[--ICCStarLen] = 0x00;
					CTOS_LCDTPrintXY(1, 8, "                    ");
					//CTOS_LCDTPrintXY(1, 9, "                    ");
					
					//CTOS_LCDTPrintXY((13 - ICCPINLen), 8, ICCStar);
					//CTOS_LCDTPrintXY((13 - ICCPINLen), 9, ICCPIN);
					
					if((ICCPINLen % 2) == 1)
						CTOS_LCDTPrintXY((11 - (ICCPINLen/2)), 8, ICCStar);
					else if((ICCPINLen % 2) == 0)
						CTOS_LCDTPrintXY((11 - (ICCPINLen/2)), 8, ICCStar);
				}
				break;
			
			default:
				if((ICCKey >= '0' && ICCKey <= '9') && ICCPINLen < 12){
					ICCStar[ICCPINLen] = '*';//
					ICCPIN[ICCPINLen++] = ICCKey;
					//ICCStar[ICCStarLen++] = '*';
					CTOS_LCDTPrintXY(1, 8, "                    ");
					//CTOS_LCDTPrintXY(1, 9, "                    ");
					
					//CTOS_LCDTPrintXY((13 - ICCPINLen), 8, ICCStar);
					//CTOS_LCDTPrintXY((13 - ICCPINLen), 9, ICCPIN);
					
					if((ICCPINLen % 2) == 1)
						CTOS_LCDTPrintXY((10 - (ICCPINLen/2)), 8, ICCStar);
					else if((ICCPINLen % 2) == 0)
						CTOS_LCDTPrintXY((11 - (ICCPINLen/2)), 8, ICCStar);
				}else if(ICCPINLen > 12){
					CTOS_Delay(100);
					CTOS_Beep();
				}
				break;
		}
	}
}

void TouchOpen(void){
    BYTE key;
    iX = 0, iY = 0;
    temp_iX = 0, temp_iY = 0;
    
    fd = open("/dev/input/event0", O_RDONLY | O_NONBLOCK ); //To open the touch panel's event and set non-block
    if(fd < 0){
        CTOS_LCDTPrintXY(1, 10, "TouchPanel Open Fail");
        CTOS_KBDGet(&key);
        return;
    }

    if(ioctl(fd, EVIOCGNAME(sizeof(str)), str) < 0) //To get the name of this input event
    {
        CTOS_LCDTPrintXY(1, 10, "   ioctl Open Fail  ");
        CTOS_KBDGet(&key);
        return;
    }
}

void Signature(void){
    BYTE    key;
    ULONG   rb;
    struct  input_event ev[5];
    BYTE    count = 0;
    int     TouchTimerFlag = 0;   
    int     i;
	ULONG	startT, endT;

Start_Touch:  
    memset(SignatureCanvas, 0x00, sizeof(SignatureCanvas));
	iX = 0, iY = 0;
    temp_iX = 0, temp_iY = 0;
    //SignatureCanvas[320 * (480/8)] = {0};
    
    CTOS_LCDGShowBMPPic(0, 0, "WaitforSign.bmp");
	EMVCL_ShowVirtualLED(NULL);
	EMVCL_SetLED(0x0F, 0x08);
    //TouchOpen();
	/*
    CTOS_LCDGSetBox(59,     //x_start
            79,             //y_start
            202,            //x_width
            322,            //y_width
            1);             //solid_box

    CTOS_LCDGSetBox(60,     //x_start
            80,             //y_start
            200,            //x_width
            320,            //y_width
            0);             //hollow_box
			*/
    
    while(1){
        CTOS_KBDHit(&key);
        if(key == d_KBD_CANCEL){
            goto Cnl_Touch;
        }else if(key == d_KBD_CLEAR){
            goto Start_Touch;
        }else if(key == d_KBD_ENTER){
            goto EXIT;
        }

        //if(TouchTimerFlag == 1){
         //   if(CTOS_TimeOutCheck(TIMER_ID_1) == d_YES){
         //       goto EXIT;
        //    }
        //}

		//if(TouchTimerFlag == 1){
		//	endT = CTOS_TickGet();
        //    if((endT - startT) > 1000){
        //        goto EXIT;
        //    }
        //}

        rb = read(fd, ev, sizeof(struct input_event) * 5);
        if (rb == -1)
            continue;

        if ( rb < sizeof(struct input_event) )
        {
            CTOS_LCDTPrintXY(1, 8, "  Read Input Fail!  ");
            close(fd);
            return;
        }

        if(TouchTimerFlag == 0){
            //CTOS_TimeOutSet(TIMER_ID_1, 1500);
			//startT = CTOS_TickGet();
            TouchTimerFlag = 1;
            //CTOS_LCDTPrintXY(1, 16, "    Timer Start!    ");
        }

        for (count = 0; count < rb/sizeof(struct input_event); count++){    
            if(EV_KEY == ev[count].type){
                if (ev[count].value == 1 ){
                    ;
                }
                else{
                        iX = iY = 0;
                }
            }
            if(EV_ABS == ev[count].type) //absolute values to the touch panel
            {
                if(ev[count].code == 0) // code 0 is equal to X-axis's coordinate
                {
                    temp_iX = ev[count].value;
                }
                else if(ev[count].code == 1) //code 1 is equal to Y-axis's coordinate
                {
                    temp_iY = ev[count].value;
                }
            }
            if(EV_SYN == ev[count].type){
                iX = temp_iX;
                iY = temp_iY;
                break;
            }

        }


        if ((iX != 0 ) && (iY != 0 )){
            if((iX > 0) && (iX < 320) && (iY > 150) && (iY < 330)){
                //---- draw touch point.
                CTOS_LCDGSetBox(iX,iY,5,5,1);
                for(i=(iX-2); i<=(iX+2); i++){
                    //SignatureCanvas[i + ((iY/8) * 320)] = 0xFF;
                    //SignatureCanvas[i + ((iY/8) * 320)] += 0x01 << (iY%8);
                    if((iY%8) == 0){
                        SignatureCanvas[i + ((iY/8) * 320)] = SignatureCanvas[i + ((iY/8) * 320)] | (0x01 << (iY%8)) | (0x01 << ((iY+1)%8)) | (0x01 << ((iY+2)%8));
                        //SignatureCanvas[i + ((iY/8) * 320)] =
                        continue;
                    }
                    if((iY%8) == 1){
                        SignatureCanvas[i + ((iY/8) * 320)] = SignatureCanvas[i + ((iY/8) * 320)] | (0x01 << (iY%8)) | (0x01 << ((iY+1)%8)) | (0x01 << ((iY-1)%8)) | (0x01 << ((iY+2)%8));
                        //SignatureCanvas[i + ((iY/8) * 320)] =
                        continue;
                    }
                    if((iY%8) == 6){
                        SignatureCanvas[i + ((iY/8) * 320)] = SignatureCanvas[i + ((iY/8) * 320)] | (0x01 << (iY%8)) | (0x01 << ((iY-1)%8)) | (0x01 << ((iY+1)%8)) | (0x01 << ((iY-2)%8));
                        continue;
                    }
                    if((iY%8) == 7){
                        SignatureCanvas[i + ((iY/8) * 320)] = SignatureCanvas[i + ((iY/8) * 320)] | (0x01 << (iY%8)) | (0x01 << ((iY-1)%8)) | (0x01 << ((iY-2)%8));
                        continue;
                    }
                    SignatureCanvas[i + ((iY/8) * 320)] = SignatureCanvas[i + ((iY/8) * 320)] | (0x01 << (iY%8)) | (0x01 << ((iY-1)%8)) | (0x01 << ((iY+1)%8)) | (0x01 << ((iY-2)%8)) | (0x01 << ((iY+2)%8));
                }  
            }          
        }

        //if(CTOS_TimeOutCheck(TIMER_ID_1) == d_YES){
        //    goto EXIT;
        //}

		//if(TouchTimerFlag == 1){
		//	endT = CTOS_TickGet();
        //    if((endT - startT) > 1000){
        //        goto EXIT;
        //    }
        //}
    }
	
    
Cnl_Touch:		
    //close(fd);
    return;
        
EXIT:    
    //close(fd);
    return;
}

BOOL TouchSignature(void){
	BYTE key;
	
Start_Sign:
	CTOS_LCDGShowBMPPic(0, 0, "WaitforSign.bmp");
	EMVCL_ShowVirtualLED(NULL);
	EMVCL_SetLED(0x0F, 0x08);
	
	CTOS_LCDGSetBox(0,148,320,184,1);
	CTOS_TouchSignatureStart(1, 150, 318, 180, SignBMPFile, 0);
	
Continue_Sign:	
	CTOS_KBDGet(&key);
	if(key == d_KBD_CANCEL){
		return 0;
	}else if(key == d_KBD_CLEAR){
		CTOS_TouchSignatureTerminate();
		unlink(SignBMPFile);
		goto Start_Sign;
	}else if(key == d_KBD_ENTER){
		CTOS_TouchSignatureTerminate();
        CTOS_BMPConverter(SignBMPFile, MonoSignBMPFile, d_BMP_CONVERT_ONE_BIT_COLOR);
		
		return 1;
	}else{
		goto Continue_Sign;
	}
}

USHORT Tx_EMV(void){
	BYTE	SC_Status;
	BYTE	ICCTrade_Finishflag = 0;
	BYTE	MSRTrade_Finishflag = 0;
	USHORT 	usTk1Len, usTk2Len, usTk3Len;
	BYTE 	baTk1Buf[d_BUFF_SIZE], baTk2Buf[d_BUFF_SIZE], baTk3Buf[d_BUFF_SIZE];
	USHORT 	rtn;
	BYTE	buff[32];
	BYTE	ICCKey;
	BYTE	ICCPIN[8];
	BYTE	ICCStar[8];
	USHORT	ICCPINLen;
	USHORT	ICCStarLen;
	
	memset(ICCPIN, 0x00, sizeof(ICCPIN));
	memset(ICCStar, 0x00, sizeof(ICCStar));
	ICCStarLen = ICCPINLen = 0;
	//CTOS_LCDGShowBMPPic(0, 0, "background00.bmp");
	//ICC-----------------------------------------
	CTOS_SCStatus(d_SC_USER, &SC_Status);
	if(SC_Status & d_MK_SC_PRESENT)
	{
		EMVCL_CancelTransaction();
		//CTOS_LCDTClearDisplay();
		rtn = IccTXNProcess();
		
		if(rtn == d_OK)
			ICCTrade_Finishflag = 1;
		if(ICCTrade_Finishflag)
		{
			ICCTrade_Finishflag = 0;
			
			//enter pin code
			if(InputPIN() == d_NO){
				return d_PIN_FAIL;
			}
			
			//print
			CTOS_LCDGShowBMPPic(0, 0, "Printing.bmp");
			EMVCL_ShowVirtualLED(NULL);
			EMVCL_SetLED(0x0F, 0x08);
			prt_sample2(g_baInputAmt, 1);
			
			do{	
				CTOS_SCStatus(d_SC_USER, &SC_Status);
			}while(SC_Status & d_MK_SC_PRESENT);
				
			return d_OK;
		}
	}
	
	//MSR-----------------------------------------
	usTk1Len = usTk2Len = usTk3Len = d_BUFF_SIZE;
	rtn = CTOS_MSRRead(baTk1Buf, &usTk1Len, baTk2Buf, &usTk2Len, baTk3Buf, &usTk3Len);
	if(rtn != d_OK ||  usTk2Len == 0){
		/*
		CTOS_LCDTClearDisplay();
		sprintf(buff, "Card Error %04X ", rtn);
		CTOS_LCDTPrintXY(1, 4, buff);
		CTOS_LCDTPrintXY(1, 3, "      Error        ");
		*/
	}
	else{
		EMVCL_CancelTransaction();
		//CTOS_LCDTClearDisplay();
		rtn = MSRTXNProcess(baTk1Buf, usTk1Len, baTk2Buf, usTk2Len, baTk3Buf, usTk3Len);
		if(rtn == d_OK)
			MSRTrade_Finishflag = 1;
		if(MSRTrade_Finishflag)
		{
			MSRTrade_Finishflag = 0;
			
			//get signature
			if(!TouchSignature())
				return d_SIGN_FAIL;
			//TouchSignature();
			//close(fd);
			
			//print
			CTOS_LCDGShowBMPPic(0, 0, "Printing.bmp");
			EMVCL_ShowVirtualLED(NULL);
			EMVCL_SetLED(0x0F, 0x08);
			prt_sample2(g_baInputAmt, 2);
			return d_OK;
		}else{
			CTOS_LCDGShowBMPPic(0, 0, "SwipeInsertTap.bmp");
			EMVCL_ShowVirtualLED(NULL);
			EMVCL_SetLED(0x0F, 0x08);
		}	
	}
	return d_NO;
}

USHORT EMVPolling(void) {
    BYTE c[2], baATR[128], bATRLen, CardType;
    BYTE i = 0;
    USHORT rtn;
    BYTE LCDbuff[32];
	
	/*
	CTOS_KMS2Init();
	rtn = EMV_Initialize(&g_emv_event, d_EMV_CONFIG_FILE); 
    if(rtn != d_OK)
    {
        sprintf(LCDbuff, "initial ret %04X ", rtn);
        CTOS_LCDTPrintXY(1, 6, LCDbuff);     
		return d_NO;		
    }
	CTOS_KMS2Erase();
    write_online_key();
    srand(time(NULL));
	*/

	rtn = Tx_EMV();
	//CTOS_LCDGShowBMPPic(0, 0, "background00.bmp");
	if(rtn == d_OK)
		return d_OK;
	return rtn;

}

void Welcome(void) {
    CTOS_LCDTClearDisplay();
    CTOS_LCDGShowBMPPic(0, 0, "background00.bmp");
    //CTOS_LCDTPrintXY(1, 1, "\fr      Welcome!      \fn");
    // CTOS_LCDGShowPic(0,0,baWelcome,sizeof(baWelcome),320);
    //    CTOS_LCDGShowPicEx(d_LCD_SHOWPIC_RGB, (320-142)/2 , 90, baPrinterLogo2, sizeof(baPrinterLogo2), 142);
    CTOS_LCDTSelectFontSize(0x101E);
    PrintCenter(3, "Please Insert or");
    PrintCenter(4, "Swipe card..    ");
    CTOS_LCDTPrintXY(1, 6, "\frX\fn:Exit");
}

void show_screen_saver(void) {
    static int i = 0;
    static BYTE pic_number = 0;

    i++;
    if (i >= Show_screen_saver_timer) {

        switch (pic_number) {
            case 0:
                //CTOS_LCDGShowPicEx(d_LCD_SHOWPIC_RGB, 0 , 0, QPROX_3F, sizeof(QPROX_3F), 320);
                pic_number = 1;
                break;
            case 1:
                //CTOS_LCDGShowPicEx(d_LCD_SHOWPIC_RGB, 0 , 0, EZ710BU_2F, sizeof(EZ710BU_2F), 320);
                pic_number = 0;
                break;
            case 2:
                pic_number = 3;
                break;
            case 3:
                pic_number = 4;
                break;
            case 4:
                pic_number = 5;
                break;
            case 5:
                pic_number = 0;
                break;
            default:
                pic_number = 0;
        }
        i = 0;
    }
}

void Screen_saver(void) {
    BYTE key;
    static int i = 0;
    i++;
    if (i >= Screen_saver_timer) {
        do {
            show_screen_saver();
            CTOS_Delay(Scan_key_timer);
            CTOS_KBDHit(&key);
        } while (key == d_KBD_INVALID);
        i = 0;
        Welcome();
    }

}
